<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>SecretBites</title>
    <style>
        html, body { height: 100%; margin: 0; padding: 0; }
        #map { width: 100vw; height: 100vh; }
        .search-bar {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            background: #fff;
            padding: 10px 20px;
            border-radius: 8px;
            box-shadow: 0 2px 6px 0 rgba(27, 142, 236, 0.2);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .search-bar input {
            font-size: 16px;
            padding: 6px 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            outline: none;
        }
        .search-bar button {
            font-size: 16px;
            padding: 6px 16px;
            background: #1b8eec;
            color: #fff;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .search-bar button:hover {
            background: #156bbd;
        }
        
        .info-panel {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 400px;
            height: 680px;
            min-width: 220px;
            min-height: 48px;
            max-width: 90vw;
            max-height: 90vh;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            margin-top: 60px; /* ‰∏∫Áî®Êà∑Áä∂ÊÄÅÊ†èÁïôÂá∫Á©∫Èó¥ */
        }
        
        .info-panel.collapsed {
            width: 48px !important;
            min-width: 48px !important;
            max-width: 48px !important;
            height: 48px !important;
            min-height: 48px !important;
            max-height: 48px !important;
            background: #1b8eec !important;
        }
        .info-panel.collapsed .info-panel-header {
            background: #1b8eec !important;
            padding: 0;
            justify-content: flex-end;
            width: 48px;
        }
        .info-panel.collapsed .info-panel-toggle-btn {
            width: 48px;
            height: 48px;
            justify-content: center;
            z-index: 1001;
        }
        .info-panel.collapsed .info-panel-header span {
            display: none;
        }
        .info-panel.collapsed .info-panel-content {
            display: none !important;
        }
        
        .info-panel-header {
            width: 100%;
            box-sizing: border-box;
            height: 48px;
            line-height: 48px;
            font-size: 16px;
            font-weight: bold;
            border-radius: 8px 8px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            padding: 0 16px;
            background: #1b8eec;
            color: #fff;
            /* transition: opacity 0.2s; */
            position: relative;
        }
        
        .info-panel-header:hover {
            background: #156bbd;
        }
        
        .info-panel-toggle-btn {
            position: absolute;
            top: 0;
            right: 0;
            background: none;
            border: none;
            color: #fff;
            font-size: 22px;
            cursor: pointer;
            padding: 0;
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.3s;
        }
        .info-panel.collapsed .info-panel-toggle-btn {
            transform: rotate(180deg);
        }
        
        .info-panel-handle {
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 40px;
            height: 60px;
            background: #1b8eec;
            border-radius: 8px 0 0 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-size: 16px;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .info-panel.collapsed .info-panel-handle {
            opacity: 1;
        }
        
        .info-panel-handle:hover {
            background: #156bbd;
        }
        
        .info-panel-content {
            padding: 16px;
            overflow-y: auto;
            flex: 1;
            opacity: 1;
            pointer-events: auto;
            display: flex;
            flex-direction: column;
            /* transition: opacity 0.3s; */
        }
        .info-panel.collapsed .info-panel-content {
            opacity: 0;
            pointer-events: none;
        }
        .info-panel-resizer {
            height: 8px;
            cursor: ns-resize;
            background: #f0f0f0;
            width: 100%;
            position: absolute;
            left: 0;
            bottom: 0;
            z-index: 10;
        }
        .info-panel-corner-resizer {
            width: 16px;
            height: 16px;
            position: absolute;
            right: 0;
            bottom: 0;
            cursor: nwse-resize;
            z-index: 11;
            background: transparent;
        }
        .info-panel-corner-resizer:after {
            display: none;
            content: '';
        }
        .info-panel-corner-resizer-left {
            width: 16px;
            height: 16px;
            position: absolute;
            left: 0;
            bottom: 0;
            cursor: nesw-resize;
            z-index: 11;
            background: transparent;
        }
        .info-panel-corner-resizer-left:after {
            display: none;
            content: '';
        }
        
        .info-panel-section {
            margin-bottom: 16px;
        }
        
        .info-panel-section.flex-grow {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .info-panel-section h3 {
            margin: 0 0 8px 0;
            font-size: 14px;
            color: #333;
            font-weight: bold;
        }
        
        .info-panel-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .info-panel-item:last-child {
            border-bottom: none;
        }
        
        .info-panel-label {
            color: #666;
            font-size: 13px;
        }
        
        .info-panel-value {
            color: #333;
            font-size: 13px;
            font-weight: 500;
            text-align: right;
            max-width: 60%;
        }
        
        .info-panel-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            margin-top: 4px;
        }
        
        .info-panel-tag {
            background: #f7c948;
            color: #333;
            border-radius: 12px;
            padding: 2px 8px;
            font-size: 11px;
        }
        
        .info-panel-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }
        
        .info-panel-stat {
            background: #f8f9fa;
            padding: 8px;
            border-radius: 4px;
            text-align: center;
        }
        
        .info-panel-stat-value {
            font-size: 18px;
            font-weight: bold;
            color: #1b8eec;
        }
        
        .info-panel-stat-label {
            font-size: 11px;
            color: #666;
            margin-top: 2px;
        }
        
        .info-panel-btn {
            background: #1b8eec;
            color: #fff;
            border: none;
            border-radius: 4px;
            padding: 6px 12px;
            font-size: 12px;
            cursor: pointer;
            display: inline-block;
            text-align: center;
            min-width: 60px;
            transition: background-color 0.2s ease;
        }
        
        .info-panel-btn:hover {
            background: #156bbd;
        }
        
        .info-panel-btn.rate-btn:hover {
            opacity: 0.8;
        }
        
        .filter-checkbox-container {
            display: inline-block;
            margin-right: 8px;
            margin-bottom: 4px;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            transition: background-color 0.2s ease;
        }
        
        .filter-checkbox-container:hover {
            background: #f0f0f0;
        }
        
        .filter-checkbox-container input[type="checkbox"] {
            margin-right: 4px;
            cursor: pointer;
        }
        
        .filter-checkbox-container span {
            font-size: 12px;
            cursor: pointer;
            user-select: none;
        }
        
        /* Á≠õÈÄâÊù°Ê†∑Âºè */
        .filter-bar {
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 16px;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        .filter-bar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: #e9ecef;
            cursor: pointer;
            user-select: none;
            transition: background-color 0.2s ease;
        }
        
        .filter-bar-header:hover {
            background: #dee2e6;
        }
        
        .filter-bar-title {
            font-size: 14px;
            font-weight: 500;
            color: #333;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .filter-bar-toggle {
            font-size: 16px;
            color: #666;
            transition: transform 0.3s ease;
        }
        
        .filter-bar.expanded .filter-bar-toggle {
            transform: rotate(180deg);
        }
        
        .filter-bar-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }
        
        .filter-bar.expanded .filter-bar-content {
            max-height: 500px;
        }
        
        .filter-section {
            padding: 16px;
            border-bottom: 1px solid #e9ecef;
        }
        
        .filter-section:last-child {
            border-bottom: none;
        }
        
        .filter-section-title {
            font-size: 13px;
            font-weight: 500;
            color: #333;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .filter-section-content {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .filter-actions {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }
        
        .filter-summary {
            font-size: 12px;
            color: #666;
            margin-left: auto;
        }
        
        .restaurant-list {
            max-height: none;
            overflow-y: auto;
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }
        
        .restaurant-item {
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            user-select: none;
            flex-shrink: 0;
        }
        
        .restaurant-item:hover {
            border-color: #1b8eec;
            background: #f8f9fa;
        }
        
        .restaurant-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }
        
        .restaurant-name {
            font-weight: bold;
            font-size: 13px;
            color: #333;
        }
        
        .restaurant-rate {
            font-size: 11px;
            font-weight: bold;
        }
        
        .restaurant-location {
            font-size: 11px;
            color: #666;
            margin-bottom: 2px;
        }
        
        .restaurant-address {
            font-size: 11px;
            color: #999;
            line-height: 1.3;
        }
        .info-panel.collapsed .info-panel-resizer,
        .info-panel.collapsed .info-panel-corner-resizer,
        .info-panel.collapsed .info-panel-corner-resizer-left {
            display: none !important;
            background: transparent !important;
            height: 0 !important;
            border: none !important;
            box-shadow: none !important;
        }
        
        /* Áî®Êà∑Áä∂ÊÄÅÊ†èÊ†∑Âºè */
        .user-status-bar {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1001;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 6px 0 rgba(27, 142, 236, 0.2);
            padding: 8px 12px;
            min-width: 120px;
            transition: all 0.3s ease;
        }
        
        .user-status-bar:hover {
            box-shadow: 0 4px 12px 0 rgba(27, 142, 236, 0.3);
            transform: translateY(-1px);
        }
        
        /* ÂìçÂ∫îÂºèËÆæËÆ° */
        @media (max-width: 768px) {
            .user-status-bar {
                top: 10px;
                right: 10px;
                padding: 6px 8px;
                min-width: 100px;
            }
            
            .info-panel {
                margin-top: 50px;
                right: 10px;
                width: calc(100vw - 20px);
                max-width: 400px;
            }
            
            .user-info {
                gap: 4px;
            }
            
            .login-btn, .register-btn {
                padding: 4px 8px;
                font-size: 12px;
            }
            
            .logout-btn {
                padding: 3px 6px;
                font-size: 11px;
            }
        }
        
        @media (max-width: 480px) {
            .user-status-bar {
                min-width: 80px;
                padding: 4px 6px;
            }
            
            .user-status-logged-out {
                gap: 4px;
            }
            
            .login-btn, .register-btn {
                padding: 3px 6px;
                font-size: 11px;
            }
            
            .user-nickname {
                font-size: 12px;
            }
            
            /* Âú®Ë∂ÖÂ∞èÂ±èÂπï‰∏äË∞ÉÊï¥Â≠ó‰ΩìÂ§ßÂ∞è */
            .login-btn,
            .register-btn,
            .user-nickname,
            .logout-btn {
                font-size: 11px;
            }
        }
        
        .user-status-logged-out {
            display: flex;
            gap: 8px;
        }
        
        .login-btn, .register-btn {
            font-size: 14px;
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s ease;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .login-btn {
            background: #1b8eec;
            color: #fff;
        }
        
        .login-btn:hover {
            background: #156bbd;
        }
        
        .register-btn {
            background: #28a745;
            color: #fff;
        }
        
        .register-btn:hover {
            background: #218838;
        }
        
        .user-status-logged-in {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .user-nickname {
            font-size: 14px;
            color: #333;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .logout-btn {
            font-size: 12px;
            padding: 4px 8px;
            background: #dc3545;
            color: #fff;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 2px;
        }
        
        .logout-btn:hover {
            background: #c82333;
        }
        
        /* ËÆ§ËØÅÊ®°ÊÄÅÊ°ÜÊ†∑Âºè */
        .auth-modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(2px);
        }
        
        .auth-modal-content {
            background-color: #fff;
            margin: 5% auto;
            padding: 0;
            border-radius: 12px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s ease-out;
        }
        
        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .auth-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px 16px;
            border-bottom: 1px solid #e9ecef;
        }
        
        .auth-modal-header h2 {
            margin: 0;
            font-size: 20px;
            color: #333;
            font-weight: 600;
        }
        
        .auth-modal-close {
            background: none;
            border: none;
            font-size: 24px;
            color: #999;
            cursor: pointer;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background-color 0.2s ease;
        }
        
        .auth-modal-close:hover {
            background-color: #f8f9fa;
            color: #666;
        }
        
        .auth-modal-body {
            padding: 24px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-size: 14px;
            color: #333;
            font-weight: 500;
        }
        
        .form-group input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.2s ease;
            box-sizing: border-box;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: #1b8eec;
        }
        
        .form-hint {
            display: block;
            margin-top: 4px;
            font-size: 12px;
            color: #666;
        }
        
        .form-actions {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 24px;
        }
        
        .auth-submit-btn {
            width: 100%;
            padding: 12px;
            background: #1b8eec;
            color: #fff;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        
        .auth-submit-btn:hover {
            background: #156bbd;
        }
        
        .auth-submit-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .auth-switch-btn {
            background: none;
            border: none;
            color: #1b8eec;
            font-size: 14px;
            cursor: pointer;
            text-decoration: underline;
            padding: 8px;
        }
        
        .auth-switch-btn:hover {
            color: #156bbd;
        }
        
        /* ÈîôËØØÊ∂àÊÅØÊ†∑Âºè */
        .error-message {
            color: #dc3545;
            font-size: 12px;
            margin-top: 4px;
            display: none;
        }
        
        .form-group.error input {
            border-color: #dc3545;
        }
        
        .form-group.error .error-message {
            display: block;
        }
        
        /* ÊàêÂäüÊ∂àÊÅØÊ†∑Âºè */
        .success-message {
            color: #28a745;
            font-size: 14px;
            text-align: center;
            margin-top: 12px;
            display: none;
        }
    </style>
</head>
<body>
    <div class="search-bar">
        <input type="text" id="keyword" placeholder="ËØ∑ËæìÂÖ•POIÂÖ≥ÈîÆÂ≠óÔºåÂ¶ÇÈ§êÂéÖ„ÄÅÊôØÁÇπ..." />
        <button id="search-btn">ÊêúÁ¥¢</button>
    </div>
    
    <!-- Áî®Êà∑Áä∂ÊÄÅÂå∫Âüü -->
    <div class="user-status-bar" id="user-status-bar">
        <div class="user-status-logged-out" id="user-status-logged-out">
            <button class="login-btn" id="login-btn">üîë ÁôªÂΩï</button>
            <button class="register-btn" id="register-btn">üìù Ê≥®ÂÜå</button>
        </div>
        <div class="user-status-logged-in" id="user-status-logged-in" style="display: none;">
            <div class="user-info">
                <span class="user-nickname" id="user-nickname">üë§ Áî®Êà∑ÊòµÁß∞</span>
                <button class="logout-btn" id="logout-btn">üö™ ÈÄÄÂá∫</button>
            </div>
        </div>
    </div>
    
    <!-- ÁôªÂΩïÊ®°ÊÄÅÊ°Ü -->
    <div class="auth-modal" id="login-modal">
        <div class="auth-modal-content">
            <div class="auth-modal-header">
                <h2>Áî®Êà∑ÁôªÂΩï</h2>
                <button class="auth-modal-close" id="login-modal-close">&times;</button>
            </div>
            <div class="auth-modal-body">
                <form id="login-form">
                    <div class="form-group">
                        <label for="login-unique-id">Áî®Êà∑Âêç</label>
                        <input type="text" id="login-unique-id" name="unique_id" placeholder="ËØ∑ËæìÂÖ•Áî®Êà∑Âêç" required>
                    </div>
                    <div class="form-group">
                        <label for="login-password">ÂØÜÁ†Å</label>
                        <input type="password" id="login-password" name="password" placeholder="ËØ∑ËæìÂÖ•ÂØÜÁ†Å" required>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="auth-submit-btn">ÁôªÂΩï</button>
                        <button type="button" class="auth-switch-btn" id="switch-to-register">Ê≤°ÊúâË¥¶Âè∑ÔºüÂéªÊ≥®ÂÜå</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Ê≥®ÂÜåÊ®°ÊÄÅÊ°Ü -->
    <div class="auth-modal" id="register-modal">
        <div class="auth-modal-content">
            <div class="auth-modal-header">
                <h2>Áî®Êà∑Ê≥®ÂÜå</h2>
                <button class="auth-modal-close" id="register-modal-close">&times;</button>
            </div>
            <div class="auth-modal-body">
                <form id="register-form">
                    <div class="form-group">
                        <label for="register-nickname">ÊòµÁß∞</label>
                        <input type="text" id="register-nickname" name="nickname" placeholder="ËØ∑ËæìÂÖ•ÊòµÁß∞" required>
                    </div>
                    <div class="form-group">
                        <label for="register-unique-id">Áî®Êà∑Âêç</label>
                        <input type="text" id="register-unique-id" name="unique_id" placeholder="ËØ∑ËæìÂÖ•Áî®Êà∑ÂêçÔºà3-20‰ΩçÂ≠óÊØçÊï∞Â≠ó‰∏ãÂàíÁ∫øÔºâ" required>
                        <small class="form-hint">Áî®Êà∑ÂêçÂè™ËÉΩÂåÖÂê´Â≠óÊØç„ÄÅÊï∞Â≠óÂíå‰∏ãÂàíÁ∫øÔºåÈïøÂ∫¶3-20‰Ωç</small>
                    </div>
                    <div class="form-group">
                        <label for="register-password">ÂØÜÁ†Å</label>
                        <input type="password" id="register-password" name="password" placeholder="ËØ∑ËæìÂÖ•ÂØÜÁ†Å" required>
                    </div>
                    <div class="form-group">
                        <label for="register-confirm-password">Á°ÆËÆ§ÂØÜÁ†Å</label>
                        <input type="password" id="register-confirm-password" name="confirm_password" placeholder="ËØ∑ÂÜçÊ¨°ËæìÂÖ•ÂØÜÁ†Å" required>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="auth-submit-btn">Ê≥®ÂÜå</button>
                        <button type="button" class="auth-switch-btn" id="switch-to-login">Â∑≤ÊúâË¥¶Âè∑ÔºüÂéªÁôªÂΩï</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <div id="map"></div>
    
    <!-- ‰ø°ÊÅØÈù¢Êùø -->
    <div class="info-panel" id="info-panel">
        <div class="info-panel-header" id="info-panel-header">
            <span>‰ø°ÊÅØÈù¢Êùø</span>
            <button class="info-panel-toggle-btn" id="info-panel-toggle-btn" tabindex="-1">‚ñ≤</button>
        </div>
        <div class="info-panel-content" id="info-panel-content">
            <!-- ÂÜÖÂÆπÂ∞ÜÈÄöËøáJavaScriptÂä®ÊÄÅÁîüÊàê -->
        </div>
        <div class="info-panel-resizer" id="info-panel-resizer"></div>
        <div class="info-panel-corner-resizer" id="info-panel-corner-resizer"></div>
        <div class="info-panel-corner-resizer-left" id="info-panel-corner-resizer-left"></div>
    </div>
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Supabase ÈÖçÁΩÆ -->
    <script src="supabase_config.js"></script>
    <!-- ÁôæÂ∫¶Âú∞ÂõæAPI -->
    <script src="https://api.map.baidu.com/api?v=1.0&type=webgl&ak=37RkgO1xJD842QrZ0AnUGHpCOYSGg3kh"></script>
    <script>
        // ===================== Supabase ÈÖçÁΩÆ =====================
        // ‰ªéÈÖçÁΩÆÊñá‰ª∂Ëé∑Âèñ Supabase ÈÖçÁΩÆ
        const SUPABASE_URL = window.SUPABASE_CONFIG.URL;
        const SUPABASE_ANON_KEY = window.SUPABASE_CONFIG.ANON_KEY;
        
        // ÂàùÂßãÂåñ Supabase ÂÆ¢Êà∑Á´Ø
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // ===================== Â∏∏ÈáèÈÖçÁΩÆ =====================
        const RATE_TYPES = [
            { value: "Ë∂ÖÁà±", drop: "#FF4500", star: "white" },
            { value: "ÂñúÊ¨¢", drop: "#FFA500", star: "white" },
            { value: "‰∏ÄËà¨", drop: "#808080", star: "white" },
            { value: "‰∏ç‰ºöÂÜçÂéª‰∫Ü", drop: "#556B2F", star: "black" }
        ];
        const GLOBAL_DEFAULT_ZOOM = 15; // Ëá™Âä®Áº©ÊîæÈªòËÆ§Á∫ßÂà´

        // ===================== Êï∞ÊçÆÁÆ°ÁêÜ =====================
        let map;
        let localSearch;
        window.ratedPois = [];
        window.ratedMarkers = {};
        window._poiMarkers = [];
        
        // ===================== Áî®Êà∑ËÆ§ËØÅÁÆ°ÁêÜ =====================
        let currentUser = null;
        let isLoggedIn = false;
        
        // Áî®Êà∑ËÆ§ËØÅÁõ∏ÂÖ≥ÂáΩÊï∞
        function loadUserSession() {
            const userSession = localStorage.getItem('userSession');
            if (userSession) {
                try {
                    const session = JSON.parse(userSession);
                    // Ê£ÄÊü•‰ºöËØùÊòØÂê¶ËøáÊúüÔºà24Â∞èÊó∂Ôºâ
                    if (session.timestamp && (Date.now() - session.timestamp) < 24 * 60 * 60 * 1000) {
                        currentUser = session.user;
                        isLoggedIn = true;
                        updateUserStatusUI();
                        return true;
                    } else {
                        // ‰ºöËØùËøáÊúüÔºåÊ∏ÖÈô§
                        localStorage.removeItem('userSession');
                    }
                } catch (e) {
                    localStorage.removeItem('userSession');
                }
            }
            return false;
        }
        
        function saveUserSession(user) {
            const session = {
                user: user,
                timestamp: Date.now()
            };
            localStorage.setItem('userSession', JSON.stringify(session));
        }
        
        function clearUserSession() {
            localStorage.removeItem('userSession');
            currentUser = null;
            isLoggedIn = false;
            updateUserStatusUI();
        }
        
        function updateUserStatusUI() {
            const loggedOutDiv = document.getElementById('user-status-logged-out');
            const loggedInDiv = document.getElementById('user-status-logged-in');
            const nicknameSpan = document.getElementById('user-nickname');
            
            if (isLoggedIn && currentUser) {
                loggedOutDiv.style.display = 'none';
                loggedInDiv.style.display = 'flex';
                nicknameSpan.textContent = currentUser.nickname;
            } else {
                loggedOutDiv.style.display = 'flex';
                loggedInDiv.style.display = 'none';
            }
            
            // Êõ¥Êñ∞‰ø°ÊÅØÈù¢Êùø‰ª•ÂèçÊò†ÁôªÂΩïÁä∂ÊÄÅÂèòÂåñ
            if (currentView === 'list') {
                updateInfoPanel(null, 'list');
            } else if (currentView === 'stats') {
                updateInfoPanel(null, 'stats');
            } else if (currentView === 'search' && currentSearchResults.length > 0) {
                updateInfoPanel(null, 'search', currentSearchResults);
            } else if (currentView === 'detail' && currentPoi) {
                updateInfoPanel(currentPoi, 'detail');
            }
        }
        
        // Supabase Áî®Êà∑ËÆ§ËØÅAPI
        async function loginUser(uniqueId, password) {
            try {
                // ‰ªéÊï∞ÊçÆÂ∫ìÊü•ËØ¢Áî®Êà∑
                const { data: user, error } = await supabase
                    .from('users')
                    .select('*')
                    .eq('unique_id', uniqueId)
                    .single();
                
                if (error || !user) {
                    throw new Error('Áî®Êà∑ÂêçÊàñÂØÜÁ†ÅÈîôËØØ');
                }
                
                // È™åËØÅÂØÜÁ†ÅÔºàËøôÈáå‰ΩøÁî®ÁÆÄÂçïÁöÑÊØîËæÉÔºåÂÆûÈôÖÂ∫îËØ•‰ΩøÁî®bcryptÔºâ
                if (user.password_hash !== password) {
                    throw new Error('Áî®Êà∑ÂêçÊàñÂØÜÁ†ÅÈîôËØØ');
                }
                
                // Êõ¥Êñ∞ÊúÄÂêéÊ¥ªË∑ÉÊó∂Èó¥
                await supabase
                    .from('users')
                    .update({ last_active: new Date().toISOString() })
                    .eq('id', user.id);
                
                return {
                    id: user.id,
                    unique_id: user.unique_id,
                    nickname: user.nickname,
                    avatar_url: user.avatar_url
                };
            } catch (error) {
                console.error('ÁôªÂΩïÈîôËØØ:', error);
                throw new Error('Áî®Êà∑ÂêçÊàñÂØÜÁ†ÅÈîôËØØ');
            }
        }
        
        async function registerUser(nickname, uniqueId, password) {
            try {
                // Ê£ÄÊü•Áî®Êà∑ÂêçÊòØÂê¶Â∑≤Â≠òÂú®
                const { data: existingUser, error: checkError } = await supabase
                    .from('users')
                    .select('id')
                    .eq('unique_id', uniqueId)
                    .single();
                
                if (existingUser) {
                    throw new Error('Áî®Êà∑ÂêçÂ∑≤Â≠òÂú®');
                }
                
                // ÂàõÂª∫Êñ∞Áî®Êà∑ÔºàËøôÈáå‰ΩøÁî®ÁÆÄÂçïÁöÑÂØÜÁ†ÅÂ≠òÂÇ®ÔºåÂÆûÈôÖÂ∫îËØ•‰ΩøÁî®bcryptÂìàÂ∏åÔºâ
                const { data: newUser, error } = await supabase
                    .from('users')
                    .insert([
                        {
                            nickname: nickname,
                            unique_id: uniqueId,
                            password_hash: password // ÂÆûÈôÖÂ∫îËØ•‰ΩøÁî® bcrypt.hash(password, 10)
                        }
                    ])
                    .select()
                    .single();
                
                if (error) {
                    console.error('Ê≥®ÂÜåÈîôËØØ:', error);
                    throw new Error('Ê≥®ÂÜåÂ§±Ë¥•ÔºåËØ∑ÈáçËØï');
                }
                
                return {
                    id: newUser.id,
                    unique_id: newUser.unique_id,
                    nickname: newUser.nickname,
                    avatar_url: newUser.avatar_url
                };
            } catch (error) {
                console.error('Ê≥®ÂÜåÈîôËØØ:', error);
                throw error;
            }
        }
        
        // Ë°®ÂçïÈ™åËØÅÂáΩÊï∞
        function validateUniqueId(uniqueId) {
            const pattern = /^[a-zA-Z0-9_]{3,20}$/;
            return pattern.test(uniqueId);
        }
        
        function validatePassword(password) {
            return password && password.length >= 6;
        }
        
        function validateNickname(nickname) {
            return nickname && nickname.trim().length >= 2;
        }
        
        // ÊòæÁ§∫ÈîôËØØÊ∂àÊÅØ
        function showFormError(formGroup, message) {
            formGroup.classList.add('error');
            let errorDiv = formGroup.querySelector('.error-message');
            if (!errorDiv) {
                errorDiv = document.createElement('div');
                errorDiv.className = 'error-message';
                formGroup.appendChild(errorDiv);
            }
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }
        
        // Ê∏ÖÈô§ÈîôËØØÊ∂àÊÅØ
        function clearFormError(formGroup) {
            formGroup.classList.remove('error');
            const errorDiv = formGroup.querySelector('.error-message');
            if (errorDiv) {
                errorDiv.style.display = 'none';
            }
        }
        
        // ÊòæÁ§∫ÊàêÂäüÊ∂àÊÅØ
        function showSuccessMessage(modal, message) {
            let successDiv = modal.querySelector('.success-message');
            if (!successDiv) {
                successDiv = document.createElement('div');
                successDiv.className = 'success-message';
                modal.querySelector('.auth-modal-body').appendChild(successDiv);
            }
            successDiv.textContent = message;
            successDiv.style.display = 'block';
        }
        
        // Ê®°ÊÄÅÊ°ÜÁÆ°ÁêÜ
        function showModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.style.display = 'block';
            // Ê∏ÖÈô§‰πãÂâçÁöÑÈîôËØØÂíåÊàêÂäüÊ∂àÊÅØ
            modal.querySelectorAll('.error-message, .success-message').forEach(el => {
                el.style.display = 'none';
            });
            modal.querySelectorAll('.form-group').forEach(el => {
                el.classList.remove('error');
            });
        }
        
        function hideModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.style.display = 'none';
        }
        
        function switchModal(fromModalId, toModalId) {
            hideModal(fromModalId);
            showModal(toModalId);
        }

        async function loadRatedPois() {
            if (!isLoggedIn || !currentUser) {
                window.ratedPois = [];
                return;
            }
            
            try {
                const { data: reviews, error } = await supabase
                    .from('restaurant_reviews')
                    .select('*')
                    .eq('user_id', currentUser.id);
                
                if (error) {
                    console.error('Âä†ËΩΩËØÑÂàÜÊï∞ÊçÆÈîôËØØ:', error);
                    window.ratedPois = [];
                    return;
                }
                
                // Â∞ÜÊï∞ÊçÆÂ∫ìÊ†ºÂºèËΩ¨Êç¢‰∏∫Â∫îÁî®Ê†ºÂºè
                window.ratedPois = reviews.map(review => ({
                    uid: review.restaurant_uid,
                    title: review.restaurant_name,
                    shortTitle: getShortTitle(review.restaurant_name),
                    address: review.restaurant_address,
                    point: review.longitude && review.latitude ? {
                        lng: review.longitude,
                        lat: review.latitude
                    } : undefined,
                    city: review.restaurant_city,
                    area: review.restaurant_area,
                    tags: review.tags || [],
                    phoneNumber: null, // Êï∞ÊçÆÂ∫ì‰∏≠Ê≤°ÊúâÂ≠òÂÇ®
                    rate: review.rating,
                    // Ê∑ªÂä†Êï∞ÊçÆÂ∫ìÂ≠óÊÆµ
                    review_id: review.id,
                    user_id: review.user_id, // Ê∑ªÂä†Áî®Êà∑ID
                    review_text: review.review_text,
                    is_public: review.is_public,
                    created_at: review.created_at,
                    updated_at: review.updated_at
                }));
            } catch (error) {
                console.error('Âä†ËΩΩËØÑÂàÜÊï∞ÊçÆÈîôËØØ:', error);
                window.ratedPois = [];
            }
        }
        
        async function saveRatedPoi(poi, rate) {
            if (!isLoggedIn || !currentUser) {
                throw new Error('Áî®Êà∑Êú™ÁôªÂΩï');
            }
            
            try {
                const reviewData = {
                    user_id: currentUser.id,
                    restaurant_uid: poi.uid,
                    restaurant_name: getPoiField(poi, ['title', 'name']),
                    restaurant_address: getPoiField(poi, ['address', 'addr']),
                    restaurant_city: getPoiField(poi, ['city', 'cityname']),
                    restaurant_area: getPoiField(poi, ['area', 'areaname', 'district']),
                    rating: rate,
                    latitude: poi.point ? parseFloat(poi.point.lat) : null,
                    longitude: poi.point ? parseFloat(poi.point.lng) : null,
                    tags: Array.isArray(getPoiField(poi, ['tags', 'std_tag', 'tag'])) 
                        ? getPoiField(poi, ['tags', 'std_tag', 'tag']) 
                        : []
                };
                
                console.log('‰øùÂ≠òËØÑÂàÜÊï∞ÊçÆ:', reviewData);
                
                const { data, error } = await supabase
                    .from('restaurant_reviews')
                    .upsert(reviewData, { 
                        onConflict: 'user_id,restaurant_uid'
                    })
                    .select()
                    .single();
                
                if (error) {
                    console.error('‰øùÂ≠òËØÑÂàÜÈîôËØØ:', error);
                    throw new Error(`‰øùÂ≠òËØÑÂàÜÂ§±Ë¥•: ${error.message}`);
                }
                
                return data;
            } catch (error) {
                console.error('‰øùÂ≠òËØÑÂàÜÈîôËØØ:', error);
                throw error;
            }
        }
        async function addOrUpdateRatedPoi(poi, rate) {
            // Ê£ÄÊü•Áî®Êà∑ÊòØÂê¶Â∑≤ÁôªÂΩï
            if (!isLoggedIn) {
                showModal('login-modal');
                return;
            }
            
            try {
                // ‰øùÂ≠òÂà∞Supabase
                const savedReview = await saveRatedPoi(poi, rate);
                
                // Êõ¥Êñ∞Êú¨Âú∞Êï∞ÊçÆ
                const idx = window.ratedPois.findIndex(f => f.uid === poi.uid);
                const title = getPoiField(poi, ['title', 'name']);
                const shortTitle = getShortTitle(title);
                const address = getPoiField(poi, ['address', 'addr']);
                const city = getPoiField(poi, ['city', 'cityname']);
                const area = getPoiField(poi, ['area', 'areaname', 'district']);
                const tags = getPoiField(poi, ['tags', 'std_tag', 'tag']) || [];
                
                if (idx === -1) {
                    // Êñ∞Â¢ûËØÑÂàÜ
                    window.ratedPois.push({
                        uid: poi.uid,
                        title: title,
                        shortTitle: shortTitle,
                        address: address,
                        point: poi.point ? {lng: poi.point.lng, lat: poi.point.lat} : undefined,
                        city: city,
                        area: area,
                        tags: tags,
                        rate: rate,
                        review_id: savedReview.id,
                        created_at: savedReview.created_at,
                        updated_at: savedReview.updated_at
                    });
                } else {
                    // Êõ¥Êñ∞ËØÑÂàÜ
                    window.ratedPois[idx].rate = rate;
                    window.ratedPois[idx].shortTitle = shortTitle;
                    window.ratedPois[idx].title = title;
                    window.ratedPois[idx].address = address;
                    window.ratedPois[idx].city = city;
                    window.ratedPois[idx].area = area;
                    window.ratedPois[idx].tags = tags;
                    window.ratedPois[idx].updated_at = savedReview.updated_at;
                }
                
                renderRatedMarkers();
                // Â¶ÇÊûúÂΩìÂâçÂú®ÂàóË°®ËßÜÂõæÔºåÊõ¥Êñ∞Èù¢Êùø
                if (currentView === 'list') {
                    updateInfoPanel(null, 'list');
                }
                // Â¶ÇÊûúÂΩìÂâçÂú®ËØ¶ÊÉÖËßÜÂõæ‰∏îÊòØÂêå‰∏Ä‰∏™È§êÂéÖÔºåÊõ¥Êñ∞ËØ¶ÊÉÖÈù¢Êùø
                if (currentView === 'detail' && currentPoi && currentPoi.uid === poi.uid) {
                    updateInfoPanel(poi, 'detail');
                }
            } catch (error) {
                console.error('‰øùÂ≠òËØÑÂàÜÂ§±Ë¥•:', error);
                alert('‰øùÂ≠òËØÑÂàÜÂ§±Ë¥•ÔºåËØ∑ÈáçËØï');
            }
        }
        
        async function removeRatedPoi(uid) {
            // Ê£ÄÊü•Áî®Êà∑ÊòØÂê¶Â∑≤ÁôªÂΩï
            if (!isLoggedIn) {
                showModal('login-modal');
                return;
            }
            
            try {
                // ‰ªéSupabaseÂà†Èô§
                const { error } = await supabase
                    .from('restaurant_reviews')
                    .delete()
                    .eq('user_id', currentUser.id)
                    .eq('restaurant_uid', uid);
                
                if (error) {
                    console.error('Âà†Èô§ËØÑÂàÜÈîôËØØ:', error);
                    throw new Error('Âà†Èô§ËØÑÂàÜÂ§±Ë¥•');
                }
                
                // Êõ¥Êñ∞Êú¨Âú∞Êï∞ÊçÆ
                window.ratedPois = window.ratedPois.filter(f => f.uid !== uid);
                renderRatedMarkers();
                // Â¶ÇÊûúÂΩìÂâçÂú®ÂàóË°®ËßÜÂõæÔºåÊõ¥Êñ∞Èù¢Êùø
                if (currentView === 'list') {
                    updateInfoPanel(null, 'list');
                }
                // Â¶ÇÊûúÂΩìÂâçÂú®ËØ¶ÊÉÖËßÜÂõæ‰∏îÊòØÂêå‰∏Ä‰∏™È§êÂéÖÔºåÊõ¥Êñ∞ËØ¶ÊÉÖÈù¢Êùø
                if (currentView === 'detail' && currentPoi && currentPoi.uid === uid) {
                    updateInfoPanel(currentPoi, 'detail');
                }
            } catch (error) {
                console.error('Âà†Èô§ËØÑÂàÜÂ§±Ë¥•:', error);
                alert('Âà†Èô§ËØÑÂàÜÂ§±Ë¥•ÔºåËØ∑ÈáçËØï');
            }
        }

        // ===================== ËßÜÂõæÊ∏≤Êüì =====================
        function getRatedSvg(rate) {
            const type = RATE_TYPES.find(t => t.value === rate) || RATE_TYPES[1];
            return `<svg width="32" height="40" viewBox="0 0 32 40" xmlns="http://www.w3.org/2000/svg">
                <path d="M16 40C16 40 32 24.5685 32 16C32 7.16344 24.8366 0 16 0C7.16344 0 0 7.16344 0 16C0 24.5685 16 40 16 40Z" fill="${type.drop}"/>
                <path d="M16 8L18.47 13.53L24 14.18L20 18.24L21.24 24L16 21.24L10.76 24L12 18.24L8 14.18L13.53 13.53L16 8Z" fill="${type.star}"/>
            </svg>`;
        }
        function renderRatedMarkers() {
            if(window.ratedMarkers) Object.values(window.ratedMarkers).forEach(marker => map.removeOverlay(marker));
            window.ratedMarkers = {};
            
            // ‰ΩøÁî®Á≠õÈÄâÂêéÁöÑÊï∞ÊçÆÊù•Ê∏≤ÊüìÊ†áËÆ∞
            const filteredPois = getFilteredRatedPois();
            
            filteredPois.forEach(poi => {
                if (!poi.point || typeof poi.point.lng !== 'number' || typeof poi.point.lat !== 'number') return;
                const pt = new BMapGL.Point(poi.point.lng, poi.point.lat);
                const svg = getRatedSvg(poi.rate);
                const svgUrl = 'data:image/svg+xml;base64,' + btoa(svg);
                const icon = new BMapGL.Icon(svgUrl, new BMapGL.Size(32, 40), { anchor: new BMapGL.Size(16, 40) });
                const marker = new BMapGL.Marker(pt, {icon: icon});
                const label = new BMapGL.Label(poi.shortTitle || poi.title, { offset: new BMapGL.Size(20, -10) });
                label.setStyle({
                    color: '#333', fontSize: '14px', background: 'rgba(255,255,255,0.85)',
                    border: 'none', padding: '2px 8px', borderRadius: '4px', fontWeight: 'bold', zIndex: 999
                });
                marker.setLabel(label);
                map.addOverlay(marker);
                window.ratedMarkers[poi.uid] = marker;
                marker.addEventListener('click', function() {
                    showPoiInfoWindow(poi, marker);
                });
            });
        }
        function clearPoiMarkers() {
            if (window._poiMarkers) {
                window._poiMarkers.forEach(m => map.removeOverlay(m));
            }
            window._poiMarkers = [];
        }
        function getCheckedRates() {
            // ‰ΩøÁî®‰ø°ÊÅØÈù¢ÊùøÁöÑÁ≠õÈÄâÁä∂ÊÄÅÔºåÂ¶ÇÊûúÊ≤°ÊúâÂàô‰ΩøÁî®‰øùÂ≠òÁöÑÁä∂ÊÄÅ
            const infoPanelFilters = document.querySelectorAll('.rate-filter:checked');
            if (infoPanelFilters.length > 0) {
                return Array.from(infoPanelFilters).map(cb => cb.value);
            }
            // Â¶ÇÊûúÊ≤°ÊúâÊâæÂà∞‰ø°ÊÅØÈù¢ÊùøÁöÑÁ≠õÈÄâÂô®Ôºå‰ΩøÁî®‰øùÂ≠òÁöÑÁä∂ÊÄÅ
            return Object.keys(listFilterState).filter(key => listFilterState[key]);
        }
        function updateMapViewportForRatedPois() {
            // ‰ΩøÁî®Á≠õÈÄâÂêéÁöÑÊï∞ÊçÆÊù•Êõ¥Êñ∞Âú∞ÂõæËßÜÂè£
            const filteredPois = getFilteredRatedPois();
            if (filteredPois && filteredPois.length > 0) {
                const points = filteredPois
                    .filter(poi => poi.point && typeof poi.point.lng === 'number' && typeof poi.point.lat === 'number')
                    .map(poi => new BMapGL.Point(poi.point.lng, poi.point.lat));
                if (points.length > 0) {
                    // ÊâãÂä®Êâ©Â§ßËæπÁïåÔºåÈÅøÂÖçË¥¥Ëæπ
                    let minLng = Math.min(...points.map(p => p.lng));
                    let maxLng = Math.max(...points.map(p => p.lng));
                    let minLat = Math.min(...points.map(p => p.lat));
                    let maxLat = Math.max(...points.map(p => p.lat));
                    const padding = 0.01;
                    minLng -= padding; maxLng += padding; minLat -= padding; maxLat += padding;
                    map.setViewport([
                        new BMapGL.Point(minLng, minLat),
                        new BMapGL.Point(maxLng, maxLat)
                    ]);
                }
            }
        }

        // ===================== ‰ø°ÊÅØÁ™óÂè£ =====================
        function getPoiField(poi, fieldNames) {
            // ÊîØÊåÅÂ§öÁßçÂèØËÉΩÁöÑÂ≠óÊÆµÂêçÔºåÊåâ‰ºòÂÖàÁ∫ßËøîÂõûÁ¨¨‰∏Ä‰∏™Â≠òÂú®ÁöÑÂÄº
            for (let fieldName of fieldNames) {
                if (poi[fieldName] !== undefined && poi[fieldName] !== null && poi[fieldName] !== '') {
                    return poi[fieldName];
                }
            }
            return '';
        }

        function getShortTitle(title) {
            if (!title) return '';
            const idx = title.indexOf('(');
            return idx > 0 ? title.slice(0, idx).trim() : title;
        }

        function showPoiInfoWindow(poi, marker) {
            // Ë∑≥ËΩ¨Âà∞È§êÂéÖËØ¶ÊÉÖÈ°µÈù¢
            updateInfoPanel(poi, 'detail');
        }

        // ===================== Âú∞Âõæ‰∏éÊêúÁ¥¢ =====================
        function initMap() {
            map = new BMapGL.Map("map", {enableIconClick: true});
            map.centerAndZoom(new BMapGL.Point(116.404, 39.915), GLOBAL_DEFAULT_ZOOM);
            map.enableScrollWheelZoom(true);
            map.setMapStyleV2({ styleId: '75a3e83ace0ff353fbf5a085935333e7' });
            // ‰∏çÂÜçËÆæÁΩÆÊúÄÂ§ßÁº©ÊîæÔºåÁî®Êà∑ÂèØÊâãÂä®ÊîæÂ§ß
            initLocalSearch();
        }
        function initLocalSearch() {
            localSearch = new BMapGL.LocalSearch(map, {
                renderOptions: { map: null, autoViewport: false },
                pageCapacity: 20 // ÊØèÈ°µ20Êù°
            });
            localSearch.setSearchCompleteCallback(handleSearchResults);
        }
        function handleSearchResults(results) {
            clearPoiMarkers();
            const points = [];
            const searchResults = [];
            for (let i = 0; i < results.getCurrentNumPois(); i++) {
                const poi = results.getPoi(i);
                if (poi && poi.point) {
                    const marker = createPoiMarker(poi);
                    map.addOverlay(marker);
                    window._poiMarkers.push(marker);
                    points.push(poi.point);
                    searchResults.push(poi);
                }
            }
            if (points.length > 0) {
                map.setViewport(points);
            }
            renderRatedMarkers();
            // ÂàÜÈ°µÁ¥ØÂä†
            if (currentSearchPage === 0) {
                currentSearchResults = searchResults;
            } else {
                currentSearchResults = currentSearchResults.concat(searchResults);
            }
            hasMoreSearchResults = searchResults.length === 20;
            updateInfoPanel(null, 'search', currentSearchResults);
        }
        function createPoiMarker(poi) {
            const marker = new BMapGL.Marker(poi.point);
            // Â∞ÜPOIÊï∞ÊçÆÂ≠òÂÇ®Âà∞marker‰∏≠ÔºåÊñπ‰æøÂêéÁª≠Ëé∑Âèñ
            marker._poiData = poi;
            marker.addEventListener('click', function() {
                showPoiInfoWindow(poi, marker);
            });
            return marker;
        }

        // ===================== ËÆ§ËØÅ‰∫ã‰ª∂ÁªëÂÆö =====================
        function bindAuthEvents() {
            // ÁôªÂΩïÊåâÈíÆÁÇπÂáª‰∫ã‰ª∂
            document.getElementById('login-btn').addEventListener('click', () => {
                showModal('login-modal');
            });
            
            // Ê≥®ÂÜåÊåâÈíÆÁÇπÂáª‰∫ã‰ª∂
            document.getElementById('register-btn').addEventListener('click', () => {
                showModal('register-modal');
            });
            
            // ÈÄÄÂá∫ÁôªÂΩïÊåâÈíÆÁÇπÂáª‰∫ã‰ª∂
            document.getElementById('logout-btn').addEventListener('click', () => {
                if (confirm('Á°ÆÂÆöË¶ÅÈÄÄÂá∫ÁôªÂΩïÂêóÔºü')) {
                    clearUserSession();
                    // Ê∏ÖÁ©∫ËØÑÂàÜÊï∞ÊçÆ
                    window.ratedPois = [];
                    // ÈáçÁΩÆÁî®Êà∑Á≠õÈÄâÁä∂ÊÄÅ
                    userFilterState['Ëá™Â∑±'] = null;
                    userFilterMapping['Ëá™Â∑±'] = null;
                    renderRatedMarkers();
                    updateMapViewportForRatedPois();
                    updateInfoPanel(null, 'list');
                    
                    // ÊòæÁ§∫ÈÄÄÂá∫ÊèêÁ§∫
                    if (currentView === 'list') {
                        const panelContent = document.getElementById('info-panel-content');
                        const logoutDiv = document.createElement('div');
                        logoutDiv.style.cssText = 'background: #f8d7da; color: #721c24; padding: 12px; border-radius: 6px; margin-bottom: 16px; text-align: center;';
                        logoutDiv.textContent = 'Â∑≤ÈÄÄÂá∫ÁôªÂΩïÔºåËØ∑ÈáçÊñ∞ÁôªÂΩïÊâçËÉΩËøõË°åËØÑÂàÜÊìç‰Ωú„ÄÇ';
                        panelContent.insertBefore(logoutDiv, panelContent.firstChild);
                        setTimeout(() => logoutDiv.remove(), 3000);
                    }
                }
            });
            
            // Ê®°ÊÄÅÊ°ÜÂÖ≥Èó≠ÊåâÈíÆ‰∫ã‰ª∂
            document.getElementById('login-modal-close').addEventListener('click', () => {
                hideModal('login-modal');
            });
            
            document.getElementById('register-modal-close').addEventListener('click', () => {
                hideModal('register-modal');
            });
            
            // Ê®°ÊÄÅÊ°ÜËÉåÊôØÁÇπÂáªÂÖ≥Èó≠
            document.getElementById('login-modal').addEventListener('click', (e) => {
                if (e.target.id === 'login-modal') {
                    hideModal('login-modal');
                }
            });
            
            document.getElementById('register-modal').addEventListener('click', (e) => {
                if (e.target.id === 'register-modal') {
                    hideModal('register-modal');
                }
            });
            
            // ÂàáÊç¢Ê®°ÊÄÅÊ°ÜÊåâÈíÆ‰∫ã‰ª∂
            document.getElementById('switch-to-register').addEventListener('click', () => {
                switchModal('login-modal', 'register-modal');
            });
            
            document.getElementById('switch-to-login').addEventListener('click', () => {
                switchModal('register-modal', 'login-modal');
            });
            
            // ÁôªÂΩïË°®ÂçïÊèê‰∫§‰∫ã‰ª∂
            document.getElementById('login-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const uniqueId = document.getElementById('login-unique-id').value.trim();
                const password = document.getElementById('login-password').value;
                const submitBtn = e.target.querySelector('.auth-submit-btn');
                
                // Ê∏ÖÈô§‰πãÂâçÁöÑÈîôËØØ
                clearFormError(e.target.querySelector('.form-group'));
                
                // È™åËØÅËæìÂÖ•
                if (!uniqueId) {
                    showFormError(e.target.querySelector('.form-group'), 'ËØ∑ËæìÂÖ•Áî®Êà∑Âêç');
                    return;
                }
                
                if (!password) {
                    showFormError(e.target.querySelector('.form-group:last-child'), 'ËØ∑ËæìÂÖ•ÂØÜÁ†Å');
                    return;
                }
                
                // Á¶ÅÁî®Êèê‰∫§ÊåâÈíÆ
                submitBtn.disabled = true;
                submitBtn.textContent = 'ÁôªÂΩï‰∏≠...';
                
                try {
                    const user = await loginUser(uniqueId, password);
                    currentUser = user;
                    isLoggedIn = true;
                    saveUserSession(user);
                    updateUserStatusUI();
                    
                    showSuccessMessage(document.getElementById('login-modal'), 'ÁôªÂΩïÊàêÂäüÔºÅ');
                    
                                            // Âª∂ËøüÂÖ≥Èó≠Ê®°ÊÄÅÊ°Ü
                        setTimeout(async () => {
                            hideModal('login-modal');
                            // Ê∏ÖÁ©∫Ë°®Âçï
                            e.target.reset();
                            
                            // Êõ¥Êñ∞Áî®Êà∑Á≠õÈÄâÁä∂ÊÄÅ
                            userFilterState['Ëá™Â∑±'] = currentUser.id;
                            userFilterMapping['Ëá™Â∑±'] = currentUser.id;
                            
                            // Âä†ËΩΩÁî®Êà∑ËØÑÂàÜÊï∞ÊçÆ
                            await loadRatedPois();
                            renderRatedMarkers();
                            updateMapViewportForRatedPois();
                            updateInfoPanel(null, 'list'); // Êñ∞Â¢ûÔºöÁôªÂΩïÂêéÁ´ãÂç≥Âà∑Êñ∞ËØÑÂàÜÂàóË°®
                        
                        // ÊòæÁ§∫Ê¨¢ËøéÊ∂àÊÅØ
                        if (currentView === 'list') {
                            const panelContent = document.getElementById('info-panel-content');
                            const welcomeDiv = document.createElement('div');
                            welcomeDiv.style.cssText = 'background: #d4edda; color: #155724; padding: 12px; border-radius: 6px; margin-bottom: 16px; text-align: center;';
                            welcomeDiv.textContent = `Ê¨¢ËøéÂõûÊù•Ôºå${currentUser.nickname}ÔºÅÁé∞Âú®ÂèØ‰ª•ÂºÄÂßãËØÑÂàÜ‰∫Ü„ÄÇ`;
                            panelContent.insertBefore(welcomeDiv, panelContent.firstChild);
                            setTimeout(() => welcomeDiv.remove(), 3000);
                        }
                    }, 1500);
                    
                } catch (error) {
                    showFormError(e.target.querySelector('.form-group'), error.message);
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'ÁôªÂΩï';
                }
            });
            
            // Ê≥®ÂÜåË°®ÂçïÊèê‰∫§‰∫ã‰ª∂
            document.getElementById('register-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const nickname = document.getElementById('register-nickname').value.trim();
                const uniqueId = document.getElementById('register-unique-id').value.trim();
                const password = document.getElementById('register-password').value;
                const confirmPassword = document.getElementById('register-confirm-password').value;
                const submitBtn = e.target.querySelector('.auth-submit-btn');
                
                // Ê∏ÖÈô§‰πãÂâçÁöÑÈîôËØØ
                e.target.querySelectorAll('.form-group').forEach(el => clearFormError(el));
                
                // È™åËØÅËæìÂÖ•
                if (!validateNickname(nickname)) {
                    showFormError(e.target.querySelector('.form-group'), 'ÊòµÁß∞Ëá≥Â∞ëÈúÄË¶Å2‰∏™Â≠óÁ¨¶');
                    return;
                }
                
                if (!validateUniqueId(uniqueId)) {
                    showFormError(e.target.querySelectorAll('.form-group')[1], 'Áî®Êà∑ÂêçÊ†ºÂºè‰∏çÊ≠£Á°ÆÔºà3-20‰ΩçÂ≠óÊØçÊï∞Â≠ó‰∏ãÂàíÁ∫øÔºâ');
                    return;
                }
                
                if (!validatePassword(password)) {
                    showFormError(e.target.querySelectorAll('.form-group')[2], 'ÂØÜÁ†ÅËá≥Â∞ëÈúÄË¶Å6‰∏™Â≠óÁ¨¶');
                    return;
                }
                
                if (password !== confirmPassword) {
                    showFormError(e.target.querySelectorAll('.form-group')[3], '‰∏§Ê¨°ËæìÂÖ•ÁöÑÂØÜÁ†Å‰∏ç‰∏ÄËá¥');
                    return;
                }
                
                // Á¶ÅÁî®Êèê‰∫§ÊåâÈíÆ
                submitBtn.disabled = true;
                submitBtn.textContent = 'Ê≥®ÂÜå‰∏≠...';
                
                try {
                    const user = await registerUser(nickname, uniqueId, password);
                    currentUser = user;
                    isLoggedIn = true;
                    saveUserSession(user);
                    updateUserStatusUI();
                    
                    showSuccessMessage(document.getElementById('register-modal'), 'Ê≥®ÂÜåÊàêÂäüÔºÅ');
                    
                                            // Âª∂ËøüÂÖ≥Èó≠Ê®°ÊÄÅÊ°Ü
                        setTimeout(async () => {
                            hideModal('register-modal');
                            // Ê∏ÖÁ©∫Ë°®Âçï
                            e.target.reset();
                            
                            // Êõ¥Êñ∞Áî®Êà∑Á≠õÈÄâÁä∂ÊÄÅ
                            userFilterState['Ëá™Â∑±'] = currentUser.id;
                            userFilterMapping['Ëá™Â∑±'] = currentUser.id;
                            
                            // Âä†ËΩΩÁî®Êà∑ËØÑÂàÜÊï∞ÊçÆ
                            await loadRatedPois();
                            renderRatedMarkers();
                            updateMapViewportForRatedPois();
                            updateInfoPanel(null, 'list'); // Êñ∞Â¢ûÔºöÊ≥®ÂÜåÂêéÁ´ãÂç≥Âà∑Êñ∞ËØÑÂàÜÂàóË°®
                        
                        // ÊòæÁ§∫Ê¨¢ËøéÊ∂àÊÅØ
                        if (currentView === 'list') {
                            const panelContent = document.getElementById('info-panel-content');
                            const welcomeDiv = document.createElement('div');
                            welcomeDiv.style.cssText = 'background: #d4edda; color: #155724; padding: 12px; border-radius: 6px; margin-bottom: 16px; text-align: center;';
                            welcomeDiv.textContent = `Ê¨¢ËøéÂä†ÂÖ•Ôºå${currentUser.nickname}ÔºÅÁé∞Âú®ÂèØ‰ª•ÂºÄÂßãËØÑÂàÜ‰∫Ü„ÄÇ`;
                            panelContent.insertBefore(welcomeDiv, panelContent.firstChild);
                            setTimeout(() => welcomeDiv.remove(), 3000);
                        }
                    }, 1500);
                    
                } catch (error) {
                    showFormError(e.target.querySelectorAll('.form-group')[1], error.message);
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Ê≥®ÂÜå';
                }
            });
        }
        
        // ===================== ‰∫ã‰ª∂ÁªëÂÆö =====================
        function bindUIEvents() {
            document.getElementById('search-btn').onclick = function() {
                const keyword = document.getElementById('keyword').value.trim();
                if (!keyword) {
                    alert('ËØ∑ËæìÂÖ•ÊêúÁ¥¢ÂÖ≥ÈîÆÂ≠ó');
                    return;
                }
                currentSearchPage = 0;
                currentSearchKeyword = keyword;
                currentSearchResults = [];
                hasMoreSearchResults = false;
                localSearch.search(keyword);
            };
            document.getElementById('keyword').addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    document.getElementById('search-btn').click();
                }
            });
            
            // ‰ø°ÊÅØÈù¢ÊùøÊî∂Áº©/Â±ïÂºÄ‰∫ã‰ª∂ÁªëÂÆö
            function toggleInfoPanel() {
                const panel = document.getElementById('info-panel');
                const btn = document.getElementById('info-panel-toggle-btn');
                const isCollapsed = panel.classList.contains('collapsed');
                if (isCollapsed) {
                    panel.classList.remove('collapsed');
                    // btn.innerText ‰∏çÂÜçÂàáÊç¢
                    panel.style.height = (panel._lastHeight || 600) + 'px';
                    panel.style.width = (panel._lastWidth || 400) + 'px';
                } else {
                    panel._lastHeight = panel.offsetHeight;
                    panel._lastWidth = panel.offsetWidth;
                    panel.classList.add('collapsed');
                    // btn.innerText ‰∏çÂÜçÂàáÊç¢
                    panel.style.height = '48px';
                    panel.style.width = '48px';
                }
            }
            document.getElementById('info-panel-header').onclick = toggleInfoPanel;
            // ‰∏ãËæπÊãâ‰º∏
            (function() {
                const panel = document.getElementById('info-panel');
                const resizer = document.getElementById('info-panel-resizer');
                let startY, startHeight, dragging = false;
                resizer.addEventListener('mousedown', function(e) {
                    if (panel.classList.contains('collapsed')) return;
                    dragging = true;
                    startY = e.clientY;
                    startHeight = panel.offsetHeight;
                    document.body.style.userSelect = 'none';
                });
                window.addEventListener('mousemove', function(e) {
                    if (!dragging) return;
                    let newHeight = startHeight + (e.clientY - startY);
                    newHeight = Math.max(120, Math.min(newHeight, window.innerHeight * 0.9));
                    panel.style.height = newHeight + 'px';
                    panel._lastHeight = newHeight;
                });
                window.addEventListener('mouseup', function() {
                    if (dragging) {
                        dragging = false;
                        document.body.style.userSelect = '';
                    }
                });
            })();
            // Âè≥‰∏ãËßíÊãâ‰º∏
            (function() {
                const panel = document.getElementById('info-panel');
                const resizer = document.getElementById('info-panel-corner-resizer');
                let startY, startX, startHeight, startWidth, dragging = false;
                resizer.addEventListener('mousedown', function(e) {
                    if (panel.classList.contains('collapsed')) return;
                    dragging = true;
                    startY = e.clientY;
                    startX = e.clientX;
                    startHeight = panel.offsetHeight;
                    startWidth = panel.offsetWidth;
                    document.body.style.userSelect = 'none';
                    e.preventDefault();
                });
                window.addEventListener('mousemove', function(e) {
                    if (!dragging) return;
                    let newHeight = startHeight + (e.clientY - startY);
                    let newWidth = startWidth + (e.clientX - startX);
                    newHeight = Math.max(120, Math.min(newHeight, window.innerHeight * 0.9));
                    newWidth = Math.max(220, Math.min(newWidth, window.innerWidth * 0.9));
                    panel.style.height = newHeight + 'px';
                    panel.style.width = newWidth + 'px';
                    panel._lastHeight = newHeight;
                    panel._lastWidth = newWidth;
                });
                window.addEventListener('mouseup', function() {
                    if (dragging) {
                        dragging = false;
                        document.body.style.userSelect = '';
                    }
                });
            })();
            // Â∑¶‰∏ãËßíÊãâ‰º∏
            (function() {
                const panel = document.getElementById('info-panel');
                const resizer = document.getElementById('info-panel-corner-resizer-left');
                let startY, startX, startHeight, startWidth, dragging = false;
                resizer.addEventListener('mousedown', function(e) {
                    if (panel.classList.contains('collapsed')) return;
                    dragging = true;
                    startY = e.clientY;
                    startX = e.clientX;
                    startHeight = panel.offsetHeight;
                    startWidth = panel.offsetWidth;
                    document.body.style.userSelect = 'none';
                    e.preventDefault();
                });
                window.addEventListener('mousemove', function(e) {
                    if (!dragging) return;
                    let newHeight = startHeight + (e.clientY - startY);
                    let newWidth = startWidth - (e.clientX - startX);
                    newHeight = Math.max(120, Math.min(newHeight, window.innerHeight * 0.9));
                    newWidth = Math.max(220, Math.min(newWidth, window.innerWidth * 0.9));
                    panel.style.height = newHeight + 'px';
                    panel.style.width = newWidth + 'px';
                    panel._lastHeight = newHeight;
                    panel._lastWidth = newWidth;
                });
                window.addEventListener('mouseup', function() {
                    if (dragging) {
                        dragging = false;
                        document.body.style.userSelect = '';
                    }
                });
            })();
            
            // ÁÇπÂáªÂú∞ÂõæÁ©∫ÁôΩÂ§ÑÊó∂ÊòæÁ§∫È§êÂéÖÂàóË°®
            map.addEventListener('click', function(e) {
                // Ê£ÄÊü•ÊòØÂê¶ÁÇπÂáªÁöÑÊòØÂú∞ÂõæÊú¨Ë∫´ËÄå‰∏çÊòØmarker
                if (e.target === map || e.target === map.getContainer()) {
                    currentPoi = null;
                    // Â¶ÇÊûúÂΩìÂâçÊúâÊêúÁ¥¢ÁªìÊûúÔºåÊòæÁ§∫ÊêúÁ¥¢ÁªìÊûúÔºõÂê¶ÂàôÊòæÁ§∫È§êÂéÖÂàóË°®
                    if (currentView === 'search' && currentSearchResults.length > 0) {
                        updateInfoPanel(null, 'search', currentSearchResults);
                    } else {
                        updateInfoPanel(null, 'list');
                    }
                }
            });
        }
        
        // ===================== ‰ø°ÊÅØÈù¢ÊùøÂäüËÉΩ =====================
        let currentPoi = null;
        let currentView = 'list'; // 'list', 'detail', 'stats', 'search'
        let currentSearchResults = []; // Â≠òÂÇ®ÂΩìÂâçÊêúÁ¥¢ÁªìÊûú
        let previousView = 'list'; // Â≠òÂÇ®‰πãÂâçÁöÑËßÜÂõæÁä∂ÊÄÅ
        let currentSearchKeyword = '';
        let currentSearchPage = 0;
        let hasMoreSearchResults = false;
        
        // ===================== ËßÜÂõæÊ∏≤Êüì =====================
        function updateInfoPanel(poi = null, view = 'list', searchResults = []) {
            const panelContent = document.getElementById('info-panel-content');
            
            if (view === 'stats') {
                // ÊòæÁ§∫ÁªüËÆ°‰ø°ÊÅØ
                currentView = 'stats';
                const stats = getRatedPoisStats();
                panelContent.innerHTML = `
                    <div class="info-panel-section">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <h3>üìä ${isLoggedIn ? 'ÊàëÁöÑËØÑÂàÜÁªüËÆ°' : 'ËØÑÂàÜÁªüËÆ°'}</h3>
                            <button class="info-panel-btn" onclick="updateInfoPanel(null, 'list')">È§êÂéÖÂàóË°®</button>
                        </div>
                        <div class="info-panel-stats">
                            <div class="info-panel-stat">
                                <div class="info-panel-stat-value">${stats.total}</div>
                                <div class="info-panel-stat-label">ÊÄªËØÑÂàÜ</div>
                            </div>
                            <div class="info-panel-stat">
                                <div class="info-panel-stat-value">${stats.cities}</div>
                                <div class="info-panel-stat-label">Ê∂âÂèäÂüéÂ∏Ç</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="info-panel-section">
                        <h3>‚≠ê ËØÑÂàÜÂàÜÂ∏É</h3>
                        ${RATE_TYPES.map(type => {
                            const count = stats.rateCounts[type.value] || 0;
                            return `
                                <div class="info-panel-item">
                                    <span class="info-panel-label">${type.value}</span>
                                    <span class="info-panel-value">${count}‰∏™</span>
                                </div>
                            `;
                        }).join('')}
                    </div>
                    
                    <div class="info-panel-section">
                        <h3>üèôÔ∏è ÂüéÂ∏ÇÂàÜÂ∏É</h3>
                        ${Object.entries(stats.cityCounts).map(([city, count]) => `
                            <div class="info-panel-item">
                                <span class="info-panel-label">${city}</span>
                                <span class="info-panel-value">${count}‰∏™</span>
                            </div>
                        `).join('')}
                    </div>
                `;
            } else if (view === 'search') {
                // ÊòæÁ§∫ÊêúÁ¥¢ÁªìÊûú
                currentView = 'search';
                currentSearchResults = searchResults; // ‰øùÂ≠òÂΩìÂâçÊêúÁ¥¢ÁªìÊûú
                const keyword = currentSearchKeyword || document.getElementById('keyword').value.trim();
                panelContent.innerHTML = `
                    <div class="info-panel-section">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <h3>üîç ÊêúÁ¥¢ÁªìÊûú</h3>
                            <div>
                                <button class="info-panel-btn" onclick="goToMyRestaurants()">${isLoggedIn ? 'ÊàëÁöÑÈ§êÂéÖ' : 'È§êÂéÖËØÑÂàÜ'}</button>
                            </div>
                        </div>
                        <h4>ÂÖ≥ÈîÆËØç: "${keyword}" (${searchResults.length}‰∏™ÁªìÊûú)</h4>
                    </div>
                    <div class="info-panel-section flex-grow">
                        <div class="restaurant-list">
                            ${searchResults.length > 0 ? searchResults.map(poi => {
                                const title = getPoiField(poi, ['title', 'name']);
                                const shortTitle = getShortTitle(title);
                                const city = getPoiField(poi, ['city', 'cityname']);
                                const area = getPoiField(poi, ['area', 'areaname', 'district']);
                                const address = getPoiField(poi, ['address', 'addr']);
                                const ratedPoi = window.ratedPois.find(rp => rp.uid === poi.uid);
                                const rateType = ratedPoi ? RATE_TYPES.find(t => t.value === ratedPoi.rate) : null;
                                return `
                                    <div class="restaurant-item" onclick="showSearchResultDetail('${poi.uid}')">
                                        <div class="restaurant-header">
                                            <span class="restaurant-name">${shortTitle || title || ''}</span>
                                            ${ratedPoi ? `<span class="restaurant-rate" style="color: ${rateType?.drop || '#666'}">${ratedPoi.rate}</span>` : ''}
                                        </div>
                                        <div class="restaurant-location">${city || ''}${area ? ' ¬∑ ' + area : ''}</div>
                                        <div class="restaurant-address">${address || ''}</div>
                                    </div>
                                `;
                            }).join('') : '<div style="text-align: center; color: #999; padding: 20px;">Êú™ÊâæÂà∞Áõ∏ÂÖ≥ÁªìÊûú</div>'}
                        </div>
                        ${hasMoreSearchResults ? `
                        <div style="margin-top: 12px; text-align: center;">
                            <button class="info-panel-btn" onclick="loadMoreSearchResults()" style="background: #52c41a; color: #fff;">Âä†ËΩΩÊõ¥Â§öÁªìÊûú</button>
                        </div>
                        ` : ''}
                    </div>
                `;
            } else if (view === 'list') {
                // ÊòæÁ§∫È§êÂéÖÂàóË°®
                currentView = 'list';
                const filteredPois = getFilteredRatedPois();
                
                panelContent.innerHTML = `
                    <div class="info-panel-section">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <h3>üçΩÔ∏è ${isLoggedIn ? 'ÊàëÁöÑÈ§êÂéÖ' : 'È§êÂéÖËØÑÂàÜ'}</h3>
                            <button class="info-panel-btn" onclick="updateInfoPanel(null, 'stats')">ÁªüËÆ°</button>
                        </div>
                        
                        <div class="filter-bar ${filterBarExpanded ? 'expanded' : ''}" id="filter-bar">
                            <div class="filter-bar-header" onclick="toggleFilterBar()">
                                <div class="filter-bar-title">
                                    üîç Á≠õÈÄâÊù°‰ª∂
                                    <span class="filter-summary">${getFilterSummary()}</span>
                                </div>
                                <div class="filter-bar-toggle">‚ñº</div>
                            </div>
                            <div class="filter-bar-content">
                                <div class="filter-section">
                                    <div class="filter-section-title">
                                        ‚≠ê ËØÑÂàÜÁ≠õÈÄâ
                                    </div>
                                    <div class="filter-section-content">
                                        ${RATE_TYPES.map(type => `
                                            <div class="filter-checkbox-container" onclick="toggleRateFilter('${type.value}')">
                                                <input type="checkbox" class="rate-filter" value="${type.value}" ${listFilterState[type.value] ? 'checked' : ''} onclick="event.stopPropagation(); toggleRateFilter('${type.value}');">
                                                <span>${type.value}</span>
                                            </div>
                                        `).join('')}
                                    </div>
                                    <div class="filter-actions">
                                        <button class="info-panel-btn" onclick="selectAllRateFilters()">ÂÖ®ÈÄâ</button>
                                        <button class="info-panel-btn" onclick="clearAllRateFilters()">ÂÖ®‰∏çÈÄâ</button>
                                    </div>
                                </div>
                                
                                <div class="filter-section">
                                    <div class="filter-section-title">
                                        üë§ Áî®Êà∑Á≠õÈÄâ
                                    </div>
                                    <div class="filter-section-content">
                                        ${Object.keys(userFilterState).map(user => `
                                            <div class="filter-checkbox-container" onclick="toggleUserFilter('${user}')">
                                                <input type="checkbox" class="user-filter" value="${user}" ${userFilterState[user] !== null ? 'checked' : ''} onclick="event.stopPropagation(); toggleUserFilter('${user}');">
                                                <span>${user}</span>
                                            </div>
                                        `).join('')}
                                    </div>
                                    <div class="filter-actions">
                                        <button class="info-panel-btn" onclick="selectAllUserFilters()">ÂÖ®ÈÄâ</button>
                                        <button class="info-panel-btn" onclick="clearAllUserFilters()">ÂÖ®‰∏çÈÄâ</button>
                                    </div>
                                </div>
                                
                                <!-- È¢ÑÁïôË∑ùÁ¶ªÁ≠õÈÄâ‰ΩçÁΩÆ -->
                                <div class="filter-section" style="display: none;">
                                    <div class="filter-section-title">
                                        üìç Ë∑ùÁ¶ªÁ≠õÈÄâ
                                    </div>
                                    <div class="filter-section-content">
                                        <div style="color: #999; font-size: 12px;">Ë∑ùÁ¶ªÁ≠õÈÄâÂäüËÉΩÂºÄÂèë‰∏≠...</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="info-panel-section">
                            <h4>È§êÂéÖÂàóË°® (${filteredPois.length}‰∏™)</h4>
                            <div class="restaurant-list">
                                ${filteredPois.length > 0 ? filteredPois.map(poi => {
                                    const rateType = RATE_TYPES.find(t => t.value === poi.rate);
                                    return `
                                        <div class="restaurant-item" onclick="showRestaurantDetail('${poi.uid}')">
                                            <div class="restaurant-header">
                                                <span class="restaurant-name">${poi.shortTitle || poi.title}</span>
                                                <span class="restaurant-rate" style="color: ${rateType?.drop || '#666'}">${poi.rate}</span>
                                            </div>
                                            <div class="restaurant-location">${poi.city || ''}${poi.area ? ' ¬∑ ' + poi.area : ''}</div>
                                            <div class="restaurant-address">${poi.address || ''}</div>
                                        </div>
                                    `;
                                }).join('') : '<div style="text-align: center; color: #999; padding: 20px;">ÊöÇÊó†ËØÑÂàÜÈ§êÂéÖ</div>'}
                            </div>
                            ${filteredPois.length > 0 ? `
                            <div style="margin-top: 12px; text-align: center;">
                                ${!isLoggedIn ? `
                                    <button class="info-panel-btn" onclick="showModal('login-modal')" style="background: #1b8eec; color: #fff;">ÁôªÂΩïÂêéÁÆ°ÁêÜËØÑÂàÜ</button>
                                ` : `
                                    <button class="info-panel-btn" onclick="clearAllRatedPois()" style="background: #ff4d4f; color: #fff;">Ê∏ÖÈô§ÊâÄÊúâËØÑÂàÜ</button>
                                `}
                            </div>
                            ` : ''}
                        </div>
                    </div>
                `;
                

                
            } else if (poi) {
                // ÈÄâÂÆöÈ§êÂéÖËá™Âä®Áº©ÊîæÂà∞ÂØπÂ∫î‰ΩçÁΩÆ
                if (poi.point) {
                    map.centerAndZoom(new BMapGL.Point(poi.point.lng, poi.point.lat), GLOBAL_DEFAULT_ZOOM);
                }
                // ÊòæÁ§∫POIËØ¶ÁªÜ‰ø°ÊÅØ
                previousView = currentView; // ‰øùÂ≠ò‰πãÂâçÁöÑËßÜÂõæ
                currentView = 'detail';
                currentPoi = poi;
                const title = getPoiField(poi, ['title', 'name']);
                const shortTitle = getShortTitle(title);
                const city = getPoiField(poi, ['city', 'cityname']);
                const area = getPoiField(poi, ['area', 'areaname', 'district']);
                const address = getPoiField(poi, ['address', 'addr']);
                const phoneNumber = getPoiField(poi, ['phoneNumber', 'phone', 'tel']);
                const tags = getPoiField(poi, ['tags', 'std_tag', 'tag']) || [];
                const tagArray = Array.isArray(tags) ? tags : (typeof tags === 'string' ? tags.split(',').map(t => t.trim()) : []);
                
                // Ê£ÄÊü•ÊòØÂê¶Â∑≤ËØÑÂàÜ
                const ratedPoi = window.ratedPois.find(rp => rp.uid === poi.uid);
                
                panelContent.innerHTML = `
                    <div class="info-panel-section">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <h3>üìç È§êÂéÖËØ¶ÊÉÖ</h3>
                            <button class="info-panel-btn" onclick="goBackFromDetail()">ËøîÂõû</button>
                        </div>
                        
                        <div class="info-panel-item">
                            <span class="info-panel-label">ÂêçÁß∞</span>
                            <span class="info-panel-value">${shortTitle || title || ''}</span>
                        </div>
                        <div class="info-panel-item">
                            <span class="info-panel-label">‰ΩçÁΩÆ</span>
                            <span class="info-panel-value">${city || ''}${area ? ' ¬∑ ' + area : ''}</span>
                        </div>
                        <div class="info-panel-item">
                            <span class="info-panel-label">Âú∞ÂùÄ</span>
                            <span class="info-panel-value">${address || ''}</span>
                        </div>
                        ${phoneNumber ? `
                        <div class="info-panel-item">
                            <span class="info-panel-label">ÁîµËØù</span>
                            <span class="info-panel-value">${phoneNumber}</span>
                        </div>
                        ` : ''}
                        ${tagArray.length > 0 ? `
                        <div class="info-panel-item">
                            <span class="info-panel-label">Ê†áÁ≠æ</span>
                            <div class="info-panel-tags">
                                ${tagArray.map(tag => `<span class="info-panel-tag">${tag}</span>`).join('')}
                            </div>
                        </div>
                        ` : ''}
                    </div>
                    
                    <div class="info-panel-section">
                        <h3>‚≠ê ËØÑÂàÜÊìç‰Ωú</h3>
                        ${!isLoggedIn ? `
                            <div style="text-align: center; padding: 20px; background: #f8f9fa; border-radius: 8px; margin-bottom: 12px;">
                                <div style="color: #666; margin-bottom: 12px;">ËØ∑ÂÖàÁôªÂΩïÊâçËÉΩËøõË°åËØÑÂàÜ</div>
                                <button class="info-panel-btn" onclick="showModal('login-modal')" style="background: #1b8eec; color: #fff;">Á´ãÂç≥ÁôªÂΩï</button>
                            </div>
                        ` : `
                            ${ratedPoi ? `
                                <div class="info-panel-item">
                                    <span class="info-panel-label">ÂΩìÂâçËØÑÂàÜ</span>
                                    <span class="info-panel-value" style="color: ${RATE_TYPES.find(t => t.value === ratedPoi.rate)?.drop || '#666'}">${ratedPoi.rate}</span>
                                </div>
                            ` : `
                                <div class="info-panel-item">
                                    <span class="info-panel-label">ÂΩìÂâçËØÑÂàÜ</span>
                                    <span class="info-panel-value" style="color: #999;">Êú™ËØÑÂàÜ</span>
                                </div>
                            `}
                            <div style="margin-top: 12px;">
                                ${RATE_TYPES.map(t => `
                                    <button class="info-panel-btn rate-btn" data-rate="${t.value}" style="background:${t.drop};color:${t.star === 'black' ? '#000' : '#fff'};margin-right:8px;margin-bottom:8px;">${t.value}</button>
                                `).join('')}
                                ${ratedPoi ? `
                                    <button class="info-panel-btn" id="remove-rate-btn" style="background:#bbb;color:#fff;margin-bottom:8px;">ÂèñÊ∂àËØÑ‰ª∑</button>
                                ` : ''}
                            </div>
                        `}
                    </div>
                    
                    <div class="info-panel-section">
                        <h3>üìç ÂùêÊ†á‰ø°ÊÅØ</h3>
                        <div class="info-panel-item">
                            <span class="info-panel-label">ÁªèÂ∫¶</span>
                            <span class="info-panel-value">${poi.point ? poi.point.lng.toFixed(6) : ''}</span>
                        </div>
                        <div class="info-panel-item">
                            <span class="info-panel-label">Á∫¨Â∫¶</span>
                            <span class="info-panel-value">${poi.point ? poi.point.lat.toFixed(6) : ''}</span>
                        </div>
                    </div>
                `;
                
                // ÁÆÄÂåñÔºöÁõ¥Êé•ÁªëÂÆöËØÑÂàÜÊåâÈíÆ‰∫ã‰ª∂Ôºå‰∏ç‰ΩøÁî®Âª∂Ëøü
                const rateBtns = panelContent.querySelectorAll('.rate-btn');
                const removeBtn = panelContent.querySelector('#remove-rate-btn');
                
                rateBtns.forEach(btn => {
                    btn.onclick = async function() {
                        if (!isLoggedIn) {
                            showModal('login-modal');
                            return;
                        }
                        const rate = btn.getAttribute('data-rate');
                        await addOrUpdateRatedPoi(poi, rate);
                    }
                });
                
                if (removeBtn) {
                    removeBtn.onclick = async function() {
                        if (!isLoggedIn) {
                            showModal('login-modal');
                            return;
                        }
                        await removeRatedPoi(poi.uid);
                    }
                }
            }
        }
        
        function getRatedPoisStats() {
            const stats = {
                total: window.ratedPois.length,
                cities: new Set(window.ratedPois.map(p => p.city).filter(c => c)).size,
                rateCounts: {},
                cityCounts: {}
            };
            
            window.ratedPois.forEach(poi => {
                // ÁªüËÆ°ËØÑÂàÜÂàÜÂ∏É
                stats.rateCounts[poi.rate] = (stats.rateCounts[poi.rate] || 0) + 1;
                
                // ÁªüËÆ°ÂüéÂ∏ÇÂàÜÂ∏É
                if (poi.city) {
                    stats.cityCounts[poi.city] = (stats.cityCounts[poi.city] || 0) + 1;
                }
            });
            
            return stats;
        }
        
        // ‰øùÂ≠òÁ≠õÈÄâÂô®Áä∂ÊÄÅ
        let listFilterState = {
            'Ë∂ÖÁà±': true,
            'ÂñúÊ¨¢': true,
            '‰∏ÄËà¨': true,
            '‰∏ç‰ºöÂÜçÂéª‰∫Ü': true
        };
        
        // ‰øùÂ≠òÁî®Êà∑Á≠õÈÄâÂô®Áä∂ÊÄÅ - Êò†Â∞ÑÊòæÁ§∫ÂêçÁß∞Âà∞Áî®Êà∑ID
        let userFilterState = {
            'Ëá™Â∑±': currentUser ? currentUser.id : null
        };
        
        // Áî®Êà∑Á≠õÈÄâÂô®ÊòæÁ§∫ÂêçÁß∞Âà∞Áî®Êà∑IDÁöÑÊò†Â∞Ñ
        let userFilterMapping = {
            'Ëá™Â∑±': currentUser ? currentUser.id : null
        };
        
        // ‰øùÂ≠òÁ≠õÈÄâÊù°Â±ïÂºÄÁä∂ÊÄÅ
        let filterBarExpanded = false;
        
        function getFilteredRatedPois() {
            // ‰ΩøÁî®‰øùÂ≠òÁöÑÁä∂ÊÄÅËøõË°åÁ≠õÈÄâÔºå‰∏çÂÜç‰ªéDOMËØªÂèñ
            const checkedRates = Object.keys(listFilterState).filter(key => listFilterState[key]);
            const checkedUserIds = Object.values(userFilterState).filter(userId => userId !== null);
            
            // ÂÖàÊåâËØÑÂàÜÁ≠õÈÄâ
            let filteredPois = window.ratedPois.filter(poi => checkedRates.includes(poi.rate));
            
            // ÂÜçÊåâÁî®Êà∑IDÁ≠õÈÄâ
            if (checkedUserIds.length > 0) {
                filteredPois = filteredPois.filter(poi => poi.user_id && checkedUserIds.includes(poi.user_id));
            } else {
                // Â¶ÇÊûúÊ≤°ÊúâÈÄâ‰∏≠‰ªª‰ΩïÁî®Êà∑ÔºåÂàô‰∏çÊòæÁ§∫‰ªª‰ΩïÊï∞ÊçÆ
                filteredPois = [];
            }
            
            // ÊåâÁÖßRATE_TYPESÁöÑÈ°∫Â∫èËøõË°åÊéíÂ∫èÔºåÁ°Æ‰øù‰∏éÁ≠õÈÄâÂô®È°∫Â∫è‰∏ÄËá¥
            const sortedPois = filteredPois.sort((a, b) => {
                const indexA = RATE_TYPES.findIndex(t => t.value === a.rate);
                const indexB = RATE_TYPES.findIndex(t => t.value === b.rate);
                return indexA - indexB;
            });
            
            return sortedPois;
        }
        
        // Á≠õÈÄâÊù°Áõ∏ÂÖ≥ÂáΩÊï∞
        window.toggleFilterBar = function() {
            filterBarExpanded = !filterBarExpanded;
            const filterBar = document.getElementById('filter-bar');
            if (filterBar) {
                if (filterBarExpanded) {
                    filterBar.classList.add('expanded');
                } else {
                    filterBar.classList.remove('expanded');
                }
            }
        };
        
        function getFilterSummary() {
            const checkedRates = Object.keys(listFilterState).filter(key => listFilterState[key]);
            const checkedUsers = Object.keys(userFilterState).filter(key => userFilterState[key] !== null);
            return `${checkedRates.length}‰∏™ËØÑÂàÜÁ±ªÂûã, ${checkedUsers.length}‰∏™Áî®Êà∑`;
        }
        
        // ËØÑÂàÜÁ≠õÈÄâÁõ∏ÂÖ≥ÂáΩÊï∞
        window.selectAllRateFilters = function() {
            RATE_TYPES.forEach(type => {
                listFilterState[type.value] = true;
            });
            updateInfoPanel(null, 'list');
            renderRatedMarkers();
        };
        
        window.clearAllRateFilters = function() {
            RATE_TYPES.forEach(type => {
                listFilterState[type.value] = false;
            });
            updateInfoPanel(null, 'list');
            renderRatedMarkers();
        };
        
        window.toggleRateFilter = function(value) {
            listFilterState[value] = !listFilterState[value];
            updateInfoPanel(null, 'list');
            renderRatedMarkers();
        };
        
        // Áî®Êà∑Á≠õÈÄâÁõ∏ÂÖ≥ÂáΩÊï∞
        window.selectAllUserFilters = function() {
            Object.keys(userFilterState).forEach(user => {
                userFilterState[user] = userFilterMapping[user];
            });
            updateInfoPanel(null, 'list');
            renderRatedMarkers();
        };
        
        window.clearAllUserFilters = function() {
            Object.keys(userFilterState).forEach(user => {
                userFilterState[user] = null;
            });
            updateInfoPanel(null, 'list');
            renderRatedMarkers();
        };
        
        window.toggleUserFilter = function(value) {
            // Â¶ÇÊûúÁî®Êà∑Êú™ÁôªÂΩïÔºåÊòæÁ§∫ÁôªÂΩïÊèêÁ§∫
            if (!isLoggedIn || !currentUser) {
                showModal('login-modal');
                return;
            }
            
            // Á°Æ‰øùÊò†Â∞ÑÂ≠òÂú®
            if (!userFilterMapping[value]) {
                userFilterMapping[value] = currentUser.id;
            }
            
            if (userFilterState[value] === userFilterMapping[value]) {
                userFilterState[value] = null; // ÂèñÊ∂àÈÄâ‰∏≠
            } else {
                userFilterState[value] = userFilterMapping[value]; // ÈÄâ‰∏≠
            }
            
            updateInfoPanel(null, 'list');
            renderRatedMarkers();
        };
        
        // ÂÖºÂÆπÊóßÂáΩÊï∞Âêç
        window.selectAllFilters = window.selectAllRateFilters;
        window.clearAllFilters = window.clearAllRateFilters;
        window.toggleFilter = window.toggleRateFilter;
        
        window.showRestaurantDetail = function(uid) {
            const poi = window.ratedPois.find(p => p.uid === uid);
            if (poi) {
                updateInfoPanel(poi, 'detail');
            }
        };
        
        window.clearAllRatedPois = async function() {
            // Ê£ÄÊü•Áî®Êà∑ÊòØÂê¶Â∑≤ÁôªÂΩï
            if (!isLoggedIn) {
                showModal('login-modal');
                return;
            }
            
            if (confirm('Á°ÆÂÆöË¶ÅÊ∏ÖÈô§ÊâÄÊúâËØÑÂàÜÂêóÔºü')) {
                try {
                    // ‰ªéSupabaseÂà†Èô§ÊâÄÊúâËØÑÂàÜ
                    const { error } = await supabase
                        .from('restaurant_reviews')
                        .delete()
                        .eq('user_id', currentUser.id);
                    
                    if (error) {
                        console.error('Ê∏ÖÈô§ÊâÄÊúâËØÑÂàÜÈîôËØØ:', error);
                        alert('Ê∏ÖÈô§ËØÑÂàÜÂ§±Ë¥•ÔºåËØ∑ÈáçËØï');
                        return;
                    }
                    
                    // Êõ¥Êñ∞Êú¨Âú∞Êï∞ÊçÆ
                    window.ratedPois = [];
                    renderRatedMarkers();
                    updateInfoPanel(null, 'list');
                } catch (error) {
                    console.error('Ê∏ÖÈô§ÊâÄÊúâËØÑÂàÜÂ§±Ë¥•:', error);
                    alert('Ê∏ÖÈô§ËØÑÂàÜÂ§±Ë¥•ÔºåËØ∑ÈáçËØï');
                }
            }
        };
        
        window.showSearchResultDetail = function(uid) {
            // ‰ªéÂΩìÂâçÊêúÁ¥¢ÁªìÊûú‰∏≠Êü•ÊâæÂØπÂ∫îÁöÑPOI
            const poi = currentSearchResults.find(p => p.uid === uid);
            if (poi) {
                updateInfoPanel(poi, 'detail');
            }
        };
        
        window.goBackFromDetail = function() {
            // Ê†πÊçÆ‰πãÂâçÁöÑËßÜÂõæÂÜ≥ÂÆöËøîÂõûÂà∞Âì™Èáå
            if (previousView === 'search' && currentSearchResults.length > 0) {
                updateInfoPanel(null, 'search', currentSearchResults);
            } else {
                updateInfoPanel(null, 'list');
            }
        };
        
        window.loadMoreSearchResults = function() {
            currentSearchPage++;
            localSearch.gotoPage(currentSearchPage);
        };
        
        window.goToMyRestaurants = function() {
            // Ê∏ÖÁ©∫ÊêúÁ¥¢Áõ∏ÂÖ≥Áä∂ÊÄÅ
            currentSearchResults = [];
            currentSearchKeyword = '';
            currentSearchPage = 0;
            hasMoreSearchResults = false;
            // Ê∏ÖÈô§Âú∞Âõæ‰∏äÁöÑÊêúÁ¥¢Ê†áËÆ∞
            clearPoiMarkers();
            // ÈáçÁΩÆÂà∞ÊòæÁ§∫ÊâÄÊúâËØÑÂàÜÈ§êÂéÖÁöÑËßÜÂõæËåÉÂõ¥
            updateMapViewportForRatedPois();
            // ‰ø°ÊÅØÈù¢ÊùøÂõûÂà∞È§êÂéÖÂàóË°®
            updateInfoPanel(null, 'list');
        };
        
        // ===================== ËæÖÂä©ÂäüËÉΩ =====================
        // Âú®ÊéßÂà∂Âè∞Êü•ÁúãËØÑÂàÜÊï∞ÊçÆ
        window.showRatedPois = function() {
            console.log('ÂΩìÂâçËØÑÂàÜPOIÂàóË°®:', window.ratedPois);
            console.log('localStorage‰∏≠ÁöÑËØÑÂàÜÊï∞ÊçÆ:', localStorage.getItem('ratedPois'));
        };
        
        // Âú®ÊéßÂà∂Âè∞Êü•ÁúãÁ≠õÈÄâÂô®Áä∂ÊÄÅ
        window.showFilterState = function() {
            console.log('ËØÑÂàÜÁ≠õÈÄâÂô®Áä∂ÊÄÅ:', listFilterState);
            console.log('Áî®Êà∑Á≠õÈÄâÂô®Áä∂ÊÄÅ:', userFilterState);
            console.log('Áî®Êà∑Á≠õÈÄâÂô®Êò†Â∞Ñ:', userFilterMapping);
            console.log('ÂΩìÂâçÁî®Êà∑:', currentUser);
            console.log('ÂΩìÂâçËßÜÂõæ:', currentView);
            console.log('Á≠õÈÄâÂêéÁöÑÈ§êÂéÖÊï∞Èáè:', getFilteredRatedPois().length);
            console.log('ÊÄªÈ§êÂéÖÊï∞Èáè:', window.ratedPois.length);
            console.log('ËØÑÂàÜÊï∞ÊçÆ:', window.ratedPois);
        };
        

        
        // Ê∏ÖÁêÜlocalStorage
        window.clearLocalStorage = function() {
            if (confirm('Á°ÆÂÆöË¶ÅÊ∏ÖÁêÜlocalStorage‰∏≠ÁöÑÊâÄÊúâÊï∞ÊçÆÂêóÔºü')) {
                localStorage.clear();
                console.log('localStorageÂ∑≤Ê∏ÖÁêÜ');
            }
        };
        
        // ===================== È°µÈù¢ÂÖ•Âè£ =====================
        window.onload = async function() {
            // Âä†ËΩΩÁî®Êà∑‰ºöËØù
            loadUserSession();
            
            // ÂàùÂßãÂåñÁî®Êà∑Á≠õÈÄâÁä∂ÊÄÅ
            if (isLoggedIn && currentUser) {
                userFilterState['Ëá™Â∑±'] = currentUser.id;
                userFilterMapping['Ëá™Â∑±'] = currentUser.id;
            }
            
            // ÂàùÂßãÂåñÂú∞Âõæ
            initMap();
            bindUIEvents();
            bindAuthEvents(); // ÁªëÂÆöËÆ§ËØÅÁõ∏ÂÖ≥‰∫ã‰ª∂
            
            // Â¶ÇÊûúÁî®Êà∑Â∑≤ÁôªÂΩïÔºåÂä†ËΩΩËØÑÂàÜÊï∞ÊçÆ
            if (isLoggedIn) {
                await loadRatedPois();
                renderRatedMarkers();
                updateMapViewportForRatedPois();
            }
            
            // ÂàùÂßãÂåñ‰ø°ÊÅØÈù¢ÊùøÔºåÊòæÁ§∫È§êÂéÖÂàóË°®
            updateInfoPanel(null, 'list');
            
            // Á°Æ‰øù‰ø°ÊÅØÈù¢ÊùøÈªòËÆ§Â±ïÂºÄÊòæÁ§∫
            document.getElementById('info-panel').classList.remove('collapsed');
            
            // Â¶ÇÊûúÁî®Êà∑Êú™ÁôªÂΩïÔºåÊòæÁ§∫ÁôªÂΩïÊèêÁ§∫
            if (!isLoggedIn) {
                setTimeout(() => {
                    const panelContent = document.getElementById('info-panel-content');
                    const loginTipDiv = document.createElement('div');
                    loginTipDiv.style.cssText = 'background: #fff3cd; color: #856404; padding: 12px; border-radius: 6px; margin-bottom: 16px; text-align: center;';
                    loginTipDiv.innerHTML = 'ËØ∑ÂÖà <button onclick="showModal(\'login-modal\')" style="background: #1b8eec; color: #fff; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; margin: 0 4px;">ÁôªÂΩï</button> Êàñ <button onclick="showModal(\'register-modal\')" style="background: #28a745; color: #fff; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; margin: 0 4px;">Ê≥®ÂÜå</button> ÂêéÊâçËÉΩËøõË°åËØÑÂàÜÊìç‰Ωú„ÄÇ';
                    panelContent.insertBefore(loginTipDiv, panelContent.firstChild);
                    setTimeout(() => loginTipDiv.remove(), 8000);
                }, 1000);
            }
            
            // Âú®ÊéßÂà∂Âè∞ÊòæÁ§∫ËæÖÂä©ÂáΩÊï∞
            console.log('ËæÖÂä©ÂáΩÊï∞Â∑≤Âä†ËΩΩ:');
            console.log('- showRatedPois(): Êü•ÁúãËØÑÂàÜÊï∞ÊçÆ');
            console.log('- showFilterState(): Êü•ÁúãÁ≠õÈÄâÂô®Áä∂ÊÄÅ');
            console.log('- clearLocalStorage(): Ê∏ÖÁêÜlocalStorage');
            console.log('- Êåâ I ÈîÆÊàñÁÇπÂáªÊ†áÈ¢òÊ†èÂèØÂàáÊç¢‰ø°ÊÅØÈù¢ÊùøÊòæÁ§∫Áä∂ÊÄÅ');
        }
    </script>
</body>
</html> 