<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>SecretBites</title>
    <style>
        html, body { height: 100%; margin: 0; padding: 0; }
        #map { width: 100vw; height: 100vh; }
        .search-bar {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            background: #fff;
            padding: 10px 20px;
            border-radius: 8px;
            box-shadow: 0 2px 6px 0 rgba(27, 142, 236, 0.2);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .search-bar input {
            font-size: 16px;
            padding: 6px 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            outline: none;
        }
        .search-bar button {
            font-size: 16px;
            padding: 6px 16px;
            background: #1b8eec;
            color: #fff;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .search-bar button:hover {
            background: #156bbd;
        }
        
        .info-panel {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 400px;
            height: 680px;
            min-width: 220px;
            min-height: 48px;
            max-width: 90vw;
            max-height: 90vh;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            margin-top: 60px; /* ä¸ºç”¨æˆ·çŠ¶æ€æ ç•™å‡ºç©ºé—´ */
        }
        
        .info-panel.collapsed {
            width: 48px !important;
            min-width: 48px !important;
            max-width: 48px !important;
            height: 48px !important;
            min-height: 48px !important;
            max-height: 48px !important;
            background: #1b8eec !important;
        }
        .info-panel.collapsed .info-panel-header {
            background: #1b8eec !important;
            padding: 0;
            justify-content: flex-end;
            width: 48px;
        }
        .info-panel.collapsed .info-panel-toggle-btn {
            width: 48px;
            height: 48px;
            justify-content: center;
            z-index: 1001;
        }
        .info-panel.collapsed .info-panel-header span {
            display: none;
        }
        .info-panel.collapsed .info-panel-content {
            display: none !important;
        }
        
        .info-panel-header {
            width: 100%;
            box-sizing: border-box;
            height: 48px;
            line-height: 48px;
            font-size: 16px;
            font-weight: bold;
            border-radius: 8px 8px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            padding: 0 16px;
            background: #1b8eec;
            color: #fff;
            /* transition: opacity 0.2s; */
            position: relative;
        }
        
        .info-panel-header:hover {
            background: #156bbd;
        }
        
        .info-panel-toggle-btn {
            position: absolute;
            top: 0;
            right: 0;
            background: none;
            border: none;
            color: #fff;
            font-size: 22px;
            cursor: pointer;
            padding: 0;
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.3s;
        }
        .info-panel.collapsed .info-panel-toggle-btn {
            transform: rotate(180deg);
        }
        
        .info-panel-handle {
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 40px;
            height: 60px;
            background: #1b8eec;
            border-radius: 8px 0 0 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-size: 16px;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .info-panel.collapsed .info-panel-handle {
            opacity: 1;
        }
        
        .info-panel-handle:hover {
            background: #156bbd;
        }
        
        .info-panel-content {
            padding: 16px;
            overflow-y: auto;
            flex: 1;
            opacity: 1;
            pointer-events: auto;
            display: flex;
            flex-direction: column;
            /* transition: opacity 0.3s; */
        }
        .info-panel.collapsed .info-panel-content {
            opacity: 0;
            pointer-events: none;
        }
        .info-panel-resizer {
            height: 8px;
            cursor: ns-resize;
            background: #f0f0f0;
            width: 100%;
            position: absolute;
            left: 0;
            bottom: 0;
            z-index: 10;
        }
        .info-panel-corner-resizer {
            width: 16px;
            height: 16px;
            position: absolute;
            right: 0;
            bottom: 0;
            cursor: nwse-resize;
            z-index: 11;
            background: transparent;
        }
        .info-panel-corner-resizer:after {
            display: none;
            content: '';
        }
        .info-panel-corner-resizer-left {
            width: 16px;
            height: 16px;
            position: absolute;
            left: 0;
            bottom: 0;
            cursor: nesw-resize;
            z-index: 11;
            background: transparent;
        }
        .info-panel-corner-resizer-left:after {
            display: none;
            content: '';
        }
        
        .info-panel-section {
            margin-bottom: 16px;
        }
        
        .info-panel-section.flex-grow {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .info-panel-section h3 {
            margin: 0 0 8px 0;
            font-size: 14px;
            color: #333;
            font-weight: bold;
        }
        
        .info-panel-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .info-panel-item:last-child {
            border-bottom: none;
        }
        
        .info-panel-label {
            color: #666;
            font-size: 13px;
        }
        
        .info-panel-value {
            color: #333;
            font-size: 13px;
            font-weight: 500;
            text-align: right;
            max-width: 60%;
        }
        
        .info-panel-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            margin-top: 4px;
        }
        
        .info-panel-tag {
            background: #f7c948;
            color: #333;
            border-radius: 12px;
            padding: 2px 8px;
            font-size: 11px;
        }
        
        .info-panel-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }
        
        .info-panel-stat {
            background: #f8f9fa;
            padding: 8px;
            border-radius: 4px;
            text-align: center;
        }
        
        .info-panel-stat-value {
            font-size: 18px;
            font-weight: bold;
            color: #1b8eec;
        }
        
        .info-panel-stat-label {
            font-size: 11px;
            color: #666;
            margin-top: 2px;
        }
        
        .info-panel-btn {
            background: #1b8eec;
            color: #fff;
            border: none;
            border-radius: 4px;
            padding: 6px 12px;
            font-size: 12px;
            cursor: pointer;
            display: inline-block;
            text-align: center;
            min-width: 60px;
            transition: background-color 0.2s ease;
        }
        
        .info-panel-btn:hover {
            background: #156bbd;
        }
        
        .info-panel-btn.rate-btn:hover {
            opacity: 0.8;
        }
        
        .filter-checkbox-container {
            display: inline-block;
            margin-right: 8px;
            margin-bottom: 4px;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            transition: background-color 0.2s ease;
        }
        
        .filter-checkbox-container:hover {
            background: #f0f0f0;
        }
        
        .filter-checkbox-container input[type="checkbox"] {
            margin-right: 4px;
            cursor: pointer;
        }
        
        .filter-checkbox-container span {
            font-size: 12px;
            cursor: pointer;
            user-select: none;
        }
        
        /* ç­›é€‰æ¡æ ·å¼ */
        .filter-bar {
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 16px;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        .filter-bar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: #e9ecef;
            cursor: pointer;
            user-select: none;
            transition: background-color 0.2s ease;
        }
        
        .filter-bar-header:hover {
            background: #dee2e6;
        }
        
        .filter-bar-title {
            font-size: 14px;
            font-weight: 500;
            color: #333;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .filter-bar-toggle {
            font-size: 16px;
            color: #666;
            transition: transform 0.3s ease;
        }
        
        .filter-bar.expanded .filter-bar-toggle {
            transform: rotate(180deg);
        }
        
        .filter-bar-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }
        
        .filter-bar.expanded .filter-bar-content {
            max-height: 500px;
        }
        
        .filter-section {
            padding: 16px;
            border-bottom: 1px solid #e9ecef;
        }
        
        .filter-section:last-child {
            border-bottom: none;
        }
        
        .filter-section-title {
            font-size: 13px;
            font-weight: 500;
            color: #333;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .filter-section-content {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .filter-actions {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }
        
        .filter-summary {
            font-size: 12px;
            color: #666;
            margin-left: auto;
        }
        
        .restaurant-list {
            max-height: none;
            overflow-y: auto;
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }
        
        .restaurant-item {
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            user-select: none;
            flex-shrink: 0;
        }
        
        .restaurant-item:hover {
            border-color: #1b8eec;
            background: #f8f9fa;
        }
        
        .restaurant-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }
        
        .restaurant-name {
            font-weight: bold;
            font-size: 13px;
            color: #333;
        }
        
        .restaurant-rate {
            font-size: 11px;
            font-weight: bold;
        }
        
        .restaurant-rate-container {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .friend-badge {
            font-size: 10px;
            color: #666;
            background: rgba(255,192,203,0.85);
            padding: 1px 4px;
            border-radius: 3px;
            border: none;
        }
        
        .info-panel-value-container {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .restaurant-location {
            font-size: 11px;
            color: #666;
            margin-bottom: 2px;
        }
        
        .restaurant-address {
            font-size: 11px;
            color: #999;
            line-height: 1.3;
        }
        .info-panel.collapsed .info-panel-resizer,
        .info-panel.collapsed .info-panel-corner-resizer,
        .info-panel.collapsed .info-panel-corner-resizer-left {
            display: none !important;
            background: transparent !important;
            height: 0 !important;
            border: none !important;
            box-shadow: none !important;
        }
        
        /* ç”¨æˆ·çŠ¶æ€æ æ ·å¼ */
        .user-status-bar {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1001;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 6px 0 rgba(27, 142, 236, 0.2);
            padding: 8px 12px;
            min-width: 120px;
            transition: all 0.3s ease;
        }
        
        .user-status-bar:hover {
            box-shadow: 0 4px 12px 0 rgba(27, 142, 236, 0.3);
            transform: translateY(-1px);
        }
        
        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .user-status-bar {
                top: 10px;
                right: 10px;
                padding: 6px 8px;
                min-width: 100px;
            }
            
            .info-panel {
                margin-top: 50px;
                right: 10px;
                width: calc(100vw - 20px);
                max-width: 400px;
            }
            
            .user-info {
                gap: 4px;
            }
            
            .login-btn, .register-btn {
                padding: 4px 8px;
                font-size: 12px;
            }
            
            .logout-btn {
                padding: 3px 6px;
                font-size: 11px;
            }
        }
        
        @media (max-width: 480px) {
            .user-status-bar {
                min-width: 80px;
                padding: 4px 6px;
            }
            
            .user-status-logged-out {
                gap: 4px;
            }
            
            .login-btn, .register-btn {
                padding: 3px 6px;
                font-size: 11px;
            }
            
            .user-nickname {
                font-size: 12px;
            }
            
            /* åœ¨è¶…å°å±å¹•ä¸Šè°ƒæ•´å­—ä½“å¤§å° */
            .login-btn,
            .register-btn,
            .user-nickname,
            .logout-btn {
                font-size: 11px;
            }
        }
        
        .user-status-logged-out {
            display: flex;
            gap: 8px;
        }
        
        .login-btn, .register-btn {
            font-size: 14px;
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s ease;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .login-btn {
            background: #1b8eec;
            color: #fff;
        }
        
        .login-btn:hover {
            background: #156bbd;
        }
        
        .register-btn {
            background: #28a745;
            color: #fff;
        }
        
        .register-btn:hover {
            background: #218838;
        }
        
        .user-status-logged-in {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .user-nickname {
            font-size: 14px;
            color: #333;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .logout-btn {
            font-size: 12px;
            padding: 4px 8px;
            background: #dc3545;
            color: #fff;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 2px;
        }
        
        .logout-btn:hover {
            background: #c82333;
        }
        
        .friends-btn {
            font-size: 12px;
            padding: 4px 8px;
            background: #1b8eec;
            color: #fff;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 2px;
            margin-left: 8px;
        }
        
        .friends-btn:hover {
            background: #40a9ff;
        }
        
        .profile-btn {
            font-size: 12px;
            padding: 4px 8px;
            background: #28a745;
            color: #fff;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 2px;
            margin-left: 8px;
        }
        
        .profile-btn:hover {
            background: #34ce57;
        }
        
        /* æ¬¢è¿å¼¹çª—æ ·å¼ */
        .welcome-content {
            text-align: center;
        }
        
        .welcome-intro {
            margin-bottom: 20px;
        }
        
        .welcome-actions {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 20px;
        }
        
        .welcome-btn {
            width: 100%;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .welcome-btn.primary {
            background: #ffc107;
            color: #000;
        }
        
        .welcome-btn.primary:hover {
            background: #e0a800;
        }
        
        .welcome-btn.secondary {
            background: #1b8eec;
            color: #fff;
        }
        
        .welcome-btn.secondary:hover {
            background: #156bbd;
        }
        
        .welcome-btn.tertiary {
            background: #28a745;
            color: #fff;
        }
        
        .welcome-btn.tertiary:hover {
            background: #218838;
        }
        
        .demo-account-info {
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 16px;
            margin: 20px 0;
            text-align: left;
        }
        
        .demo-account-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .demo-account-item:last-child {
            margin-bottom: 0;
        }
        
        .demo-label {
            font-size: 14px;
            color: #666;
            font-weight: 500;
        }
        
        .demo-value {
            font-size: 14px;
            color: #333;
            font-weight: 600;
            font-family: 'Courier New', monospace;
            background: #fff;
            padding: 4px 8px;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
        
        /* è®¤è¯æ¨¡æ€æ¡†æ ·å¼ */
        .auth-modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(2px);
        }
        
        .auth-modal-content {
            background-color: #fff;
            margin: 5% auto;
            padding: 0;
            border-radius: 12px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s ease-out;
        }
        
        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .auth-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px 16px;
            border-bottom: 1px solid #e9ecef;
        }
        
        .auth-modal-header h2 {
            margin: 0;
            font-size: 20px;
            color: #333;
            font-weight: 600;
        }
        
        .auth-modal-close {
            background: none;
            border: none;
            font-size: 24px;
            color: #999;
            cursor: pointer;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background-color 0.2s ease;
        }
        
        .auth-modal-close:hover {
            background-color: #f8f9fa;
            color: #666;
        }
        
        .auth-modal-body {
            padding: 24px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-size: 14px;
            color: #333;
            font-weight: 500;
        }
        
        .form-group input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.2s ease;
            box-sizing: border-box;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: #1b8eec;
        }
        
        .form-hint {
            display: block;
            margin-top: 4px;
            font-size: 12px;
            color: #666;
        }
        
        .form-actions {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 24px;
        }
        
        .auth-submit-btn {
            width: 100%;
            padding: 12px;
            background: #1b8eec;
            color: #fff;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        
        .auth-submit-btn:hover {
            background: #156bbd;
        }
        
        /* å¥½å‹ç®¡ç†æ ·å¼ */
        .friends-tabs {
            display: flex;
            border-bottom: 1px solid #e9ecef;
            margin-bottom: 20px;
        }
        
        .friends-tab {
            background: none;
            border: none;
            padding: 12px 20px;
            cursor: pointer;
            font-size: 14px;
            color: #666;
            border-bottom: 2px solid transparent;
            transition: all 0.2s ease;
        }
        
        .friends-tab.active {
            color: #1b8eec;
            border-bottom-color: #1b8eec;
        }
        
        .friends-tab:hover {
            color: #1b8eec;
        }
        
        .friends-tab-content {
            display: none;
        }
        
        .friends-tab-content.active {
            display: block;
        }
        
        .friends-list, .friend-requests-list {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .friend-item {
            display: flex;
            align-items: center;
            padding: 12px;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            margin-bottom: 8px;
            background: #f8f9fa;
        }
        
        .friend-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #1b8eec;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 12px;
        }
        
        .friend-info {
            flex: 1;
        }
        
        .friend-name {
            font-weight: 500;
            color: #333;
            margin-bottom: 4px;
        }
        
        .friend-id {
            font-size: 12px;
            color: #666;
        }
        
        .friend-actions {
            display: flex;
            gap: 8px;
        }
        
        .friend-action-btn {
            padding: 4px 8px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .friend-action-btn.remove {
            background: #ff4d4f;
            color: white;
        }
        
        .friend-action-btn.remove:hover {
            background: #ff7875;
        }
        
        .friend-action-btn.accept {
            background: #52c41a;
            color: white;
        }
        
        .friend-action-btn.accept:hover {
            background: #73d13d;
        }
        
        .friend-action-btn.reject {
            background: #ff4d4f;
            color: white;
        }
        
        .friend-action-btn.reject:hover {
            background: #ff7875;
        }
        
        .friend-action-btn.send {
            background: #1b8eec;
            color: white;
        }
        
        .friend-action-btn.send:hover {
            background: #40a9ff;
        }
        
        .loading {
            text-align: center;
            color: #666;
            padding: 20px;
        }
        
        .empty-state {
            text-align: center;
            color: #666;
            padding: 20px;
        }
        
        .friends-header {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 16px;
        }
        
        .refresh-btn {
            background: #1b8eec;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .refresh-btn:hover {
            background: #40a9ff;
        }
        
        .friend-message {
            font-size: 12px;
            color: #999;
            margin-top: 4px;
        }
        
        /* ä¸ªäººä¿¡æ¯æ ·å¼ */
        .profile-info {
            text-align: center;
        }
        
        .profile-avatar {
            margin-bottom: 24px;
        }
        
        .profile-avatar-circle {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: #1b8eec;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            font-weight: bold;
            margin: 0 auto;
        }
        
        .profile-details {
            text-align: left;
        }
        
        .profile-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .profile-item:last-child {
            border-bottom: none;
        }
        
        .profile-item label {
            font-weight: 500;
            color: #333;
            min-width: 80px;
        }
        
        .profile-item span {
            color: #666;
            flex: 1;
            text-align: right;
            margin-right: 8px;
        }
        
        .profile-id-container {
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 1;
            justify-content: flex-end;
        }
        
        .copy-btn {
            background: #1b8eec;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .copy-btn:hover {
            background: #40a9ff;
        }
        
        .copy-btn.copied {
            background: #52c41a;
        }
        
        .auth-submit-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .auth-switch-btn {
            background: none;
            border: none;
            color: #1b8eec;
            font-size: 14px;
            cursor: pointer;
            text-decoration: underline;
            padding: 8px;
        }
        
        .auth-switch-btn:hover {
            color: #156bbd;
        }
        
        /* é”™è¯¯æ¶ˆæ¯æ ·å¼ */
        .error-message {
            color: #dc3545;
            font-size: 12px;
            margin-top: 4px;
            display: none;
        }
        
        .form-group.error input {
            border-color: #dc3545;
        }
        
        .form-group.error .error-message {
            display: block;
        }
        
        /* æˆåŠŸæ¶ˆæ¯æ ·å¼ */
        .success-message {
            color: #28a745;
            font-size: 14px;
            text-align: center;
            margin-top: 12px;
            display: none;
        }
        
        /* å“ç‰Œåç§°å’Œsloganæ ·å¼ */
        .brand-container {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1000;
            text-align: left;
            pointer-events: none;
        }
        
        .brand-name {
            font-size: 32px;
            font-weight: 700;
            color: #1b8eec;
            margin: 0;
            line-height: 1.2;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            letter-spacing: -0.5px;
        }
        
        .brand-slogan {
            font-size: 14px;
            color: #666;
            margin: 4px 0 0 0;
            line-height: 1.4;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.05);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-weight: 400;
        }
    </style>
</head>
<body>
    <!-- å“ç‰Œåç§°å’Œslogan -->
    <div class="brand-container">
        <h1 class="brand-name">SecretBites</h1>
        <p class="brand-slogan">æŠŠæœ€çˆ±çš„é¤å…ï¼Œåˆ†äº«ç»™æœ€äº²å¯†çš„æœ‹å‹</p>
    </div>
    
    <div class="search-bar">
        <input type="text" id="keyword" placeholder="è¯·è¾“å…¥POIå…³é”®å­—ï¼Œå¦‚é¤å…ã€æ™¯ç‚¹..." />
        <button id="search-btn">æœç´¢</button>
    </div>
    
    <!-- ç”¨æˆ·çŠ¶æ€åŒºåŸŸ -->
    <div class="user-status-bar" id="user-status-bar">
        <div class="user-status-logged-out" id="user-status-logged-out">
            <button class="login-btn" id="login-btn">ğŸ”‘ ç™»å½•</button>
            <button class="register-btn" id="register-btn">ğŸ“ æ³¨å†Œ</button>
        </div>
        <div class="user-status-logged-in" id="user-status-logged-in" style="display: none;">
            <div class="user-info">
                <span class="user-nickname" id="user-nickname">ğŸ‘¤ ç”¨æˆ·æ˜µç§°</span>
                <button class="profile-btn" id="profile-btn" onclick="showProfileModal()">ğŸ‘¤ ä¸ªäººä¿¡æ¯</button>
                <button class="friends-btn" id="friends-btn" onclick="showFriendsModal()">ğŸ‘¥ å¥½å‹</button>
                <button class="logout-btn" id="logout-btn">ğŸšª é€€å‡º</button>
            </div>
        </div>
    </div>
    
    <!-- ç™»å½•æ¨¡æ€æ¡† -->
    <div class="auth-modal" id="login-modal">
        <div class="auth-modal-content">
            <div class="auth-modal-header">
                <h2>ç”¨æˆ·ç™»å½•</h2>
                <button class="auth-modal-close" id="login-modal-close">&times;</button>
            </div>
            <div class="auth-modal-body">
                <form id="login-form">
                    <div class="form-group">
                        <label for="login-unique-id">ç”¨æˆ·å</label>
                        <input type="text" id="login-unique-id" name="unique_id" placeholder="è¯·è¾“å…¥ç”¨æˆ·å" required>
                    </div>
                    <div class="form-group">
                        <label for="login-password">å¯†ç </label>
                        <input type="password" id="login-password" name="password" placeholder="è¯·è¾“å…¥å¯†ç " required>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="auth-submit-btn">ç™»å½•</button>
                        <button type="button" class="auth-switch-btn" id="switch-to-register">æ²¡æœ‰è´¦å·ï¼Ÿå»æ³¨å†Œ</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- æ³¨å†Œæ¨¡æ€æ¡† -->
    <div class="auth-modal" id="register-modal">
        <div class="auth-modal-content">
            <div class="auth-modal-header">
                <h2>ç”¨æˆ·æ³¨å†Œ</h2>
                <button class="auth-modal-close" id="register-modal-close">&times;</button>
            </div>
            <div class="auth-modal-body">
                <form id="register-form">
                    <div class="form-group">
                        <label for="register-nickname">æ˜µç§°</label>
                        <input type="text" id="register-nickname" name="nickname" placeholder="è¯·è¾“å…¥æ˜µç§°" required>
                    </div>
                    <div class="form-group">
                        <label for="register-unique-id">ç”¨æˆ·å</label>
                        <input type="text" id="register-unique-id" name="unique_id" placeholder="è¯·è¾“å…¥ç”¨æˆ·åï¼ˆ3-20ä½å­—æ¯æ•°å­—ä¸‹åˆ’çº¿ï¼‰" required>
                        <small class="form-hint">ç”¨æˆ·ååªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—å’Œä¸‹åˆ’çº¿ï¼Œé•¿åº¦3-20ä½</small>
                    </div>
                    <div class="form-group">
                        <label for="register-password">å¯†ç </label>
                        <input type="password" id="register-password" name="password" placeholder="è¯·è¾“å…¥å¯†ç " required>
                    </div>
                    <div class="form-group">
                        <label for="register-confirm-password">ç¡®è®¤å¯†ç </label>
                        <input type="password" id="register-confirm-password" name="confirm_password" placeholder="è¯·å†æ¬¡è¾“å…¥å¯†ç " required>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="auth-submit-btn">æ³¨å†Œ</button>
                        <button type="button" class="auth-switch-btn" id="switch-to-login">å·²æœ‰è´¦å·ï¼Ÿå»ç™»å½•</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- æ¬¢è¿å¼¹çª— -->
    <div class="auth-modal" id="welcome-modal">
        <div class="auth-modal-content" style="max-width: 400px;">
            <div class="auth-modal-header">
                <h2>æ¬¢è¿ä½¿ç”¨ SecretBites</h2>
                <button class="auth-modal-close" id="welcome-modal-close">&times;</button>
            </div>
            <div class="auth-modal-body">
                <div class="welcome-content">
                    <div class="welcome-intro">
                        <p style="font-size: 16px; line-height: 1.6; margin: -10px 0 20px; color: #333;">
                            å¯ä»¥ä½¿ç”¨æ¼”ç¤ºè´¦å·ï¼ŒæŸ¥çœ‹æˆ‘çš„å¿ƒé€‰é¤å…ï¼›<br>
                            ä¹Ÿå¯ä»¥æŸ¥çœ‹é¡¹ç›®ä»‹ç»ï¼Œäº†è§£äº§å“è¯ç”Ÿçš„0åˆ°1
                        </p>
                    </div>
                    
                    <div class="demo-account-info">
                        <div class="demo-account-item">
                            <span class="demo-label">è´¦å·ï¼š</span>
                            <span class="demo-value">wangyuqing</span>
                        </div>
                        <div class="demo-account-item">
                            <span class="demo-label">å¯†ç ï¼š</span>
                            <span class="demo-value">111111</span>
                        </div>
                    </div>
                    
                    <div class="welcome-actions">
                        <button class="welcome-btn" onclick="downloadProjectIntro()">
                            é¡¹ç›®ä»‹ç»ï¼ˆPDFï¼‰
                        </button>
                        <button class="welcome-btn primary" onclick="useDemoAccount()">
                            ä½¿ç”¨æ¼”ç¤ºè´¦å·
                        </button>
                        <button class="welcome-btn secondary" onclick="showModal('login-modal'); hideModal('welcome-modal');">
                            ç™»å½•
                        </button>
                        <button class="welcome-btn tertiary" onclick="showModal('register-modal'); hideModal('welcome-modal');">
                            æ³¨å†Œ
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- å¥½å‹ç®¡ç†æ¨¡æ€æ¡† -->
    <div class="auth-modal" id="friends-modal">
        <div class="auth-modal-content" style="max-width: 600px;">
            <div class="auth-modal-header">
                <h2>å¥½å‹ç®¡ç†</h2>
                <button class="auth-modal-close" id="friends-modal-close">&times;</button>
            </div>
            <div class="auth-modal-body">
                <!-- æ ‡ç­¾é¡µå¯¼èˆª -->
                <div class="friends-tabs">
                    <button class="friends-tab active" data-tab="friends-list">å¥½å‹åˆ—è¡¨</button>
                    <button class="friends-tab" data-tab="add-friend">æ·»åŠ å¥½å‹</button>
                    <button class="friends-tab" data-tab="friend-requests">å¥½å‹è¯·æ±‚</button>
                </div>
                
                <!-- å¥½å‹åˆ—è¡¨æ ‡ç­¾é¡µ -->
                <div class="friends-tab-content active" id="friends-list-tab">
                    <div class="friends-header">
                        <button class="refresh-btn" onclick="refreshFriendsList()">ğŸ”„ åˆ·æ–°</button>
                    </div>
                    <div class="friends-list" id="friends-list">
                        <div class="loading">åŠ è½½ä¸­...</div>
                    </div>
                </div>
                
                <!-- æ·»åŠ å¥½å‹æ ‡ç­¾é¡µ -->
                <div class="friends-tab-content" id="add-friend-tab">
                    <div class="add-friend-form">
                        <div class="form-group">
                            <label for="search-user-id">æœç´¢ç”¨æˆ·</label>
                            <input type="text" id="search-user-id" placeholder="è¯·è¾“å…¥ç”¨æˆ·å”¯ä¸€ID" required>
                        </div>
                        <button type="button" id="search-user-btn" class="auth-submit-btn">æœç´¢ç”¨æˆ·</button>
                        <div id="search-result" style="margin-top: 16px;"></div>
                    </div>
                </div>
                
                <!-- å¥½å‹è¯·æ±‚æ ‡ç­¾é¡µ -->
                <div class="friends-tab-content" id="friend-requests-tab">
                    <div class="friends-header">
                        <button class="refresh-btn" onclick="refreshFriendRequests()">ğŸ”„ åˆ·æ–°</button>
                    </div>
                    <div class="friend-requests-list" id="friend-requests-list">
                        <div class="loading">åŠ è½½ä¸­...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ä¸ªäººä¿¡æ¯æ¨¡æ€æ¡† -->
    <div class="auth-modal" id="profile-modal">
        <div class="auth-modal-content" style="max-width: 500px;">
            <div class="auth-modal-header">
                <h2>ä¸ªäººä¿¡æ¯</h2>
                <button class="auth-modal-close" id="profile-modal-close">&times;</button>
            </div>
            <div class="auth-modal-body">
                <div class="profile-info" id="profile-info">
                    <div class="profile-avatar">
                        <div class="profile-avatar-circle" id="profile-avatar-circle">
                            <!-- å¤´åƒå°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                        </div>
                    </div>
                    <div class="profile-details">
                        <div class="profile-item">
                            <label>æ˜µç§°</label>
                            <span id="profile-nickname">åŠ è½½ä¸­...</span>
                        </div>
                        <div class="profile-item">
                            <label>å”¯ä¸€ID</label>
                            <div class="profile-id-container">
                                <span id="profile-unique-id">åŠ è½½ä¸­...</span>
                                <button class="copy-btn" onclick="copyUniqueId()">å¤åˆ¶</button>
                            </div>
                        </div>
                        <div class="profile-item">
                            <label>æ³¨å†Œæ—¶é—´</label>
                            <span id="profile-created-at">åŠ è½½ä¸­...</span>
                        </div>
                        <div class="profile-item">
                            <label>è¯„åˆ†ç»Ÿè®¡</label>
                            <span id="profile-rating-count">åŠ è½½ä¸­...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="map"></div>
    
    <!-- ä¿¡æ¯é¢æ¿ -->
    <div class="info-panel" id="info-panel">
        <div class="info-panel-header" id="info-panel-header">
            <span>ä¿¡æ¯é¢æ¿</span>
            <button class="info-panel-toggle-btn" id="info-panel-toggle-btn" tabindex="-1">â–²</button>
        </div>
        <div class="info-panel-content" id="info-panel-content">
            <!-- å†…å®¹å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
        </div>
        <div class="info-panel-resizer" id="info-panel-resizer"></div>
        <div class="info-panel-corner-resizer" id="info-panel-corner-resizer"></div>
        <div class="info-panel-corner-resizer-left" id="info-panel-corner-resizer-left"></div>
    </div>
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Supabase é…ç½® -->
    <script src="supabase_config.js"></script>
    <!-- å¥½å‹API -->
    <script src="friendship_api.js"></script>
    <!-- ç™¾åº¦åœ°å›¾API -->
    <script src="https://api.map.baidu.com/api?v=1.0&type=webgl&ak=37RkgO1xJD842QrZ0AnUGHpCOYSGg3kh"></script>
    <script>
        // ===================== Supabase é…ç½® =====================
        // ä»é…ç½®æ–‡ä»¶è·å– Supabase é…ç½®
        const SUPABASE_URL = window.SUPABASE_CONFIG.URL;
        const SUPABASE_ANON_KEY = window.SUPABASE_CONFIG.ANON_KEY;
        
        // åˆå§‹åŒ– Supabase å®¢æˆ·ç«¯
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // ===================== å¸¸é‡é…ç½® =====================
        const RATE_TYPES = [
            { value: "è¶…çˆ±", drop: "#FF4500", star: "white" },
            { value: "å–œæ¬¢", drop: "#FFA500", star: "white" },
            { value: "ä¸€èˆ¬", drop: "#808080", star: "white" },
            { value: "ä¸ä¼šå†å»äº†", drop: "#556B2F", star: "black" }
        ];
        const GLOBAL_DEFAULT_ZOOM = 15; // è‡ªåŠ¨ç¼©æ”¾é»˜è®¤çº§åˆ«

        // ===================== æ•°æ®ç®¡ç† =====================
        let map;
        let localSearch;
        window.ratedPois = [];
        window.ratedMarkers = {};
        window._poiMarkers = [];
        
        // ===================== ç”¨æˆ·è®¤è¯ç®¡ç† =====================
        let currentUser = null;
        let isLoggedIn = false;
        
        // ç”¨æˆ·è®¤è¯ç›¸å…³å‡½æ•°
        function loadUserSession() {
            const userSession = localStorage.getItem('userSession');
            if (userSession) {
                try {
                    const session = JSON.parse(userSession);
                    // æ£€æŸ¥ä¼šè¯æ˜¯å¦è¿‡æœŸï¼ˆ24å°æ—¶ï¼‰
                    if (session.timestamp && (Date.now() - session.timestamp) < 24 * 60 * 60 * 1000) {
                        currentUser = session.user;
                        isLoggedIn = true;
                        updateUserStatusUI();
                        return true;
                    } else {
                        // ä¼šè¯è¿‡æœŸï¼Œæ¸…é™¤
                        localStorage.removeItem('userSession');
                    }
                } catch (e) {
                    localStorage.removeItem('userSession');
                }
            }
            return false;
        }
        
        function saveUserSession(user) {
            const session = {
                user: user,
                timestamp: Date.now()
            };
            localStorage.setItem('userSession', JSON.stringify(session));
        }
        
        function clearUserSession() {
            localStorage.removeItem('userSession');
            currentUser = null;
            isLoggedIn = false;
            updateUserStatusUI();
        }
        
        function updateUserStatusUI() {
            const loggedOutDiv = document.getElementById('user-status-logged-out');
            const loggedInDiv = document.getElementById('user-status-logged-in');
            const nicknameSpan = document.getElementById('user-nickname');
            
            if (isLoggedIn && currentUser) {
                loggedOutDiv.style.display = 'none';
                loggedInDiv.style.display = 'flex';
                nicknameSpan.textContent = currentUser.nickname;
            } else {
                loggedOutDiv.style.display = 'flex';
                loggedInDiv.style.display = 'none';
            }
            
            // æ›´æ–°ä¿¡æ¯é¢æ¿ä»¥åæ˜ ç™»å½•çŠ¶æ€å˜åŒ–
            if (currentView === 'list') {
                updateInfoPanel(null, 'list');
            } else if (currentView === 'stats') {
                updateInfoPanel(null, 'stats');
            } else if (currentView === 'search' && currentSearchResults.length > 0) {
                updateInfoPanel(null, 'search', currentSearchResults);
            } else if (currentView === 'detail' && currentPoi) {
                updateInfoPanel(currentPoi, 'detail');
            }
        }
        
        // Supabase ç”¨æˆ·è®¤è¯API
        async function loginUser(uniqueId, password) {
            try {
                // ä»æ•°æ®åº“æŸ¥è¯¢ç”¨æˆ·
                const { data: user, error } = await supabase
                    .from('users')
                    .select('*')
                    .eq('unique_id', uniqueId)
                    .single();
                
                if (error || !user) {
                    throw new Error('ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯');
                }
                
                // éªŒè¯å¯†ç ï¼ˆè¿™é‡Œä½¿ç”¨ç®€å•çš„æ¯”è¾ƒï¼Œå®é™…åº”è¯¥ä½¿ç”¨bcryptï¼‰
                if (user.password_hash !== password) {
                    throw new Error('ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯');
                }
                
                // æ›´æ–°æœ€åæ´»è·ƒæ—¶é—´
                await supabase
                    .from('users')
                    .update({ last_active: new Date().toISOString() })
                    .eq('id', user.id);
                
                return {
                    id: user.id,
                    unique_id: user.unique_id,
                    nickname: user.nickname,
                    avatar_url: user.avatar_url
                };
            } catch (error) {
                console.error('ç™»å½•é”™è¯¯:', error);
                throw new Error('ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯');
            }
        }
        
        async function registerUser(nickname, uniqueId, password) {
            try {
                // æ£€æŸ¥ç”¨æˆ·åæ˜¯å¦å·²å­˜åœ¨
                const { data: existingUser, error: checkError } = await supabase
                    .from('users')
                    .select('id')
                    .eq('unique_id', uniqueId)
                    .single();
                
                if (existingUser) {
                    throw new Error('ç”¨æˆ·åå·²å­˜åœ¨');
                }
                
                // åˆ›å»ºæ–°ç”¨æˆ·ï¼ˆè¿™é‡Œä½¿ç”¨ç®€å•çš„å¯†ç å­˜å‚¨ï¼Œå®é™…åº”è¯¥ä½¿ç”¨bcryptå“ˆå¸Œï¼‰
                const { data: newUser, error } = await supabase
                    .from('users')
                    .insert([
                        {
                            nickname: nickname,
                            unique_id: uniqueId,
                            password_hash: password // å®é™…åº”è¯¥ä½¿ç”¨ bcrypt.hash(password, 10)
                        }
                    ])
                    .select()
                    .single();
                
                if (error) {
                    console.error('æ³¨å†Œé”™è¯¯:', error);
                    throw new Error('æ³¨å†Œå¤±è´¥ï¼Œè¯·é‡è¯•');
                }
                
                return {
                    id: newUser.id,
                    unique_id: newUser.unique_id,
                    nickname: newUser.nickname,
                    avatar_url: newUser.avatar_url
                };
            } catch (error) {
                console.error('æ³¨å†Œé”™è¯¯:', error);
                throw error;
            }
        }
        
        // è¡¨å•éªŒè¯å‡½æ•°
        function validateUniqueId(uniqueId) {
            const pattern = /^[a-zA-Z0-9_]{3,20}$/;
            return pattern.test(uniqueId);
        }
        
        function validatePassword(password) {
            return password && password.length >= 6;
        }
        
        function validateNickname(nickname) {
            return nickname && nickname.trim().length >= 2;
        }
        
        // æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
        function showFormError(formGroup, message) {
            formGroup.classList.add('error');
            let errorDiv = formGroup.querySelector('.error-message');
            if (!errorDiv) {
                errorDiv = document.createElement('div');
                errorDiv.className = 'error-message';
                formGroup.appendChild(errorDiv);
            }
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }
        
        // æ¸…é™¤é”™è¯¯æ¶ˆæ¯
        function clearFormError(formGroup) {
            formGroup.classList.remove('error');
            const errorDiv = formGroup.querySelector('.error-message');
            if (errorDiv) {
                errorDiv.style.display = 'none';
            }
        }
        
        // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
        function showSuccessMessage(modal, message) {
            let successDiv = modal.querySelector('.success-message');
            if (!successDiv) {
                successDiv = document.createElement('div');
                successDiv.className = 'success-message';
                modal.querySelector('.auth-modal-body').appendChild(successDiv);
            }
            successDiv.textContent = message;
            successDiv.style.display = 'block';
        }
        
        // æ¨¡æ€æ¡†ç®¡ç†
        function showModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.style.display = 'block';
            // æ¸…é™¤ä¹‹å‰çš„é”™è¯¯å’ŒæˆåŠŸæ¶ˆæ¯
            modal.querySelectorAll('.error-message, .success-message').forEach(el => {
                el.style.display = 'none';
            });
            modal.querySelectorAll('.form-group').forEach(el => {
                el.classList.remove('error');
            });
        }
        
        function hideModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.style.display = 'none';
        }
        
        function switchModal(fromModalId, toModalId) {
            hideModal(fromModalId);
            showModal(toModalId);
        }
        
        // ä¸‹è½½é¡¹ç›®ä»‹ç» PDFï¼ˆæ”¾åœ¨é¡¹ç›®æ ¹ç›®å½•ï¼‰
        window.downloadProjectIntro = function() {
            const pdfPath = encodeURI('ç‹é›¨æ™´_SecretBites_æŠŠæœ€çˆ±çš„é¤å…ï¼Œåˆ†äº«ç»™æœ€äº²å¯†çš„æœ‹å‹_äº§å“ä»‹ç».pdf');
            try {
                const a = document.createElement('a');
                a.href = pdfPath;
                a.download = 'SecretBites_äº§å“ä»‹ç».pdf';
                document.body.appendChild(a);
                a.click();
                a.remove();
            } catch (e) {
                // å›é€€æ–¹æ¡ˆï¼šæ–°å¼€æ ‡ç­¾é¡µ
                window.open(pdfPath, '_blank');
            }
        }

        // æ˜¾ç¤ºæ¬¢è¿å¼¹çª—
        window.showWelcomeModal = function() {
            showModal('welcome-modal');
        }
        
        // ä½¿ç”¨æ¼”ç¤ºè´¦å·è‡ªåŠ¨ç™»å½•
        window.useDemoAccount = async function() {
            try {
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                const demoBtn = event.target;
                const originalText = demoBtn.textContent;
                demoBtn.textContent = 'ç™»å½•ä¸­...';
                demoBtn.disabled = true;
                
                // ä½¿ç”¨æ¼”ç¤ºè´¦å·ä¿¡æ¯
                const demoCredentials = {
                    unique_id: 'wangyuqing',
                    password: '111111'
                };
                
                // è°ƒç”¨ç°æœ‰çš„ç™»å½•å‡½æ•°
                const user = await loginUser(demoCredentials.unique_id, demoCredentials.password);
                
                // è®¾ç½®ç”¨æˆ·ä¼šè¯
                currentUser = user;
                isLoggedIn = true;
                saveUserSession(user);
                
                // å…³é—­æ¬¢è¿å¼¹çª—
                hideModal('welcome-modal');
                
                // æ›´æ–°UIçŠ¶æ€
                updateUserStatusUI();
                
                // æ›´æ–°ç”¨æˆ·ç­›é€‰çŠ¶æ€
                userFilterState = { self: true };
                userFilterMapping = { self: currentUser.id };
                
                // åˆå§‹åŒ–å¥½å‹API
                initFriendshipAPI();
                
                // åŠ è½½è¯„åˆ†æ•°æ®
                await loadRatedPois();
                await updateUserFilters(); // æ›´æ–°ç”¨æˆ·ç­›é€‰å™¨
                updateFilterState();
                updateMapMarkers();
                updateMapViewportForRatedPois();
                updateInfoPanel(null, 'list'); // æ›´æ–°ä¿¡æ¯é¢æ¿æ˜¾ç¤ºé¤å…åˆ—è¡¨
                
                // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                setTimeout(() => {
                    alert('æ¼”ç¤ºè´¦å·ç™»å½•æˆåŠŸï¼æ¬¢è¿æŸ¥çœ‹æˆ‘çš„å¿ƒé€‰é¤å… ğŸ½ï¸');
                }, 500);
                
            } catch (error) {
                console.error('æ¼”ç¤ºè´¦å·ç™»å½•å¤±è´¥:', error);
                
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                demoBtn.textContent = originalText;
                demoBtn.disabled = false;
                
                // æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
                alert('æ¼”ç¤ºè´¦å·ç™»å½•å¤±è´¥ï¼š' + error.message);
            }
        }

        async function loadRatedPois() {
            if (!isLoggedIn || !currentUser) {
                window.ratedPois = [];
                return;
            }
            
            try {
                // åŠ è½½è‡ªå·±çš„è¯„åˆ†
                const { data: reviews, error } = await supabase
                    .from('restaurant_reviews')
                    .select('*')
                    .eq('user_id', currentUser.id);
                
                if (error) {
                    console.error('åŠ è½½è¯„åˆ†æ•°æ®é”™è¯¯:', error);
                    window.ratedPois = [];
                    return;
                }
                
                // å°†æ•°æ®åº“æ ¼å¼è½¬æ¢ä¸ºåº”ç”¨æ ¼å¼
                let myReviews = reviews.map(review => ({
                    uid: review.restaurant_uid,
                    title: review.restaurant_name,
                    shortTitle: getShortTitle(review.restaurant_name),
                    address: review.restaurant_address,
                    point: review.longitude && review.latitude ? {
                        lng: review.longitude,
                        lat: review.latitude
                    } : undefined,
                    city: review.restaurant_city,
                    area: review.restaurant_area,
                    tags: review.tags || [],
                    phoneNumber: null, // æ•°æ®åº“ä¸­æ²¡æœ‰å­˜å‚¨
                    rate: review.rating,
                    // æ·»åŠ æ•°æ®åº“å­—æ®µ
                    review_id: review.id,
                    user_id: review.user_id, // æ·»åŠ ç”¨æˆ·ID
                    review_text: review.review_text,
                    is_public: review.is_public,
                    created_at: review.created_at,
                    updated_at: review.updated_at
                }));
                
                // åŠ è½½å¥½å‹çš„è¯„åˆ†
                const friendsReviews = await loadFriendsReviews();
                
                // åˆå¹¶æ‰€æœ‰è¯„åˆ†ï¼Œç¡®ä¿å¥½å‹è¯„åˆ†æœ‰æ­£ç¡®çš„æ ‡è®°
                window.ratedPois = [
                    ...myReviews.map(review => ({...review, is_friend_review: false})),
                    ...friendsReviews.map(review => ({...review, is_friend_review: true}))
                ];
                
                // æ›´æ–°ç”¨æˆ·ç­›é€‰å™¨ï¼ˆä½†ä¸é‡ç½®ç°æœ‰çš„é€‰æ‹©çŠ¶æ€ï¼‰
                const currentUserFilters = {...userFilterState};
                await updateUserFilters();
                // æ¢å¤ä¹‹å‰çš„é€‰æ‹©çŠ¶æ€
                Object.keys(currentUserFilters).forEach(key => {
                    if (userFilterState.hasOwnProperty(key)) {
                        userFilterState[key] = currentUserFilters[key];
                    }
                });
                
                // æ›´æ–°ç­›é€‰çŠ¶æ€
                updateFilterState();
                
            } catch (error) {
                console.error('åŠ è½½è¯„åˆ†æ•°æ®é”™è¯¯:', error);
                window.ratedPois = [];
            }
        }
        
        // åŠ è½½å¥½å‹çš„è¯„åˆ†æ•°æ®
        async function loadFriendsReviews() {
            if (!friendshipAPI) {
                initFriendshipAPI();
            }
            
            try {
                const friendsReviews = await friendshipAPI.getAllFriendsReviews(currentUser.id);
                
                // è·å–å¥½å‹åˆ—è¡¨ä»¥è·å–æ˜µç§°
                const friends = await friendshipAPI.getFriendsList(currentUser.id);
                
                // è½¬æ¢ä¸ºåº”ç”¨æ ¼å¼
                return friendsReviews.map(review => {
                    // ä»å¥½å‹åˆ—è¡¨ä¸­æŸ¥æ‰¾å¯¹åº”çš„æ˜µç§°
                    const friend = friends.find(f => {
                        const friendId = f.friend_id === currentUser.id ? f.user_id : f.friend_id;
                        return friendId === review.user_id;
                    });
                    
                    const friendNickname = friend ? 
                        (friend.friend_id === currentUser.id ? friend.user_nickname : friend.friend_nickname) : 
                        `ç”¨æˆ·${review.user_id.slice(0, 8)}`;
                    
                    return {
                        uid: review.restaurant_uid,
                        title: review.restaurant_name,
                        shortTitle: getShortTitle(review.restaurant_name),
                        address: review.restaurant_address,
                        point: review.longitude && review.latitude ? {
                            lng: review.longitude,
                            lat: review.latitude
                        } : undefined,
                        city: review.restaurant_city,
                        area: review.restaurant_area,
                        tags: review.tags || [],
                        phoneNumber: null,
                        rate: review.rating,
                        // æ·»åŠ æ•°æ®åº“å­—æ®µ
                        review_id: review.id,
                        user_id: review.user_id,
                        review_text: review.review_text,
                        is_public: review.is_public,
                        created_at: review.created_at,
                        updated_at: review.updated_at,
                        // æ·»åŠ å¥½å‹ä¿¡æ¯
                        friend_nickname: friendNickname,
                        is_friend_review: true
                    };
                });
            } catch (error) {
                console.error('åŠ è½½å¥½å‹è¯„åˆ†å¤±è´¥:', error);
                return [];
            }
        }
        
        // æ›´æ–°ç”¨æˆ·ç­›é€‰å™¨
        async function updateUserFilters() {
            if (!friendshipAPI) {
                initFriendshipAPI();
            }
            
            try {
                // é‡ç½®ç”¨æˆ·ç­›é€‰çŠ¶æ€ - é»˜è®¤åªæ˜¾ç¤ºè‡ªå·±çš„
                userFilterState = { self: true };
                userFilterMapping = { self: currentUser.id };
                
                // è·å–å¥½å‹åˆ—è¡¨
                const friends = await friendshipAPI.getFriendsList(currentUser.id);
                
                // ä¿å­˜å¥½å‹åˆ—è¡¨åˆ°å…¨å±€å˜é‡ï¼Œä¾›ç­›é€‰å™¨æ˜¾ç¤ºä½¿ç”¨
                window.friendsList = friends;
                
                // ä¸ºæ¯ä¸ªå¥½å‹æ·»åŠ åˆ°ç­›é€‰å™¨
                friends.forEach(friend => {
                    const friendId = friend.friend_id === currentUser.id ? friend.user_id : friend.friend_id;
                    const friendNickname = friend.friend_id === currentUser.id ? friend.user_nickname : friend.friend_nickname;
                    
                    userFilterState[`friend_${friendId}`] = false; // é»˜è®¤ä¸é€‰ä¸­å¥½å‹
                    userFilterMapping[`friend_${friendId}`] = friendId;
                });
                
                console.log('ç”¨æˆ·ç­›é€‰å™¨å·²æ›´æ–°:', userFilterState);
                console.log('ç”¨æˆ·ç­›é€‰å™¨æ˜ å°„å·²æ›´æ–°:', userFilterMapping);
                console.log('å¥½å‹åˆ—è¡¨å·²ä¿å­˜:', window.friendsList);
                
            } catch (error) {
                console.error('æ›´æ–°ç”¨æˆ·ç­›é€‰å™¨å¤±è´¥:', error);
            }
        }
        
        // åˆ·æ–°ç”¨æˆ·ç­›é€‰å™¨
        window.refreshUserFilters = async function() {
            console.log('åˆ·æ–°ç”¨æˆ·ç­›é€‰å™¨');
            await updateUserFilters();
            clearFilterCache();
            updateInfoPanel(null, 'list'); // åˆ·æ–°åˆ—è¡¨è§†å›¾
        };
        
        async function saveRatedPoi(poi, rate) {
            if (!isLoggedIn || !currentUser) {
                throw new Error('ç”¨æˆ·æœªç™»å½•');
            }
            
            try {
                const reviewData = {
                    user_id: currentUser.id,
                    restaurant_uid: poi.uid,
                    restaurant_name: getPoiField(poi, ['title', 'name']),
                    restaurant_address: getPoiField(poi, ['address', 'addr']),
                    restaurant_city: getPoiField(poi, ['city', 'cityname']),
                    restaurant_area: getPoiField(poi, ['area', 'areaname', 'district']),
                    rating: rate,
                    latitude: poi.point ? parseFloat(poi.point.lat) : null,
                    longitude: poi.point ? parseFloat(poi.point.lng) : null,
                    tags: Array.isArray(getPoiField(poi, ['tags', 'std_tag', 'tag'])) 
                        ? getPoiField(poi, ['tags', 'std_tag', 'tag']) 
                        : []
                };
                
                console.log('ä¿å­˜è¯„åˆ†æ•°æ®:', reviewData);
                
                const { data, error } = await supabase
                    .from('restaurant_reviews')
                    .upsert(reviewData, { 
                        onConflict: 'user_id,restaurant_uid'
                    })
                    .select()
                    .single();
                
                if (error) {
                    console.error('ä¿å­˜è¯„åˆ†é”™è¯¯:', error);
                    throw new Error(`ä¿å­˜è¯„åˆ†å¤±è´¥: ${error.message}`);
                }
                
                return data;
            } catch (error) {
                console.error('ä¿å­˜è¯„åˆ†é”™è¯¯:', error);
                throw error;
            }
        }
        async function addOrUpdateRatedPoi(poi, rate) {
            // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²ç™»å½•
            if (!isLoggedIn) {
                showModal('login-modal');
                return;
            }
            
            // ç«‹å³æ›´æ–°æœ¬åœ°æ•°æ®å’ŒUIï¼Œæä¾›å³æ—¶åé¦ˆ
            // åªæŸ¥æ‰¾è‡ªå·±çš„è¯„åˆ†ï¼Œä¸å½±å“å¥½å‹çš„è¯„åˆ†
            const idx = window.ratedPois.findIndex(f => f.uid === poi.uid && f.user_id === currentUser.id);
            const title = getPoiField(poi, ['title', 'name']);
            const shortTitle = getShortTitle(title);
            const address = getPoiField(poi, ['address', 'addr']);
            const city = getPoiField(poi, ['city', 'cityname']);
            const area = getPoiField(poi, ['area', 'areaname', 'district']);
            const tags = getPoiField(poi, ['tags', 'std_tag', 'tag']) || [];
            
            if (idx === -1) {
                // æ–°å¢è¯„åˆ† - å…ˆæ·»åŠ åˆ°æœ¬åœ°æ•°æ®
                const newPoi = {
                    uid: poi.uid,
                    title: title,
                    shortTitle: shortTitle,
                    address: address,
                    point: poi.point ? {lng: poi.point.lng, lat: poi.point.lat} : undefined,
                    city: city,
                    area: area,
                    tags: tags,
                    rate: rate,
                    user_id: currentUser.id,
                    is_friend_review: false,  // ç¡®ä¿è¿™æ˜¯è‡ªå·±çš„è¯„åˆ†
                    review_id: null, // ä¸´æ—¶è®¾ä¸ºnullï¼Œä¿å­˜åæ›´æ–°
                    created_at: new Date().toISOString(),
                    updated_at: new Date().toISOString()
                };
                window.ratedPois.push(newPoi);
                
                // ç«‹å³æ›´æ–°UI
                updateFilterState();
                updateMapMarkers();
                if (currentView === 'list') {
                    updateInfoPanel(null, 'list');
                }
                if (currentView === 'detail' && currentPoi && currentPoi.uid === poi.uid) {
                    // ä½¿ç”¨æ›´æ–°åçš„è¯„åˆ†æ•°æ®æ›´æ–°é¢æ¿
                    const updatedPoi = window.ratedPois.find(p => p.uid === poi.uid && p.user_id === currentUser.id) || poi;
                    updateInfoPanel(updatedPoi, 'detail');
                }
            } else {
                // æ›´æ–°è¯„åˆ† - ç«‹å³æ›´æ–°æœ¬åœ°æ•°æ®
                const oldRate = window.ratedPois[idx].rate;
                window.ratedPois[idx].rate = rate;
                window.ratedPois[idx].shortTitle = shortTitle;
                window.ratedPois[idx].title = title;
                window.ratedPois[idx].address = address;
                window.ratedPois[idx].city = city;
                window.ratedPois[idx].area = area;
                window.ratedPois[idx].tags = tags;
                window.ratedPois[idx].updated_at = new Date().toISOString();
                
                // ç«‹å³æ›´æ–°UI
                updateFilterState();
                updateMapMarkers();
                if (currentView === 'list') {
                    updateInfoPanel(null, 'list');
                }
                if (currentView === 'detail' && currentPoi && currentPoi.uid === poi.uid) {
                    // ä½¿ç”¨æ›´æ–°åçš„è¯„åˆ†æ•°æ®æ›´æ–°é¢æ¿
                    const updatedPoi = window.ratedPois.find(p => p.uid === poi.uid && p.user_id === currentUser.id) || poi;
                    updateInfoPanel(updatedPoi, 'detail');
                }
            }
            
            // å¼‚æ­¥ä¿å­˜åˆ°æ•°æ®åº“
            try {
                const savedReview = await saveRatedPoi(poi, rate);
                
                // æ›´æ–°æ•°æ®åº“è¿”å›çš„å­—æ®µ
                if (idx === -1) {
                    // æ‰¾åˆ°åˆšæ·»åŠ çš„è¯„åˆ†
                    const newIdx = window.ratedPois.findIndex(f => f.uid === poi.uid && f.review_id === null);
                    if (newIdx !== -1) {
                        window.ratedPois[newIdx].review_id = savedReview.id;
                        window.ratedPois[newIdx].created_at = savedReview.created_at;
                        window.ratedPois[newIdx].updated_at = savedReview.updated_at;
                    }
                } else {
                    window.ratedPois[idx].updated_at = savedReview.updated_at;
                }
            } catch (error) {
                console.error('ä¿å­˜è¯„åˆ†å¤±è´¥:', error);
                // å¦‚æœä¿å­˜å¤±è´¥ï¼Œå›æ»šæœ¬åœ°æ•°æ®
                if (idx === -1) {
                    window.ratedPois = window.ratedPois.filter(f => f.uid !== poi.uid);
                } else {
                    window.ratedPois[idx].rate = oldRate;
                }
                updateFilterState();
                updateMapMarkers(); // é‡æ–°æ¸²æŸ“ä»¥å›æ»šUI
                alert('ä¿å­˜è¯„åˆ†å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }
        
        async function removeRatedPoi(uid) {
            // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²ç™»å½•
            if (!isLoggedIn) {
                showModal('login-modal');
                return;
            }
            
            // ç«‹å³ä»æœ¬åœ°æ•°æ®ç§»é™¤å¹¶æ›´æ–°UIï¼ˆåªç§»é™¤è‡ªå·±çš„è¯„åˆ†ï¼‰
            const removedPoi = window.ratedPois.find(f => f.uid === uid && f.user_id === currentUser.id);
            window.ratedPois = window.ratedPois.filter(f => !(f.uid === uid && f.user_id === currentUser.id));
            
            // ç«‹å³æ›´æ–°UI
            updateFilterState();
            updateMapMarkers();
            if (currentView === 'list') {
                updateInfoPanel(null, 'list');
            }
            if (currentView === 'detail' && currentPoi && currentPoi.uid === uid) {
                updateInfoPanel(currentPoi, 'detail');
            }
            
            // å¼‚æ­¥ä»æ•°æ®åº“åˆ é™¤
            try {
                const { error } = await supabase
                    .from('restaurant_reviews')
                    .delete()
                    .eq('user_id', currentUser.id)
                    .eq('restaurant_uid', uid);
                
                if (error) {
                    console.error('åˆ é™¤è¯„åˆ†é”™è¯¯:', error);
                    throw new Error('åˆ é™¤è¯„åˆ†å¤±è´¥');
                }
            } catch (error) {
                console.error('åˆ é™¤è¯„åˆ†å¤±è´¥:', error);
                // å¦‚æœåˆ é™¤å¤±è´¥ï¼Œæ¢å¤æœ¬åœ°æ•°æ®
                if (removedPoi) {
                    window.ratedPois.push(removedPoi);
                    updateFilterState();
                    updateMapMarkers();
                }
                if (currentView === 'list') {
                    updateInfoPanel(null, 'list');
                }
                if (currentView === 'detail' && currentPoi && currentPoi.uid === uid) {
                    updateInfoPanel(currentPoi, 'detail');
                }
                alert('åˆ é™¤è¯„åˆ†å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }

        // ===================== åœ°å›¾æ ‡è®°ç®¡ç† =====================
        
        // å…¨å±€æ ‡è®°å­˜å‚¨
        window.mapMarkers = {
            rated: {},      // è¯„åˆ†æ ‡è®°
            nicknames: {},  // æ˜µç§°æ ‡ç­¾
            search: []      // æœç´¢æ ‡è®°
        };
        
        // ç­›é€‰çŠ¶æ€
        window.filterState = {
            rates: [],    // é€‰ä¸­çš„è¯„åˆ†ç±»å‹
            users: []     // é€‰ä¸­çš„ç”¨æˆ·ID
        };
        
        // åˆ›å»ºè¯„åˆ†æ ‡è®°çš„SVGå›¾æ ‡
        function createRatedSvg(rate) {
            const type = RATE_TYPES.find(t => t.value === rate) || RATE_TYPES[1];
            return `<svg width="32" height="40" viewBox="0 0 32 40" xmlns="http://www.w3.org/2000/svg">
                <path d="M16 40C16 40 32 24.5685 32 16C32 7.16344 24.8366 0 16 0C7.16344 0 0 7.16344 0 16C0 24.5685 16 40 16 40Z" fill="${type.drop}"/>
                <path d="M16 8L18.47 13.53L24 14.18L20 18.24L21.24 24L16 21.24L10.76 24L12 18.24L8 14.18L13.53 13.53L16 8Z" fill="${type.star}"/>
            </svg>`;
        }
        
        // æ¸…é™¤æ‰€æœ‰åœ°å›¾æ ‡è®°
        function clearAllMapMarkers() {
            // æ¸…é™¤è¯„åˆ†æ ‡è®°
            Object.values(window.mapMarkers.rated).forEach(marker => {
                map.removeOverlay(marker);
            });
            window.mapMarkers.rated = {};
            
            // æ¸…é™¤æ˜µç§°æ ‡ç­¾
            Object.values(window.mapMarkers.nicknames).forEach(label => {
                map.removeOverlay(label);
            });
            window.mapMarkers.nicknames = {};
            
            // æ¸…é™¤æœç´¢æ ‡è®°
            window.mapMarkers.search.forEach(marker => {
                map.removeOverlay(marker);
            });
            window.mapMarkers.search = [];
        }
        
        // è·å–åº”è¯¥æ˜¾ç¤ºçš„è¯„åˆ†ç‚¹
        function getVisibleRatedPois() {
            const { rates, users } = window.filterState;
            
            console.log('Filtering POIs with state:', { rates, users, totalPois: window.ratedPois.length });
            
            let filteredPois = window.ratedPois.filter(poi => {
                // è¯„åˆ†ç±»å‹ç­›é€‰ - å¦‚æœæ²¡æœ‰é€‰ä¸­ä»»ä½•è¯„åˆ†ç±»å‹ï¼Œåˆ™ä¸æ˜¾ç¤ºä»»ä½•æ•°æ®
                const rateMatch = rates.length > 0 && rates.includes(poi.rate);
                // ç”¨æˆ·ç­›é€‰ - å¦‚æœæ²¡æœ‰é€‰ä¸­ä»»ä½•ç”¨æˆ·ï¼Œåˆ™ä¸æ˜¾ç¤ºä»»ä½•æ•°æ®
                const userMatch = users.length > 0 && users.includes(poi.user_id);
                
                const shouldShow = rateMatch && userMatch;
                console.log(`POI ${poi.title}: rateMatch=${rateMatch}, userMatch=${userMatch}, shouldShow=${shouldShow}`);
                
                return shouldShow;
            });
            
            console.log('Filtered POIs count:', filteredPois.length);
            
            // æŒ‰ç…§RATE_TYPESçš„é¡ºåºè¿›è¡Œæ’åºï¼Œç¡®ä¿ä¸ç­›é€‰å™¨é¡ºåºä¸€è‡´
            return filteredPois.sort((a, b) => {
                const indexA = RATE_TYPES.findIndex(t => t.value === a.rate);
                const indexB = RATE_TYPES.findIndex(t => t.value === b.rate);
                return indexA - indexB;
            });
        }
        
        // æ›´æ–°åœ°å›¾æ ‡è®°
        function updateMapMarkers() {
            console.log('Updating map markers with filter state:', window.filterState);
            
            // å½»åº•æ¸…é™¤æ‰€æœ‰è¯„åˆ†ç›¸å…³çš„æ ‡è®°å’Œæ ‡ç­¾
            if (window.mapMarkers.rated) {
                console.log('Clearing rated markers:', Object.keys(window.mapMarkers.rated).length, 'keys:', Object.keys(window.mapMarkers.rated));
                Object.values(window.mapMarkers.rated).forEach(marker => {
                    if (marker && map) {
                        map.removeOverlay(marker);
                    }
                });
                window.mapMarkers.rated = {};
            }
            
            if (window.mapMarkers.nicknames) {
                console.log('Clearing nickname labels:', Object.keys(window.mapMarkers.nicknames).length, 'keys:', Object.keys(window.mapMarkers.nicknames));
                Object.values(window.mapMarkers.nicknames).forEach(label => {
                    if (label && map) {
                        map.removeOverlay(label);
                    }
                });
                window.mapMarkers.nicknames = {};
            }
            
            // è·å–è¦æ˜¾ç¤ºçš„æ•°æ®
            const visiblePois = getVisibleRatedPois();
            console.log('Visible POIs:', visiblePois.length);
            
            // åˆ›å»ºæ–°æ ‡è®°
            visiblePois.forEach(poi => {
                createRatedMarker(poi);
            });
            
            console.log('Final marker counts - rated:', Object.keys(window.mapMarkers.rated).length, 'nicknames:', Object.keys(window.mapMarkers.nicknames).length);
        }
        
        // åˆ›å»ºå•ä¸ªè¯„åˆ†æ ‡è®°
        function createRatedMarker(poi) {
            if (!poi.point || typeof poi.point.lng !== 'number' || typeof poi.point.lat !== 'number') {
                return;
            }
            
            const pt = new BMapGL.Point(poi.point.lng, poi.point.lat);
            
            // åˆ›å»ºæ ‡è®°å›¾æ ‡
            const svg = createRatedSvg(poi.rate);
            const svgUrl = 'data:image/svg+xml;base64,' + btoa(svg);
            const icon = new BMapGL.Icon(svgUrl, new BMapGL.Size(32, 40), { 
                anchor: new BMapGL.Size(16, 40) 
            });
            
            // åˆ›å»ºæ ‡è®°
            const marker = new BMapGL.Marker(pt, { icon: icon });
            
            // åˆ›å»ºé¤å…åç§°æ ‡ç­¾
            const label = new BMapGL.Label(poi.shortTitle || poi.title, { 
                offset: new BMapGL.Size(20, -10) 
            });
            label.setStyle({
                color: '#333',
                fontSize: '14px',
                background: 'rgba(255,255,255,0.85)',
                border: 'none',
                padding: '2px 8px',
                borderRadius: '4px',
                fontWeight: 'bold',
                zIndex: 999
            });
            marker.setLabel(label);
            
            // ä¸ºå¥½å‹è¯„åˆ†æ·»åŠ æ˜µç§°æ ‡ç­¾
            if (poi.is_friend_review && poi.friend_nickname) {
                const nicknameLabel = new BMapGL.Label(`ğŸ‘¤ ${poi.friend_nickname}`, {
                    position: pt,
                    offset: new BMapGL.Size(20, -30)
                });
                nicknameLabel.setStyle({
                    color: '#333',
                    fontSize: '10px',
                    background: 'rgba(255,192,203,0.85)',
                    border: 'none',
                    padding: '1px 4px',
                    borderRadius: '4px',
                    fontWeight: 'normal',
                    zIndex: 999,
                    whiteSpace: 'nowrap'
                });
                
                map.addOverlay(nicknameLabel);
                // ä½¿ç”¨å”¯ä¸€çš„keyé¿å…è¦†ç›–
                const nicknameKey = `${poi.uid}_${poi.user_id}`;
                window.mapMarkers.nicknames[nicknameKey] = nicknameLabel;
            }
            
            // æ·»åŠ ç‚¹å‡»äº‹ä»¶
            marker.addEventListener('click', function() {
                showPoiInfoWindow(poi, marker);
            });
            
            // æ·»åŠ åˆ°åœ°å›¾
            map.addOverlay(marker);
            // ä½¿ç”¨å”¯ä¸€çš„keyé¿å…è¦†ç›–
            const markerKey = `${poi.uid}_${poi.user_id}`;
            window.mapMarkers.rated[markerKey] = marker;
        }
        
        // æ›´æ–°ç­›é€‰çŠ¶æ€
        function updateFilterState() {
            // è·å–é€‰ä¸­çš„è¯„åˆ†ç±»å‹
            const checkedRates = Object.keys(listFilterState).filter(key => listFilterState[key]);
            
            // è·å–é€‰ä¸­çš„ç”¨æˆ·ID
            const checkedUserIds = Object.keys(userFilterState)
                .filter(key => userFilterState[key])
                .map(key => userFilterMapping[key]);
            
            window.filterState = {
                rates: checkedRates,
                users: checkedUserIds
            };
            
            console.log('Filter state updated:', window.filterState);
        }
        
        // æ›´æ–°åœ°å›¾è§†å£ä»¥æ˜¾ç¤ºè¯„åˆ†ç‚¹
        function updateMapViewportForRatedPois() {
            const visiblePois = getVisibleRatedPois();
            if (visiblePois && visiblePois.length > 0) {
                const points = visiblePois
                    .filter(poi => poi.point && typeof poi.point.lng === 'number' && typeof poi.point.lat === 'number')
                    .map(poi => new BMapGL.Point(poi.point.lng, poi.point.lat));
                if (points.length > 0) {
                    // æ‰‹åŠ¨æ‰©å¤§è¾¹ç•Œï¼Œé¿å…è´´è¾¹
                    let minLng = Math.min(...points.map(p => p.lng));
                    let maxLng = Math.max(...points.map(p => p.lng));
                    let minLat = Math.min(...points.map(p => p.lat));
                    let maxLat = Math.max(...points.map(p => p.lat));
                    const padding = 0.01;
                    minLng -= padding; maxLng += padding; minLat -= padding; maxLat += padding;
                    
                    // ä¸ºå³ä¾§ä¿¡æ¯é¢æ¿é¢„ç•™ç©ºé—´
                    const mapSize = map.getSize();
                    const panelWidth = 400; // ä¿¡æ¯é¢æ¿å®½åº¦
                    const mapWidth = mapSize.width;
                    if (mapWidth > 0) {
                        // è®¡ç®—ä¿¡æ¯é¢æ¿å åœ°å›¾å®½åº¦çš„æ¯”ä¾‹
                        const panelRatio = panelWidth / mapWidth;
                        // è®¡ç®—éœ€è¦ä¸ºä¿¡æ¯é¢æ¿é¢„ç•™çš„ç»çº¬åº¦åç§»é‡
                        const lngRange = maxLng - minLng;
                        const panelOffset = lngRange * panelRatio * 1.8; // 1.2æ˜¯è°ƒæ•´ç³»æ•°ï¼Œå¢åŠ å·¦ä¾§ç©ºé—´
                        maxLng += panelOffset;
                    }
                    
                    map.setViewport([
                        new BMapGL.Point(minLng, minLat),
                        new BMapGL.Point(maxLng, maxLat)
                    ]);
                }
            }
        }
        
        // æ¸…é™¤æœç´¢æ ‡è®°
        function clearPoiMarkers() {
            // æ¸…é™¤æœç´¢æ ‡è®°
            window.mapMarkers.search.forEach(marker => {
                map.removeOverlay(marker);
            });
            window.mapMarkers.search = [];
        }

        // ===================== ä¿¡æ¯çª—å£ =====================
        function getPoiField(poi, fieldNames) {
            // æ”¯æŒå¤šç§å¯èƒ½çš„å­—æ®µåï¼ŒæŒ‰ä¼˜å…ˆçº§è¿”å›ç¬¬ä¸€ä¸ªå­˜åœ¨çš„å€¼
            for (let fieldName of fieldNames) {
                if (poi[fieldName] !== undefined && poi[fieldName] !== null && poi[fieldName] !== '') {
                    return poi[fieldName];
                }
            }
            return '';
        }

        function getShortTitle(title) {
            if (!title) return '';
            const idx = title.indexOf('(');
            return idx > 0 ? title.slice(0, idx).trim() : title;
        }

        function showPoiInfoWindow(poi, marker) {
            // è·³è½¬åˆ°é¤å…è¯¦æƒ…é¡µé¢
            updateInfoPanel(poi, 'detail');
        }

        // ===================== åœ°å›¾ä¸æœç´¢ =====================
        function initMap() {
            map = new BMapGL.Map("map", {enableIconClick: true});
            map.centerAndZoom(new BMapGL.Point(116.404, 39.915), GLOBAL_DEFAULT_ZOOM);
            map.enableScrollWheelZoom(true);
            map.setMapStyleV2({ styleId: '75a3e83ace0ff353fbf5a085935333e7' });
            
            // æ·»åŠ åœ°å›¾æ§ä»¶
            // æ·»åŠ æ¯”ä¾‹å°ºæ§ä»¶ï¼ˆå·¦ä¸‹è§’ï¼‰
            var scaleCtrl = new BMapGL.ScaleControl({
                anchor: BMAP_ANCHOR_BOTTOM_LEFT,
                offset: new BMapGL.Size(20, 20)
            });
            map.addControl(scaleCtrl);
            
            // æ·»åŠ å®šä½æ§ä»¶ï¼ˆå·¦ä¸‹è§’ï¼Œåœ¨æ¯”ä¾‹å°ºä¸Šæ–¹ï¼‰
            var locationControl = new BMapGL.LocationControl({
                anchor: BMAP_ANCHOR_BOTTOM_LEFT,
                offset: new BMapGL.Size(20, 80)
            });
            map.addControl(locationControl);
            
            // æ·»åŠ å®šä½äº‹ä»¶ç›‘å¬
            locationControl.addEventListener("locationSuccess", function(e){
                var address = '';
                address += e.addressComponent.province;
                address += e.addressComponent.city;
                address += e.addressComponent.district;
                address += e.addressComponent.street;
                address += e.addressComponent.streetNumber;
                console.log("å½“å‰å®šä½åœ°å€ä¸ºï¼š" + address);
            });
            locationControl.addEventListener("locationError", function(e){
                console.log("å®šä½å¤±è´¥ï¼š" + e.message);
            });
            
            // è‡ªå®šä¹‰å…¨æ˜¾ç¤ºæŒ‰é’®ï¼ˆçœ¼ç›å›¾æ ‡ï¼‰
            var fullViewBtn = document.createElement('div');
            fullViewBtn.style.cssText = `
                position: absolute;
                left: 20px;
                bottom: 140px;
                width: 40px;
                height: 40px;
                background: #fff;
                border: 1px solid #ccc;
                border-radius: 4px;
                display: flex;
                align-items: center;
                justify-content: center;
                cursor: pointer;
                font-size: 16px;
                z-index: 1000;
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            `;
            fullViewBtn.innerHTML = 'ğŸ‘ï¸';
            fullViewBtn.title = 'æ˜¾ç¤ºæ‰€æœ‰è¯„åˆ†ç‚¹';
            fullViewBtn.onclick = function() {
                updateMapViewportForRatedPois();
            };
            document.body.appendChild(fullViewBtn);
            
            // ä¸å†è®¾ç½®æœ€å¤§ç¼©æ”¾ï¼Œç”¨æˆ·å¯æ‰‹åŠ¨æ”¾å¤§
            initLocalSearch();
        }
        function initLocalSearch() {
            localSearch = new BMapGL.LocalSearch(map, {
                renderOptions: { map: null, autoViewport: false },
                pageCapacity: 20 // æ¯é¡µ20æ¡
            });
            localSearch.setSearchCompleteCallback(handleSearchResults);
        }
        function handleSearchResults(results) {
            clearPoiMarkers();
            const points = [];
            const searchResults = [];
            for (let i = 0; i < results.getCurrentNumPois(); i++) {
                const poi = results.getPoi(i);
                if (poi && poi.point) {
                    const marker = createPoiMarker(poi);
                    map.addOverlay(marker);
                    window.mapMarkers.search.push(marker);
                    points.push(poi.point);
                    searchResults.push(poi);
                }
            }
            if (points.length > 0) {
                map.setViewport(points);
            }
            // åˆ†é¡µç´¯åŠ 
            if (currentSearchPage === 0) {
                currentSearchResults = searchResults;
            } else {
                currentSearchResults = currentSearchResults.concat(searchResults);
            }
            hasMoreSearchResults = searchResults.length === 20;
            updateInfoPanel(null, 'search', currentSearchResults);
        }
        function createPoiMarker(poi) {
            const marker = new BMapGL.Marker(poi.point);
            // å°†POIæ•°æ®å­˜å‚¨åˆ°markerä¸­ï¼Œæ–¹ä¾¿åç»­è·å–
            marker._poiData = poi;
            marker.addEventListener('click', function() {
                showPoiInfoWindow(poi, marker);
            });
            return marker;
        }

        // ===================== è®¤è¯äº‹ä»¶ç»‘å®š =====================
        function bindAuthEvents() {
            // ç™»å½•æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            document.getElementById('login-btn').addEventListener('click', () => {
                showModal('login-modal');
            });
            
            // æ³¨å†ŒæŒ‰é’®ç‚¹å‡»äº‹ä»¶
            document.getElementById('register-btn').addEventListener('click', () => {
                showModal('register-modal');
            });
            
            // é€€å‡ºç™»å½•æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            document.getElementById('logout-btn').addEventListener('click', () => {
                if (confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')) {
                    // åœ¨æ¸…é™¤ä¼šè¯ä¹‹å‰é‡ç½®æ‰€æœ‰çŠ¶æ€
                    window.ratedPois = [];
                    currentPoi = null;
                    currentView = 'list';
                    currentSearchResults = [];
                    previousView = 'list';
                    currentSearchKeyword = '';
                    currentSearchPage = 0;
                    hasMoreSearchResults = false;
                    
                    // é‡ç½®ç­›é€‰å™¨çŠ¶æ€
                    listFilterState = {
                        'è¶…çˆ±': true,
                        'å–œæ¬¢': true,
                        'ä¸€èˆ¬': true,
                        'ä¸ä¼šå†å»äº†': true
                    };
                    userFilterState = {};
                    userFilterMapping = {};
                    
                    // æ¸…é™¤åœ°å›¾æ ‡è®°
                    clearAllMapMarkers();
                    
                    // é‡ç½®åœ°å›¾è§†å£åˆ°é»˜è®¤çŠ¶æ€
                    map.centerAndZoom(new BMapGL.Point(116.404, 39.915), 11);
                    
                    // é‡ç½®ç­›é€‰çŠ¶æ€
                    window.filterState = {
                        rates: [],
                        users: []
                    };
                    
                    // æ¸…é™¤ä¼šè¯
                    clearUserSession();
                    
                    // é‡ç½®ä¿¡æ¯é¢æ¿åˆ°åˆå§‹çŠ¶æ€
                    const panelContent = document.getElementById('info-panel-content');
                    panelContent.innerHTML = `
                        <div class="info-panel-section">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <h3>ğŸ½ï¸ é¤å…è¯„åˆ†</h3>
                                <button class="info-panel-btn" onclick="updateInfoPanel(null, 'stats')">ç»Ÿè®¡</button>
                            </div>
                            
                            <div class="filter-bar" id="filter-bar">
                                <div class="filter-bar-header" onclick="toggleFilterBar()">
                                    <div class="filter-bar-title">
                                        ğŸ” ç­›é€‰æ¡ä»¶
                                        <span class="filter-summary">4ä¸ªè¯„åˆ†ç±»å‹, 0ä¸ªç”¨æˆ·</span>
                                    </div>
                                    <div class="filter-bar-toggle">â–¼</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="info-panel-section">
                            <h4>é¤å…åˆ—è¡¨ (0ä¸ª)</h4>
                            <div class="restaurant-list">
                                <div style="text-align: center; color: #999; padding: 20px;">æš‚æ— è¯„åˆ†é¤å…</div>
                            </div>
                        </div>
                    `;
                    
                    // æ˜¾ç¤ºé€€å‡ºæç¤º
                    if (currentView === 'list') {
                        const panelContent = document.getElementById('info-panel-content');
                        const logoutDiv = document.createElement('div');
                        logoutDiv.style.cssText = 'background: #f8d7da; color: #721c24; padding: 12px; border-radius: 6px; margin-bottom: 16px; text-align: center;';
                        logoutDiv.textContent = 'å·²é€€å‡ºç™»å½•ï¼Œè¯·é‡æ–°ç™»å½•æ‰èƒ½è¿›è¡Œè¯„åˆ†æ“ä½œã€‚';
                        panelContent.insertBefore(logoutDiv, panelContent.firstChild);
                        setTimeout(() => logoutDiv.remove(), 3000);
                    }
                }
            });
            
            // æ¨¡æ€æ¡†å…³é—­æŒ‰é’®äº‹ä»¶
            document.getElementById('login-modal-close').addEventListener('click', () => {
                hideModal('login-modal');
            });
            
            document.getElementById('register-modal-close').addEventListener('click', () => {
                hideModal('register-modal');
            });
            
            document.getElementById('welcome-modal-close').addEventListener('click', () => {
                hideModal('welcome-modal');
            });
            
            // æ¨¡æ€æ¡†èƒŒæ™¯ç‚¹å‡»å…³é—­
            document.getElementById('login-modal').addEventListener('click', (e) => {
                if (e.target.id === 'login-modal') {
                    hideModal('login-modal');
                }
            });
            
            document.getElementById('register-modal').addEventListener('click', (e) => {
                if (e.target.id === 'register-modal') {
                    hideModal('register-modal');
                }
            });
            
            document.getElementById('welcome-modal').addEventListener('click', (e) => {
                if (e.target.id === 'welcome-modal') {
                    hideModal('welcome-modal');
                }
            });
            
            // åˆ‡æ¢æ¨¡æ€æ¡†æŒ‰é’®äº‹ä»¶
            document.getElementById('switch-to-register').addEventListener('click', () => {
                switchModal('login-modal', 'register-modal');
            });
            
            document.getElementById('switch-to-login').addEventListener('click', () => {
                switchModal('register-modal', 'login-modal');
            });
            
            // ç™»å½•è¡¨å•æäº¤äº‹ä»¶
            document.getElementById('login-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const uniqueId = document.getElementById('login-unique-id').value.trim();
                const password = document.getElementById('login-password').value;
                const submitBtn = e.target.querySelector('.auth-submit-btn');
                
                // æ¸…é™¤ä¹‹å‰çš„é”™è¯¯
                clearFormError(e.target.querySelector('.form-group'));
                
                // éªŒè¯è¾“å…¥
                if (!uniqueId) {
                    showFormError(e.target.querySelector('.form-group'), 'è¯·è¾“å…¥ç”¨æˆ·å');
                    return;
                }
                
                if (!password) {
                    showFormError(e.target.querySelector('.form-group:last-child'), 'è¯·è¾“å…¥å¯†ç ');
                    return;
                }
                
                // ç¦ç”¨æäº¤æŒ‰é’®
                submitBtn.disabled = true;
                submitBtn.textContent = 'ç™»å½•ä¸­...';
                
                try {
                    const user = await loginUser(uniqueId, password);
                    currentUser = user;
                    isLoggedIn = true;
                    saveUserSession(user);
                    updateUserStatusUI();
                    
                    showSuccessMessage(document.getElementById('login-modal'), 'ç™»å½•æˆåŠŸï¼');
                    
                                            // å»¶è¿Ÿå…³é—­æ¨¡æ€æ¡†
                        setTimeout(async () => {
                            hideModal('login-modal');
                            // æ¸…ç©ºè¡¨å•
                            e.target.reset();
                            
                            // æ›´æ–°ç”¨æˆ·ç­›é€‰çŠ¶æ€
                            userFilterState = { self: true };
                            userFilterMapping = { self: currentUser.id };
                            
                            // åˆå§‹åŒ–å¥½å‹API
                            initFriendshipAPI();
                            
                            // åŠ è½½ç”¨æˆ·è¯„åˆ†æ•°æ®
                            await loadRatedPois();
                            await updateUserFilters(); // æ›´æ–°ç”¨æˆ·ç­›é€‰å™¨
                            updateFilterState();
                            updateMapMarkers();
                            updateMapViewportForRatedPois();
                            updateInfoPanel(null, 'list'); // æ–°å¢ï¼šç™»å½•åç«‹å³åˆ·æ–°è¯„åˆ†åˆ—è¡¨
                        
                        // æ˜¾ç¤ºæ¬¢è¿æ¶ˆæ¯
                        if (currentView === 'list') {
                            const panelContent = document.getElementById('info-panel-content');
                            const welcomeDiv = document.createElement('div');
                            welcomeDiv.style.cssText = 'background: #d4edda; color: #155724; padding: 12px; border-radius: 6px; margin-bottom: 16px; text-align: center;';
                            welcomeDiv.textContent = `æ¬¢è¿å›æ¥ï¼Œ${currentUser.nickname}ï¼ç°åœ¨å¯ä»¥å¼€å§‹è¯„åˆ†äº†ã€‚`;
                            panelContent.insertBefore(welcomeDiv, panelContent.firstChild);
                            setTimeout(() => welcomeDiv.remove(), 3000);
                        }
                    }, 1500);
                    
                } catch (error) {
                    showFormError(e.target.querySelector('.form-group'), error.message);
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'ç™»å½•';
                }
            });
            
            // æ³¨å†Œè¡¨å•æäº¤äº‹ä»¶
            document.getElementById('register-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const nickname = document.getElementById('register-nickname').value.trim();
                const uniqueId = document.getElementById('register-unique-id').value.trim();
                const password = document.getElementById('register-password').value;
                const confirmPassword = document.getElementById('register-confirm-password').value;
                const submitBtn = e.target.querySelector('.auth-submit-btn');
                
                // æ¸…é™¤ä¹‹å‰çš„é”™è¯¯
                e.target.querySelectorAll('.form-group').forEach(el => clearFormError(el));
                
                // éªŒè¯è¾“å…¥
                if (!validateNickname(nickname)) {
                    showFormError(e.target.querySelector('.form-group'), 'æ˜µç§°è‡³å°‘éœ€è¦2ä¸ªå­—ç¬¦');
                    return;
                }
                
                if (!validateUniqueId(uniqueId)) {
                    showFormError(e.target.querySelectorAll('.form-group')[1], 'ç”¨æˆ·åæ ¼å¼ä¸æ­£ç¡®ï¼ˆ3-20ä½å­—æ¯æ•°å­—ä¸‹åˆ’çº¿ï¼‰');
                    return;
                }
                
                if (!validatePassword(password)) {
                    showFormError(e.target.querySelectorAll('.form-group')[2], 'å¯†ç è‡³å°‘éœ€è¦6ä¸ªå­—ç¬¦');
                    return;
                }
                
                if (password !== confirmPassword) {
                    showFormError(e.target.querySelectorAll('.form-group')[3], 'ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´');
                    return;
                }
                
                // ç¦ç”¨æäº¤æŒ‰é’®
                submitBtn.disabled = true;
                submitBtn.textContent = 'æ³¨å†Œä¸­...';
                
                try {
                    const user = await registerUser(nickname, uniqueId, password);
                    currentUser = user;
                    isLoggedIn = true;
                    saveUserSession(user);
                    updateUserStatusUI();
                    
                    showSuccessMessage(document.getElementById('register-modal'), 'æ³¨å†ŒæˆåŠŸï¼');
                    
                                            // å»¶è¿Ÿå…³é—­æ¨¡æ€æ¡†
                        setTimeout(async () => {
                            hideModal('register-modal');
                            // æ¸…ç©ºè¡¨å•
                            e.target.reset();
                            
                            // æ›´æ–°ç”¨æˆ·ç­›é€‰çŠ¶æ€
                            userFilterState = { self: true };
                            userFilterMapping = { self: currentUser.id };
                            
                            // åˆå§‹åŒ–å¥½å‹API
                            initFriendshipAPI();
                            
                            // åŠ è½½ç”¨æˆ·è¯„åˆ†æ•°æ®
                            await loadRatedPois();
                            await updateUserFilters(); // æ›´æ–°ç”¨æˆ·ç­›é€‰å™¨
                            updateFilterState();
                            updateMapMarkers();
                            updateMapViewportForRatedPois();
                            updateInfoPanel(null, 'list'); // æ–°å¢ï¼šæ³¨å†Œåç«‹å³åˆ·æ–°è¯„åˆ†åˆ—è¡¨
                        
                        // æ˜¾ç¤ºæ¬¢è¿æ¶ˆæ¯
                        if (currentView === 'list') {
                            const panelContent = document.getElementById('info-panel-content');
                            const welcomeDiv = document.createElement('div');
                            welcomeDiv.style.cssText = 'background: #d4edda; color: #155724; padding: 12px; border-radius: 6px; margin-bottom: 16px; text-align: center;';
                            welcomeDiv.textContent = `æ¬¢è¿åŠ å…¥ï¼Œ${currentUser.nickname}ï¼ç°åœ¨å¯ä»¥å¼€å§‹è¯„åˆ†äº†ã€‚`;
                            panelContent.insertBefore(welcomeDiv, panelContent.firstChild);
                            setTimeout(() => welcomeDiv.remove(), 3000);
                        }
                    }, 1500);
                    
                } catch (error) {
                    showFormError(e.target.querySelectorAll('.form-group')[1], error.message);
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'æ³¨å†Œ';
                }
            });
        }
        
        // ===================== äº‹ä»¶ç»‘å®š =====================
        function bindUIEvents() {
            document.getElementById('search-btn').onclick = function() {
                const keyword = document.getElementById('keyword').value.trim();
                if (!keyword) {
                    alert('è¯·è¾“å…¥æœç´¢å…³é”®å­—');
                    return;
                }
                currentSearchPage = 0;
                currentSearchKeyword = keyword;
                currentSearchResults = [];
                hasMoreSearchResults = false;
                localSearch.search(keyword);
            };
            document.getElementById('keyword').addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    document.getElementById('search-btn').click();
                }
            });
            
            // ä¿¡æ¯é¢æ¿æ”¶ç¼©/å±•å¼€äº‹ä»¶ç»‘å®š
            function toggleInfoPanel() {
                const panel = document.getElementById('info-panel');
                const btn = document.getElementById('info-panel-toggle-btn');
                const isCollapsed = panel.classList.contains('collapsed');
                if (isCollapsed) {
                    panel.classList.remove('collapsed');
                    // btn.innerText ä¸å†åˆ‡æ¢
                    panel.style.height = (panel._lastHeight || 600) + 'px';
                    panel.style.width = (panel._lastWidth || 400) + 'px';
                } else {
                    panel._lastHeight = panel.offsetHeight;
                    panel._lastWidth = panel.offsetWidth;
                    panel.classList.add('collapsed');
                    // btn.innerText ä¸å†åˆ‡æ¢
                    panel.style.height = '48px';
                    panel.style.width = '48px';
                }
            }
            document.getElementById('info-panel-header').onclick = toggleInfoPanel;
            // ä¸‹è¾¹æ‹‰ä¼¸
            (function() {
                const panel = document.getElementById('info-panel');
                const resizer = document.getElementById('info-panel-resizer');
                let startY, startHeight, dragging = false;
                resizer.addEventListener('mousedown', function(e) {
                    if (panel.classList.contains('collapsed')) return;
                    dragging = true;
                    startY = e.clientY;
                    startHeight = panel.offsetHeight;
                    document.body.style.userSelect = 'none';
                });
                window.addEventListener('mousemove', function(e) {
                    if (!dragging) return;
                    let newHeight = startHeight + (e.clientY - startY);
                    newHeight = Math.max(120, Math.min(newHeight, window.innerHeight * 0.9));
                    panel.style.height = newHeight + 'px';
                    panel._lastHeight = newHeight;
                });
                window.addEventListener('mouseup', function() {
                    if (dragging) {
                        dragging = false;
                        document.body.style.userSelect = '';
                    }
                });
            })();
            // å³ä¸‹è§’æ‹‰ä¼¸
            (function() {
                const panel = document.getElementById('info-panel');
                const resizer = document.getElementById('info-panel-corner-resizer');
                let startY, startX, startHeight, startWidth, dragging = false;
                resizer.addEventListener('mousedown', function(e) {
                    if (panel.classList.contains('collapsed')) return;
                    dragging = true;
                    startY = e.clientY;
                    startX = e.clientX;
                    startHeight = panel.offsetHeight;
                    startWidth = panel.offsetWidth;
                    document.body.style.userSelect = 'none';
                    e.preventDefault();
                });
                window.addEventListener('mousemove', function(e) {
                    if (!dragging) return;
                    let newHeight = startHeight + (e.clientY - startY);
                    let newWidth = startWidth + (e.clientX - startX);
                    newHeight = Math.max(120, Math.min(newHeight, window.innerHeight * 0.9));
                    newWidth = Math.max(220, Math.min(newWidth, window.innerWidth * 0.9));
                    panel.style.height = newHeight + 'px';
                    panel.style.width = newWidth + 'px';
                    panel._lastHeight = newHeight;
                    panel._lastWidth = newWidth;
                });
                window.addEventListener('mouseup', function() {
                    if (dragging) {
                        dragging = false;
                        document.body.style.userSelect = '';
                    }
                });
            })();
            // å·¦ä¸‹è§’æ‹‰ä¼¸
            (function() {
                const panel = document.getElementById('info-panel');
                const resizer = document.getElementById('info-panel-corner-resizer-left');
                let startY, startX, startHeight, startWidth, dragging = false;
                resizer.addEventListener('mousedown', function(e) {
                    if (panel.classList.contains('collapsed')) return;
                    dragging = true;
                    startY = e.clientY;
                    startX = e.clientX;
                    startHeight = panel.offsetHeight;
                    startWidth = panel.offsetWidth;
                    document.body.style.userSelect = 'none';
                    e.preventDefault();
                });
                window.addEventListener('mousemove', function(e) {
                    if (!dragging) return;
                    let newHeight = startHeight + (e.clientY - startY);
                    let newWidth = startWidth - (e.clientX - startX);
                    newHeight = Math.max(120, Math.min(newHeight, window.innerHeight * 0.9));
                    newWidth = Math.max(220, Math.min(newWidth, window.innerWidth * 0.9));
                    panel.style.height = newHeight + 'px';
                    panel.style.width = newWidth + 'px';
                    panel._lastHeight = newHeight;
                    panel._lastWidth = newWidth;
                });
                window.addEventListener('mouseup', function() {
                    if (dragging) {
                        dragging = false;
                        document.body.style.userSelect = '';
                    }
                });
            })();
            
            // ç‚¹å‡»åœ°å›¾ç©ºç™½å¤„æ—¶æ˜¾ç¤ºé¤å…åˆ—è¡¨
            map.addEventListener('click', function(e) {
                // æ£€æŸ¥æ˜¯å¦ç‚¹å‡»çš„æ˜¯åœ°å›¾æœ¬èº«è€Œä¸æ˜¯marker
                if (e.target === map || e.target === map.getContainer()) {
                    currentPoi = null;
                    // å¦‚æœå½“å‰æœ‰æœç´¢ç»“æœï¼Œæ˜¾ç¤ºæœç´¢ç»“æœï¼›å¦åˆ™æ˜¾ç¤ºé¤å…åˆ—è¡¨
                    if (currentView === 'search' && currentSearchResults.length > 0) {
                        updateInfoPanel(null, 'search', currentSearchResults);
                    } else {
                        updateInfoPanel(null, 'list');
                    }
                }
            });
        }
        
        // ===================== ä¿¡æ¯é¢æ¿åŠŸèƒ½ =====================
        let currentPoi = null;
        let currentView = 'list'; // 'list', 'detail', 'stats', 'search'
        let currentSearchResults = []; // å­˜å‚¨å½“å‰æœç´¢ç»“æœ
        let previousView = 'list'; // å­˜å‚¨ä¹‹å‰çš„è§†å›¾çŠ¶æ€
        let currentSearchKeyword = '';
        let currentSearchPage = 0;
        let hasMoreSearchResults = false;
        
        // ===================== è§†å›¾æ¸²æŸ“ =====================
        function updateInfoPanel(poi = null, view = 'list', searchResults = []) {
            const panelContent = document.getElementById('info-panel-content');
            
            if (view === 'stats') {
                // æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯
                currentView = 'stats';
                const stats = getRatedPoisStats();
                panelContent.innerHTML = `
                    <div class="info-panel-section">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <h3>ğŸ“Š ${isLoggedIn ? 'æˆ‘çš„è¯„åˆ†ç»Ÿè®¡' : 'è¯„åˆ†ç»Ÿè®¡'}</h3>
                            <button class="info-panel-btn" onclick="updateInfoPanel(null, 'list')">é¤å…åˆ—è¡¨</button>
                        </div>
                        <div class="info-panel-stats">
                            <div class="info-panel-stat">
                                <div class="info-panel-stat-value">${stats.total}</div>
                                <div class="info-panel-stat-label">æ€»è¯„åˆ†</div>
                            </div>
                            <div class="info-panel-stat">
                                <div class="info-panel-stat-value">${stats.cities}</div>
                                <div class="info-panel-stat-label">æ¶‰åŠåŸå¸‚</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="info-panel-section">
                        <h3>â­ è¯„åˆ†åˆ†å¸ƒ</h3>
                        ${RATE_TYPES.map(type => {
                            const count = stats.rateCounts[type.value] || 0;
                            return `
                                <div class="info-panel-item">
                                    <span class="info-panel-label">${type.value}</span>
                                    <span class="info-panel-value">${count}ä¸ª</span>
                                </div>
                            `;
                        }).join('')}
                    </div>
                    
                    <div class="info-panel-section">
                        <h3>ğŸ™ï¸ åŸå¸‚åˆ†å¸ƒ</h3>
                        ${Object.entries(stats.cityCounts).map(([city, count]) => `
                            <div class="info-panel-item">
                                <span class="info-panel-label">${city}</span>
                                <span class="info-panel-value">${count}ä¸ª</span>
                            </div>
                        `).join('')}
                    </div>
                `;
            } else if (view === 'search') {
                // æ˜¾ç¤ºæœç´¢ç»“æœ
                currentView = 'search';
                currentSearchResults = searchResults; // ä¿å­˜å½“å‰æœç´¢ç»“æœ
                const keyword = currentSearchKeyword || document.getElementById('keyword').value.trim();
                panelContent.innerHTML = `
                    <div class="info-panel-section">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <h3>ğŸ” æœç´¢ç»“æœ</h3>
                            <div>
                                <button class="info-panel-btn" onclick="goToMyRestaurants()">${isLoggedIn ? 'æˆ‘çš„é¤å…' : 'é¤å…è¯„åˆ†'}</button>
                            </div>
                        </div>
                        <h4>å…³é”®è¯: "${keyword}" (${searchResults.length}ä¸ªç»“æœ)</h4>
                    </div>
                    <div class="info-panel-section flex-grow">
                        <div class="restaurant-list">
                            ${searchResults.length > 0 ? searchResults.map(poi => {
                                const title = getPoiField(poi, ['title', 'name']);
                                const shortTitle = getShortTitle(title);
                                const city = getPoiField(poi, ['city', 'cityname']);
                                const area = getPoiField(poi, ['area', 'areaname', 'district']);
                                const address = getPoiField(poi, ['address', 'addr']);
                                const ratedPoi = window.ratedPois.find(rp => rp.uid === poi.uid);
                                const rateType = ratedPoi ? RATE_TYPES.find(t => t.value === ratedPoi.rate) : null;
                                return `
                                    <div class="restaurant-item" onclick="showSearchResultDetail('${poi.uid}')">
                                        <div class="restaurant-header">
                                            <span class="restaurant-name">${shortTitle || title || ''}</span>
                                            ${ratedPoi ? `<span class="restaurant-rate" style="color: ${rateType?.drop || '#666'}; white-space: nowrap;">${ratedPoi.rate}</span>` : ''}
                                        </div>
                                        <div class="restaurant-location">${city || ''}${area ? ' Â· ' + area : ''}</div>
                                        <div class="restaurant-address">${address || ''}</div>
                                    </div>
                                `;
                            }).join('') : '<div style="text-align: center; color: #999; padding: 20px;">æœªæ‰¾åˆ°ç›¸å…³ç»“æœ</div>'}
                        </div>
                        ${hasMoreSearchResults ? `
                        <div style="margin-top: 12px; text-align: center;">
                            <button class="info-panel-btn" onclick="loadMoreSearchResults()" style="background: #52c41a; color: #fff;">åŠ è½½æ›´å¤šç»“æœ</button>
                        </div>
                        ` : ''}
                    </div>
                `;
            } else if (view === 'list') {
                // æ˜¾ç¤ºé¤å…åˆ—è¡¨
                currentView = 'list';
                const filteredPois = getVisibleRatedPois();
                
                panelContent.innerHTML = `
                    <div class="info-panel-section">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <h3>ğŸ½ï¸ ${isLoggedIn ? 'æˆ‘çš„é¤å…' : 'é¤å…è¯„åˆ†'}</h3>
                            <button class="info-panel-btn" onclick="updateInfoPanel(null, 'stats')">ç»Ÿè®¡</button>
                        </div>
                        
                        <div class="filter-bar ${filterBarExpanded ? 'expanded' : ''}" id="filter-bar">
                            <div class="filter-bar-header" onclick="toggleFilterBar()">
                                <div class="filter-bar-title">
                                    ğŸ” ç­›é€‰æ¡ä»¶
                                    <span class="filter-summary">${getFilterSummary()}</span>
                                </div>
                                <div class="filter-bar-toggle">â–¼</div>
                            </div>
                            <div class="filter-bar-content">
                                <div class="filter-section">
                                    <div class="filter-section-title">
                                        â­ è¯„åˆ†ç­›é€‰
                                    </div>
                                    <div class="filter-section-content">
                                        ${RATE_TYPES.map(type => `
                                            <div class="filter-checkbox-container" onclick="toggleRateFilter('${type.value}')">
                                                <input type="checkbox" class="rate-filter" value="${type.value}" ${listFilterState[type.value] ? 'checked' : ''} onclick="event.stopPropagation(); toggleRateFilter('${type.value}');">
                                                <span>${type.value}</span>
                                            </div>
                                        `).join('')}
                                    </div>
                                    <div class="filter-actions">
                                        <button class="info-panel-btn" onclick="selectAllRateFilters()">å…¨é€‰</button>
                                        <button class="info-panel-btn" onclick="clearAllRateFilters()">å…¨ä¸é€‰</button>
                                    </div>
                                </div>
                                
                                <div class="filter-section">
                                    <div class="filter-section-title">
                                        ğŸ‘¤ ç”¨æˆ·ç­›é€‰
                                    </div>
                                    <div class="filter-section-content" id="user-filter-content">
                                        ${Object.keys(userFilterState).map(user => {
                                            // è·å–æ˜¾ç¤ºåç§°
                                            let displayName = user;
                                            if (user === 'self') {
                                                displayName = 'è‡ªå·±';
                                            } else if (user.startsWith('friend_')) {
                                                // ä»å¥½å‹åˆ—è¡¨ä¸­è·å–æ˜µç§°
                                                const friendId = userFilterMapping[user];
                                                const friend = window.friendsList ? window.friendsList.find(f => 
                                                    (f.friend_id === currentUser.id ? f.user_id : f.friend_id) === friendId
                                                ) : null;
                                                displayName = friend ? (friend.friend_id === currentUser.id ? friend.user_nickname : friend.friend_nickname) : `å¥½å‹${friendId.slice(0, 8)}`;
                                            }
                                            
                                            return `
                                                <div class="filter-checkbox-container" onclick="toggleUserFilter('${user}')">
                                                    <input type="checkbox" class="user-filter" value="${user}" ${userFilterState[user] ? 'checked' : ''} onclick="event.stopPropagation(); toggleUserFilter('${user}');">
                                                    <span>${displayName}</span>
                                                </div>
                                            `;
                                        }).join('')}
                                    </div>
                                    <div class="filter-actions">
                                        <button class="info-panel-btn" onclick="selectAllUserFilters()">å…¨é€‰</button>
                                        <button class="info-panel-btn" onclick="clearAllUserFilters()">å…¨ä¸é€‰</button>
                                        <button class="info-panel-btn" onclick="refreshUserFilters()">ğŸ”„ åˆ·æ–°å¥½å‹</button>
                                    </div>
                                </div>
                                
                                <!-- é¢„ç•™è·ç¦»ç­›é€‰ä½ç½® -->
                                <div class="filter-section" style="display: none;">
                                    <div class="filter-section-title">
                                        ğŸ“ è·ç¦»ç­›é€‰
                                    </div>
                                    <div class="filter-section-content">
                                        <div style="color: #999; font-size: 12px;">è·ç¦»ç­›é€‰åŠŸèƒ½å¼€å‘ä¸­...</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="info-panel-section">
                            <h4>é¤å…åˆ—è¡¨ (${filteredPois.length}ä¸ª)</h4>
                            <div class="restaurant-list">
                                ${filteredPois.length > 0 ? filteredPois.map(poi => {
                                    const rateType = RATE_TYPES.find(t => t.value === poi.rate);
                                    const isFriendReview = poi.is_friend_review;
                                    const reviewerName = isFriendReview ? poi.friend_nickname : 'æˆ‘';
                                    return `
                                        <div class="restaurant-item" onclick="showRestaurantDetail('${poi.uid}')">
                                            <div class="restaurant-header">
                                                <span class="restaurant-name">${poi.shortTitle || poi.title}</span>
                                                <div class="restaurant-rate-container">
                                                    ${isFriendReview ? `<span class="friend-badge">ğŸ‘¤ ${reviewerName}</span>` : ''}
                                                    <span class="restaurant-rate" style="color: ${rateType?.drop || '#666'}; white-space: nowrap;">${poi.rate}</span>
                                                </div>
                                            </div>
                                            <div class="restaurant-location">${poi.city || ''}${poi.area ? ' Â· ' + poi.area : ''}</div>
                                            <div class="restaurant-address">${poi.address || ''}</div>
                                        </div>
                                    `;
                                }).join('') : '<div style="text-align: center; color: #999; padding: 20px;">æš‚æ— è¯„åˆ†é¤å…</div>'}
                            </div>
                            ${filteredPois.length > 0 ? `
                            <div style="margin-top: 12px; text-align: center;">
                                ${!isLoggedIn ? `
                                    <button class="info-panel-btn" onclick="showModal('login-modal')" style="background: #1b8eec; color: #fff;">ç™»å½•åç®¡ç†è¯„åˆ†</button>
                                ` : `
                                    <button class="info-panel-btn" onclick="clearAllRatedPois()" style="background: #ff4d4f; color: #fff;">æ¸…é™¤æ‰€æœ‰è¯„åˆ†</button>
                                `}
                            </div>
                            ` : ''}
                        </div>
                    </div>
                `;
                

                
            } else if (poi) {
                // é€‰å®šé¤å…è‡ªåŠ¨ç¼©æ”¾åˆ°å¯¹åº”ä½ç½®
                if (poi.point) {
                    map.centerAndZoom(new BMapGL.Point(poi.point.lng, poi.point.lat), GLOBAL_DEFAULT_ZOOM);
                }
                // æ˜¾ç¤ºPOIè¯¦ç»†ä¿¡æ¯
                previousView = currentView; // ä¿å­˜ä¹‹å‰çš„è§†å›¾
                currentView = 'detail';
                currentPoi = poi;
                const title = getPoiField(poi, ['title', 'name']);
                const shortTitle = getShortTitle(title);
                const city = getPoiField(poi, ['city', 'cityname']);
                const area = getPoiField(poi, ['area', 'areaname', 'district']);
                const address = getPoiField(poi, ['address', 'addr']);
                const phoneNumber = getPoiField(poi, ['phoneNumber', 'phone', 'tel']);
                const tags = getPoiField(poi, ['tags', 'std_tag', 'tag']) || [];
                const tagArray = Array.isArray(tags) ? tags : (typeof tags === 'string' ? tags.split(',').map(t => t.trim()) : []);
                
                // æ£€æŸ¥æ‰€æœ‰ç›¸å…³è¯„åˆ†
                const allReviews = window.ratedPois.filter(rp => rp.uid === poi.uid);
                // è·å–æˆ‘çš„è¯„åˆ†
                const myReview = allReviews.find(rp => rp.user_id === currentUser?.id);
                // è·å–æ‰€æœ‰å¥½å‹è¯„åˆ†
                const friendReviews = allReviews.filter(rp => rp.is_friend_review && rp.user_id !== currentUser?.id);
                
                console.log('Reviews for POI:', {
                    all: allReviews,
                    my: myReview,
                    friends: friendReviews
                });
                
                panelContent.innerHTML = `
                    <!-- 1. é¤å…è¯¦æƒ…éƒ¨åˆ† -->
                    <div class="info-panel-section">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <h3>ğŸ“ é¤å…è¯¦æƒ…</h3>
                            <button class="info-panel-btn" onclick="goBackFromDetail()">è¿”å›</button>
                        </div>
                        
                        <div class="info-panel-item">
                            <span class="info-panel-label">åç§°</span>
                            <span class="info-panel-value">${shortTitle || title || ''}</span>
                        </div>
                        <div class="info-panel-item">
                            <span class="info-panel-label">ä½ç½®</span>
                            <span class="info-panel-value">${city || ''}${area ? ' Â· ' + area : ''}</span>
                        </div>
                        <div class="info-panel-item">
                            <span class="info-panel-label">åœ°å€</span>
                            <span class="info-panel-value">${address || ''}</span>
                        </div>
                        ${phoneNumber ? `
                        <div class="info-panel-item">
                            <span class="info-panel-label">ç”µè¯</span>
                            <span class="info-panel-value">${phoneNumber}</span>
                        </div>
                        ` : ''}
                        ${tagArray.length > 0 ? `
                        <div class="info-panel-item">
                            <span class="info-panel-label">æ ‡ç­¾</span>
                            <div class="info-panel-tags">
                                ${tagArray.map(tag => `<span class="info-panel-tag">${tag}</span>`).join('')}
                            </div>
                        </div>
                        ` : ''}
                    </div>
                    
                    <!-- 2. å¥½å‹è¯„åˆ†éƒ¨åˆ†ï¼ˆä»…å½“æœ‰å¥½å‹è¯„åˆ†æ—¶æ˜¾ç¤ºï¼‰ -->
                    ${friendReviews.length > 0 ? `
                    <div class="info-panel-section">
                        <h3>ğŸ‘¥ å¥½å‹è¯„åˆ†</h3>
                        ${friendReviews.map(friendReview => `
                            <div class="info-panel-item">
                                <span class="info-panel-label">${friendReview.friend_nickname}</span>
                                <div class="info-panel-value-container">
                                    <span class="info-panel-value" style="color: ${RATE_TYPES.find(t => t.value === friendReview.rate)?.drop || '#666'}; white-space: nowrap;">${friendReview.rate}</span>
                                </div>
                            </div>
                            ${friendReview.review_text ? `
                            <div class="info-panel-item" style="margin-top: 4px;">
                                <span class="info-panel-label"></span>
                                <div class="info-panel-value-container">
                                    <span class="info-panel-value" style="color: #666; font-size: 12px; font-style: italic;">"${friendReview.review_text}"</span>
                                </div>
                            </div>
                            ` : ''}
                        `).join('')}
                    </div>
                    ` : ''}
                    
                    <!-- 3. è¯„åˆ†æ“ä½œéƒ¨åˆ† -->
                    <div class="info-panel-section">
                        <h3>â­ è¯„åˆ†æ“ä½œ</h3>
                        ${!isLoggedIn ? `
                            <div style="text-align: center; padding: 20px; background: #f8f9fa; border-radius: 8px; margin-bottom: 12px;">
                                <div style="color: #666; margin-bottom: 12px;">è¯·å…ˆç™»å½•æ‰èƒ½è¿›è¡Œè¯„åˆ†</div>
                                <button class="info-panel-btn" onclick="showModal('login-modal')" style="background: #1b8eec; color: #fff;">ç«‹å³ç™»å½•</button>
                            </div>
                        ` : `
                            ${myReview ? `
                                <div class="info-panel-item">
                                    <span class="info-panel-label">æˆ‘çš„è¯„åˆ†</span>
                                    <div class="info-panel-value-container">
                                        <span class="info-panel-value" style="color: ${RATE_TYPES.find(t => t.value === myReview.rate)?.drop || '#666'}; white-space: nowrap;">${myReview.rate}</span>
                                    </div>
                                </div>
                            ` : `
                                <div class="info-panel-item">
                                    <span class="info-panel-label">æˆ‘çš„è¯„åˆ†</span>
                                    <span class="info-panel-value" style="color: #999;">æœªè¯„åˆ†</span>
                                </div>
                            `}
                            <div style="margin-top: 12px;">
                                ${RATE_TYPES.map(t => `
                                    <button class="info-panel-btn rate-btn" data-rate="${t.value}" style="background:${t.drop};color:${t.star === 'black' ? '#000' : '#fff'};margin-right:8px;margin-bottom:8px;">${t.value}</button>
                                `).join('')}
                                ${myReview ? `
                                    <button class="info-panel-btn" id="remove-rate-btn" style="background:#bbb;color:#fff;margin-bottom:8px;">å–æ¶ˆè¯„ä»·</button>
                                ` : ''}
                            </div>
                        `}
                    </div>
                    
                    <div class="info-panel-section">
                        <h3>ğŸ“ åæ ‡ä¿¡æ¯</h3>
                        <div class="info-panel-item">
                            <span class="info-panel-label">ç»åº¦</span>
                            <span class="info-panel-value">${poi.point ? poi.point.lng.toFixed(6) : ''}</span>
                        </div>
                        <div class="info-panel-item">
                            <span class="info-panel-label">çº¬åº¦</span>
                            <span class="info-panel-value">${poi.point ? poi.point.lat.toFixed(6) : ''}</span>
                        </div>
                    </div>
                `;
                
                // ç®€åŒ–ï¼šç›´æ¥ç»‘å®šè¯„åˆ†æŒ‰é’®äº‹ä»¶ï¼Œä¸ä½¿ç”¨å»¶è¿Ÿ
                const rateBtns = panelContent.querySelectorAll('.rate-btn');
                const removeBtn = panelContent.querySelector('#remove-rate-btn');
                
                rateBtns.forEach(btn => {
                    btn.onclick = async function() {
                        if (!isLoggedIn) {
                            showModal('login-modal');
                            return;
                        }
                        const rate = btn.getAttribute('data-rate');
                        
                        // æ·»åŠ åŠ è½½çŠ¶æ€
                        const originalText = btn.textContent;
                        btn.textContent = 'ä¿å­˜ä¸­...';
                        btn.disabled = true;
                        
                        try {
                            console.log('Adding rating:', { poi, rate });
                            // åˆ›å»ºæ–°çš„è¯„åˆ†æ•°æ®ï¼Œç¡®ä¿æ˜¯è‡ªå·±çš„è¯„åˆ†
                            await addOrUpdateRatedPoi(poi, rate);
                            // æ›´æ–°ç­›é€‰çŠ¶æ€å’Œåœ°å›¾æ ‡è®°
                            updateFilterState();
                            updateMapMarkers();
                        } finally {
                            // æ¢å¤æŒ‰é’®çŠ¶æ€
                            btn.textContent = originalText;
                            btn.disabled = false;
                        }
                    }
                });
                
                if (removeBtn) {
                    removeBtn.onclick = async function() {
                        if (!isLoggedIn) {
                            showModal('login-modal');
                            return;
                        }
                        
                        // æ·»åŠ åŠ è½½çŠ¶æ€
                        const originalText = removeBtn.textContent;
                        removeBtn.textContent = 'åˆ é™¤ä¸­...';
                        removeBtn.disabled = true;
                        
                        try {
                            await removeRatedPoi(poi.uid);
                        } finally {
                            // æ¢å¤æŒ‰é’®çŠ¶æ€
                            removeBtn.textContent = originalText;
                            removeBtn.disabled = false;
                        }
                    }
                }
            }
        }
        
        function getRatedPoisStats() {
            // åªç»Ÿè®¡å½“å‰ç”¨æˆ·çš„è¯„åˆ†
            const myRatedPois = window.ratedPois.filter(poi => poi.user_id === currentUser?.id);
            
            const stats = {
                total: myRatedPois.length,
                cities: new Set(myRatedPois.map(p => p.city).filter(c => c)).size,
                rateCounts: {},
                cityCounts: {}
            };
            
            myRatedPois.forEach(poi => {
                // ç»Ÿè®¡è¯„åˆ†åˆ†å¸ƒ
                stats.rateCounts[poi.rate] = (stats.rateCounts[poi.rate] || 0) + 1;
                
                // ç»Ÿè®¡åŸå¸‚åˆ†å¸ƒ
                if (poi.city) {
                    stats.cityCounts[poi.city] = (stats.cityCounts[poi.city] || 0) + 1;
                }
            });
            
            return stats;
        }
        
        // ä¿å­˜ç­›é€‰å™¨çŠ¶æ€
        let listFilterState = {
            'è¶…çˆ±': true,
            'å–œæ¬¢': true,
            'ä¸€èˆ¬': true,
            'ä¸ä¼šå†å»äº†': true
        };
        
        // ä¿å­˜ç”¨æˆ·ç­›é€‰å™¨çŠ¶æ€ - æ˜ å°„æ˜¾ç¤ºåç§°åˆ°ç”¨æˆ·ID
        let userFilterState = {
            self: currentUser ? currentUser.id : null
        };
        
        // ç”¨æˆ·ç­›é€‰å™¨æ˜¾ç¤ºåç§°åˆ°ç”¨æˆ·IDçš„æ˜ å°„
        let userFilterMapping = {
            self: currentUser ? currentUser.id : null
        };
        
        // ä¿å­˜ç­›é€‰æ¡å±•å¼€çŠ¶æ€
        let filterBarExpanded = false;
        
        // åˆå§‹åŒ–ç­›é€‰çŠ¶æ€ - é»˜è®¤å…¨é€‰
        function initializeFilterState() {
            // è¯„åˆ†ç­›é€‰çŠ¶æ€ - é»˜è®¤å…¨é€‰
            listFilterState = {
                'è¶…çˆ±': true,
                'å–œæ¬¢': true,
                'ä¸€èˆ¬': true,
                'ä¸ä¼šå†å»äº†': true
            };
            
            // ç”¨æˆ·ç­›é€‰çŠ¶æ€ - é»˜è®¤åªé€‰è‡ªå·±
            userFilterState = {
                self: true
            };
            
            // ç”¨æˆ·æ˜ å°„
            userFilterMapping = {
                self: currentUser ? currentUser.id : null
            };
            
            // æ›´æ–°ç­›é€‰çŠ¶æ€
            updateFilterState();
        }
        
        // ç­›é€‰æ¡ç›¸å…³å‡½æ•°
        window.toggleFilterBar = function() {
            filterBarExpanded = !filterBarExpanded;
            const filterBar = document.getElementById('filter-bar');
            if (filterBar) {
                if (filterBarExpanded) {
                    filterBar.classList.add('expanded');
                } else {
                    filterBar.classList.remove('expanded');
                }
            }
        };
        
        function getFilterSummary() {
            const checkedRates = Object.keys(listFilterState).filter(key => listFilterState[key]);
            const checkedUsers = Object.keys(userFilterState).filter(key => userFilterState[key]);
            return `${checkedRates.length}ä¸ªè¯„åˆ†ç±»å‹, ${checkedUsers.length}ä¸ªç”¨æˆ·`;
        }
        
        // è¯„åˆ†ç­›é€‰ç›¸å…³å‡½æ•°
        window.selectAllRateFilters = function() {
            RATE_TYPES.forEach(type => {
                listFilterState[type.value] = true;
            });
            updateFilterState();
            updateInfoPanel(null, 'list');
            updateMapMarkers();
        };
        
        window.clearAllRateFilters = function() {
            RATE_TYPES.forEach(type => {
                listFilterState[type.value] = false;
            });
            updateFilterState();
            updateInfoPanel(null, 'list');
            updateMapMarkers();
        };
        
        window.toggleRateFilter = function(value) {
            listFilterState[value] = !listFilterState[value];
            updateFilterState();
            updateInfoPanel(null, 'list');
            updateMapMarkers();
        };
        
        // ç”¨æˆ·ç­›é€‰ç›¸å…³å‡½æ•°
        window.selectAllUserFilters = function() {
            Object.keys(userFilterState).forEach(user => {
                userFilterState[user] = true;
            });
            updateFilterState();
            updateInfoPanel(null, 'list');
            updateMapMarkers();
        };
        
        window.clearAllUserFilters = function() {
            Object.keys(userFilterState).forEach(user => {
                userFilterState[user] = false;
            });
            updateFilterState();
            console.log('After clearing user filters:', {
                userFilterState,
                userFilterMapping,
                filterState: window.filterState
            });
            updateInfoPanel(null, 'list');
            updateMapMarkers();
        };
        
        window.toggleUserFilter = function(value) {
            // å¦‚æœç”¨æˆ·æœªç™»å½•ï¼Œæ˜¾ç¤ºç™»å½•æç¤º
            if (!isLoggedIn || !currentUser) {
                showModal('login-modal');
                return;
            }
            
            // ç¡®ä¿æ˜ å°„å­˜åœ¨
            if (!userFilterMapping[value]) {
                userFilterMapping[value] = currentUser.id;
            }
            
            userFilterState[value] = !userFilterState[value]; // åˆ‡æ¢é€‰ä¸­çŠ¶æ€
            
            updateFilterState();
            updateInfoPanel(null, 'list');
            updateMapMarkers();
        };
        
        // å…¼å®¹æ—§å‡½æ•°å
        window.selectAllFilters = window.selectAllRateFilters;
        window.clearAllFilters = window.clearAllRateFilters;
        window.toggleFilter = window.toggleRateFilter;
        
        window.showRestaurantDetail = function(uid) {
            const poi = window.ratedPois.find(p => p.uid === uid);
            if (poi) {
                updateInfoPanel(poi, 'detail');
            }
        };
        
        window.clearAllRatedPois = async function() {
            // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²ç™»å½•
            if (!isLoggedIn) {
                showModal('login-modal');
                return;
            }
            
            if (confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰è¯„åˆ†å—ï¼Ÿ')) {
                try {
                    // ä»Supabaseåˆ é™¤æ‰€æœ‰è¯„åˆ†
                    const { error } = await supabase
                        .from('restaurant_reviews')
                        .delete()
                        .eq('user_id', currentUser.id);
                    
                    if (error) {
                        console.error('æ¸…é™¤æ‰€æœ‰è¯„åˆ†é”™è¯¯:', error);
                        alert('æ¸…é™¤è¯„åˆ†å¤±è´¥ï¼Œè¯·é‡è¯•');
                        return;
                    }
                    
                    // æ›´æ–°æœ¬åœ°æ•°æ®
                    window.ratedPois = [];
                    updateFilterState();
                    updateMapMarkers();
                    updateInfoPanel(null, 'list');
                } catch (error) {
                    console.error('æ¸…é™¤æ‰€æœ‰è¯„åˆ†å¤±è´¥:', error);
                    alert('æ¸…é™¤è¯„åˆ†å¤±è´¥ï¼Œè¯·é‡è¯•');
                }
            }
        };
        
        window.showSearchResultDetail = function(uid) {
            // ä»å½“å‰æœç´¢ç»“æœä¸­æŸ¥æ‰¾å¯¹åº”çš„POI
            const poi = currentSearchResults.find(p => p.uid === uid);
            if (poi) {
                updateInfoPanel(poi, 'detail');
            }
        };
        
        window.goBackFromDetail = function() {
            // æ ¹æ®ä¹‹å‰çš„è§†å›¾å†³å®šè¿”å›åˆ°å“ªé‡Œ
            if (previousView === 'search' && currentSearchResults.length > 0) {
                updateInfoPanel(null, 'search', currentSearchResults);
            } else {
                updateInfoPanel(null, 'list');
            }
        };
        
        window.loadMoreSearchResults = function() {
            currentSearchPage++;
            localSearch.gotoPage(currentSearchPage);
        };
        
        window.goToMyRestaurants = function() {
            // æ¸…ç©ºæœç´¢ç›¸å…³çŠ¶æ€
            currentSearchResults = [];
            currentSearchKeyword = '';
            currentSearchPage = 0;
            hasMoreSearchResults = false;
            // æ¸…é™¤åœ°å›¾ä¸Šçš„æœç´¢æ ‡è®°
            clearPoiMarkers();
            // é‡ç½®åˆ°æ˜¾ç¤ºæ‰€æœ‰è¯„åˆ†é¤å…çš„è§†å›¾èŒƒå›´
            updateMapViewportForRatedPois();
            // ä¿¡æ¯é¢æ¿å›åˆ°é¤å…åˆ—è¡¨
            updateInfoPanel(null, 'list');
        };
        
        // ===================== è¾…åŠ©åŠŸèƒ½ =====================
        // åœ¨æ§åˆ¶å°æŸ¥çœ‹è¯„åˆ†æ•°æ®
        window.showRatedPois = function() {
            console.log('å½“å‰è¯„åˆ†POIåˆ—è¡¨:', window.ratedPois);
            console.log('localStorageä¸­çš„è¯„åˆ†æ•°æ®:', localStorage.getItem('ratedPois'));
        };
        
        // åœ¨æ§åˆ¶å°æŸ¥çœ‹ç­›é€‰å™¨çŠ¶æ€
        window.showFilterState = function() {
            console.log('è¯„åˆ†ç­›é€‰å™¨çŠ¶æ€:', listFilterState);
            console.log('ç”¨æˆ·ç­›é€‰å™¨çŠ¶æ€:', userFilterState);
            console.log('ç”¨æˆ·ç­›é€‰å™¨æ˜ å°„:', userFilterMapping);
            console.log('å½“å‰ç”¨æˆ·:', currentUser);
            console.log('å½“å‰è§†å›¾:', currentView);
            console.log('ç­›é€‰åçš„é¤å…æ•°é‡:', getVisibleRatedPois().length);
            const myRatedPois = window.ratedPois.filter(poi => poi.user_id === currentUser?.id);
            console.log('æˆ‘çš„é¤å…æ•°é‡:', myRatedPois.length);
            console.log('è¯„åˆ†æ•°æ®:', window.ratedPois);
        };
        

        
        // æ¸…ç†localStorage
        window.clearLocalStorage = function() {
            if (confirm('ç¡®å®šè¦æ¸…ç†localStorageä¸­çš„æ‰€æœ‰æ•°æ®å—ï¼Ÿ')) {
                localStorage.clear();
                console.log('localStorageå·²æ¸…ç†');
            }
        };
        
        // ===================== é¡µé¢å…¥å£ =====================
        window.onload = async function() {
            // åŠ è½½ç”¨æˆ·ä¼šè¯
            loadUserSession();
            
            // åˆå§‹åŒ–ç­›é€‰çŠ¶æ€
            initializeFilterState();
            
            // åˆå§‹åŒ–å¥½å‹API
            if (isLoggedIn && currentUser) {
                initFriendshipAPI();
            }
            
            // åˆå§‹åŒ–åœ°å›¾
            initMap();
            bindUIEvents();
            bindAuthEvents(); // ç»‘å®šè®¤è¯ç›¸å…³äº‹ä»¶
            bindFriendsEvents(); // ç»‘å®šå¥½å‹ç®¡ç†äº‹ä»¶
            
            // å¦‚æœç”¨æˆ·å·²ç™»å½•ï¼ŒåŠ è½½è¯„åˆ†æ•°æ®
            if (isLoggedIn) {
                await loadRatedPois();
                updateFilterState();
                updateMapMarkers();
                updateMapViewportForRatedPois();
            }
            
            // åˆå§‹åŒ–ä¿¡æ¯é¢æ¿ï¼Œæ˜¾ç¤ºé¤å…åˆ—è¡¨
            updateInfoPanel(null, 'list');
            
            // ç¡®ä¿ä¿¡æ¯é¢æ¿é»˜è®¤å±•å¼€æ˜¾ç¤º
            document.getElementById('info-panel').classList.remove('collapsed');
            
            // å¦‚æœç”¨æˆ·æœªç™»å½•ï¼Œæ˜¾ç¤ºæ¬¢è¿å¼¹çª—
            if (!isLoggedIn) {
                setTimeout(() => {
                    showWelcomeModal();
                }, 500);
            }
            
            // åœ¨æ§åˆ¶å°æ˜¾ç¤ºè¾…åŠ©å‡½æ•°
            console.log('è¾…åŠ©å‡½æ•°å·²åŠ è½½:');
            console.log('- showRatedPois(): æŸ¥çœ‹è¯„åˆ†æ•°æ®');
            console.log('- showFilterState(): æŸ¥çœ‹ç­›é€‰å™¨çŠ¶æ€');
            console.log('- clearLocalStorage(): æ¸…ç†localStorage');
            console.log('- æŒ‰ I é”®æˆ–ç‚¹å‡»æ ‡é¢˜æ å¯åˆ‡æ¢ä¿¡æ¯é¢æ¿æ˜¾ç¤ºçŠ¶æ€');
        }
        
        // ===================== ä¸ªäººä¿¡æ¯ç®¡ç†åŠŸèƒ½ =====================
        
        // æ˜¾ç¤ºä¸ªäººä¿¡æ¯æ¨¡æ€æ¡†
        window.showProfileModal = function() {
            if (!isLoggedIn || !currentUser) {
                showModal('login-modal');
                return;
            }
            
            showModal('profile-modal');
            loadProfileInfo();
        };
        
        // åŠ è½½ä¸ªäººä¿¡æ¯
        async function loadProfileInfo() {
            try {
                // æ˜¾ç¤ºå¤´åƒï¼ˆæ˜µç§°é¦–å­—æ¯ï¼‰
                const avatarCircle = document.getElementById('profile-avatar-circle');
                const nickname = currentUser.nickname || 'ç”¨æˆ·';
                avatarCircle.textContent = nickname.charAt(0).toUpperCase();
                
                // æ˜¾ç¤ºåŸºæœ¬ä¿¡æ¯
                document.getElementById('profile-nickname').textContent = currentUser.nickname || 'æœªè®¾ç½®';
                document.getElementById('profile-unique-id').textContent = currentUser.unique_id || 'æœªè®¾ç½®';
                
                // æ ¼å¼åŒ–æ³¨å†Œæ—¶é—´
                const createdAt = currentUser.created_at ? new Date(currentUser.created_at) : new Date();
                document.getElementById('profile-created-at').textContent = createdAt.toLocaleDateString('zh-CN');
                
                // è·å–è¯„åˆ†ç»Ÿè®¡
                const myRatedPois = window.ratedPois.filter(poi => poi.user_id === currentUser?.id);
                const ratingCount = myRatedPois.length;
                document.getElementById('profile-rating-count').textContent = `${ratingCount} ä¸ªé¤å…è¯„åˆ†`;
                
            } catch (error) {
                console.error('åŠ è½½ä¸ªäººä¿¡æ¯å¤±è´¥:', error);
                alert('åŠ è½½ä¸ªäººä¿¡æ¯å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }
        
        // å¤åˆ¶å”¯ä¸€ID
        window.copyUniqueId = function() {
            const uniqueId = currentUser.unique_id;
            if (!uniqueId) {
                alert('å”¯ä¸€IDæœªè®¾ç½®');
                return;
            }
            
            // å¤åˆ¶åˆ°å‰ªè´´æ¿
            navigator.clipboard.writeText(uniqueId).then(() => {
                const copyBtn = document.querySelector('.copy-btn');
                const originalText = copyBtn.textContent;
                copyBtn.textContent = 'å·²å¤åˆ¶';
                copyBtn.classList.add('copied');
                
                setTimeout(() => {
                    copyBtn.textContent = originalText;
                    copyBtn.classList.remove('copied');
                }, 2000);
            }).catch(() => {
                // å¦‚æœå‰ªè´´æ¿APIä¸å¯ç”¨ï¼Œä½¿ç”¨ä¼ ç»Ÿæ–¹æ³•
                const textArea = document.createElement('textarea');
                textArea.value = uniqueId;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                
                const copyBtn = document.querySelector('.copy-btn');
                const originalText = copyBtn.textContent;
                copyBtn.textContent = 'å·²å¤åˆ¶';
                copyBtn.classList.add('copied');
                
                setTimeout(() => {
                    copyBtn.textContent = originalText;
                    copyBtn.classList.remove('copied');
                }, 2000);
            });
        };
        
        // æ‰‹åŠ¨åˆ·æ–°å¥½å‹åˆ—è¡¨
        window.refreshFriendsList = function() {
            console.log('æ‰‹åŠ¨åˆ·æ–°å¥½å‹åˆ—è¡¨');
            loadFriendsList();
        };
        
        // æ‰‹åŠ¨åˆ·æ–°å¥½å‹è¯·æ±‚
        window.refreshFriendRequests = function() {
            console.log('æ‰‹åŠ¨åˆ·æ–°å¥½å‹è¯·æ±‚');
            loadFriendRequests();
        };
        
        // ===================== å¥½å‹ç®¡ç†åŠŸèƒ½ =====================
        let friendshipAPI = null;
        
        // åˆå§‹åŒ–å¥½å‹API
        function initFriendshipAPI() {
            if (isLoggedIn && currentUser) {
                friendshipAPI = new FriendshipAPI(supabase);
            }
        }
        
        // æ˜¾ç¤ºå¥½å‹ç®¡ç†æ¨¡æ€æ¡†
        window.showFriendsModal = function() {
            if (!isLoggedIn || !currentUser) {
                showModal('login-modal');
                return;
            }
            
            if (!friendshipAPI) {
                initFriendshipAPI();
            }
            
            showModal('friends-modal');
            loadFriendsList();
            loadFriendRequests();
            
            // å¯åŠ¨è‡ªåŠ¨åˆ·æ–°
            startAutoRefresh();
        };
        
        // è‡ªåŠ¨åˆ·æ–°ç›¸å…³å˜é‡
        let autoRefreshInterval = null;
        let lastFriendsCount = 0;
        let lastRequestsCount = 0;
        
        // å¯åŠ¨è‡ªåŠ¨åˆ·æ–°
        function startAutoRefresh() {
            // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
            }
            
            // æ¯5ç§’æ£€æŸ¥ä¸€æ¬¡æ›´æ–°
            autoRefreshInterval = setInterval(async () => {
                try {
                    // æ£€æŸ¥å¥½å‹åˆ—è¡¨æ˜¯å¦æœ‰æ›´æ–°
                    const friends = await friendshipAPI.getFriendsList(currentUser.id);
                    const requests = await friendshipAPI.getReceivedRequests(currentUser.id);
                    
                    // å¦‚æœæ•°é‡å‘ç”Ÿå˜åŒ–ï¼Œè‡ªåŠ¨åˆ·æ–°
                    if (friends.length !== lastFriendsCount) {
                        console.log('æ£€æµ‹åˆ°å¥½å‹åˆ—è¡¨æ›´æ–°ï¼Œè‡ªåŠ¨åˆ·æ–°');
                        loadFriendsList();
                        lastFriendsCount = friends.length;
                    }
                    
                    if (requests.length !== lastRequestsCount) {
                        console.log('æ£€æµ‹åˆ°å¥½å‹è¯·æ±‚æ›´æ–°ï¼Œè‡ªåŠ¨åˆ·æ–°');
                        loadFriendRequests();
                        lastRequestsCount = requests.length;
                    }
                } catch (error) {
                    console.error('è‡ªåŠ¨åˆ·æ–°æ£€æŸ¥å¤±è´¥:', error);
                }
            }, 5000); // 5ç§’æ£€æŸ¥ä¸€æ¬¡
        }
        
        // åœæ­¢è‡ªåŠ¨åˆ·æ–°
        function stopAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
            }
        }
        
        // åŠ è½½å¥½å‹åˆ—è¡¨
        async function loadFriendsList() {
            const friendsList = document.getElementById('friends-list');
            friendsList.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';
            
            try {
                const friends = await friendshipAPI.getFriendsList(currentUser.id);
                lastFriendsCount = friends.length; // æ›´æ–°è®¡æ•°
                
                if (friends.length === 0) {
                    friendsList.innerHTML = '<div class="empty-state">æš‚æ— å¥½å‹</div>';
                    return;
                }
                
                friendsList.innerHTML = friends.map(friend => `
                    <div class="friend-item">
                        <div class="friend-avatar">${friend.friend_nickname ? friend.friend_nickname.charAt(0) : '?'}</div>
                        <div class="friend-info">
                            <div class="friend-name">${friend.friend_nickname || 'æœªçŸ¥ç”¨æˆ·'}</div>
                            <div class="friend-id">@${friend.friend_unique_id}</div>
                        </div>
                        <div class="friend-actions">
                            <button class="friend-action-btn remove" onclick="removeFriend('${friend.friend_id}')">åˆ é™¤</button>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('åŠ è½½å¥½å‹åˆ—è¡¨å¤±è´¥:', error);
                friendsList.innerHTML = '<div class="empty-state">åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•</div>';
            }
        }
        
        // åŠ è½½å¥½å‹è¯·æ±‚
        async function loadFriendRequests() {
            const requestsList = document.getElementById('friend-requests-list');
            requestsList.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';
            
            try {
                const requests = await friendshipAPI.getReceivedRequests(currentUser.id);
                lastRequestsCount = requests.length; // æ›´æ–°è®¡æ•°
                
                if (requests.length === 0) {
                    requestsList.innerHTML = '<div class="empty-state">æš‚æ— å¥½å‹è¯·æ±‚</div>';
                    return;
                }
                
                requestsList.innerHTML = requests.map(request => `
                    <div class="friend-item">
                        <div class="friend-avatar">${request.sender_nickname ? request.sender_nickname.charAt(0) : '?'}</div>
                        <div class="friend-info">
                            <div class="friend-name">${request.sender_nickname || 'æœªçŸ¥ç”¨æˆ·'}</div>
                            <div class="friend-id">@${request.sender_unique_id}</div>
                            <div class="friend-message">${request.message || 'è¯·æ±‚æ·»åŠ æ‚¨ä¸ºå¥½å‹'}</div>
                        </div>
                        <div class="friend-actions">
                            <button class="friend-action-btn accept" onclick="acceptFriendRequest('${request.request_id}')">æ¥å—</button>
                            <button class="friend-action-btn reject" onclick="rejectFriendRequest('${request.request_id}')">æ‹’ç»</button>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('åŠ è½½å¥½å‹è¯·æ±‚å¤±è´¥:', error);
                requestsList.innerHTML = '<div class="empty-state">åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•</div>';
            }
        }
        
        // åˆ é™¤å¥½å‹
        window.removeFriend = async function(friendId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå¥½å‹å—ï¼Ÿ')) {
                return;
            }
            
            try {
                console.log('åˆ é™¤å¥½å‹:', currentUser.id, '->', friendId);
                await friendshipAPI.removeFriend(currentUser.id, friendId);
                alert('å¥½å‹åˆ é™¤æˆåŠŸ');
                loadFriendsList();
            } catch (error) {
                console.error('åˆ é™¤å¥½å‹å¤±è´¥:', error);
                alert('åˆ é™¤å¥½å‹å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        };
        
        // æ¥å—å¥½å‹è¯·æ±‚
        window.acceptFriendRequest = async function(requestId) {
            try {
                console.log('æ¥å—å¥½å‹è¯·æ±‚:', requestId, 'æ¥æ”¶è€…:', currentUser.id);
                const result = await friendshipAPI.acceptFriendRequest(requestId, currentUser.id);
                alert('å¥½å‹è¯·æ±‚å·²æ¥å—');
                loadFriendRequests();
                loadFriendsList();
                
                // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯ï¼Œæç¤ºç”¨æˆ·åˆ·æ–°
                const successDiv = document.createElement('div');
                successDiv.style.cssText = 'background: #d4edda; color: #155724; padding: 12px; border-radius: 6px; margin-bottom: 16px; text-align: center;';
                successDiv.innerHTML = 'å¥½å‹è¯·æ±‚å·²æ¥å—ï¼æ–°å¥½å‹å·²æ·»åŠ åˆ°æ‚¨çš„å¥½å‹åˆ—è¡¨ä¸­ã€‚';
                document.getElementById('friends-list-tab').insertBefore(successDiv, document.getElementById('friends-list'));
                setTimeout(() => successDiv.remove(), 3000);
                
            } catch (error) {
                console.error('æ¥å—å¥½å‹è¯·æ±‚å¤±è´¥:', error);
                alert('æ¥å—å¥½å‹è¯·æ±‚å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        };
        
        // æ‹’ç»å¥½å‹è¯·æ±‚
        window.rejectFriendRequest = async function(requestId) {
            try {
                console.log('æ‹’ç»å¥½å‹è¯·æ±‚:', requestId, 'æ¥æ”¶è€…:', currentUser.id);
                await friendshipAPI.rejectFriendRequest(requestId, currentUser.id);
                alert('å¥½å‹è¯·æ±‚å·²æ‹’ç»');
                loadFriendRequests();
            } catch (error) {
                console.error('æ‹’ç»å¥½å‹è¯·æ±‚å¤±è´¥:', error);
                alert('æ‹’ç»å¥½å‹è¯·æ±‚å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        };
        
        // æœç´¢ç”¨æˆ·
        window.searchUser = async function() {
            const userId = document.getElementById('search-user-id').value.trim();
            const searchResult = document.getElementById('search-result');
            
            if (!userId) {
                alert('è¯·è¾“å…¥ç”¨æˆ·å”¯ä¸€ID');
                return;
            }
            
            searchResult.innerHTML = '<div class="loading">æœç´¢ä¸­...</div>';
            
            try {
                console.log('æœç´¢ç”¨æˆ·:', userId, 'å½“å‰ç”¨æˆ·ID:', currentUser.id);
                const user = await friendshipAPI.getUserByUniqueId(userId, currentUser.id);
                console.log('æœç´¢ç»“æœ:', user);
                
                if (!user) {
                    searchResult.innerHTML = '<div class="empty-state">æœªæ‰¾åˆ°è¯¥ç”¨æˆ·</div>';
                    return;
                }
                
                // æ£€æŸ¥æ˜¯å¦å·²ç»æ˜¯å¥½å‹
                console.log('æ£€æŸ¥å¥½å‹å…³ç³»:', currentUser.id, user.id);
                const isFriend = await friendshipAPI.checkFriendship(currentUser.id, user.id);
                console.log('æ˜¯å¦å·²æ˜¯å¥½å‹:', isFriend);
                
                searchResult.innerHTML = `
                    <div class="friend-item">
                        <div class="friend-avatar">${user.nickname ? user.nickname.charAt(0) : '?'}</div>
                        <div class="friend-info">
                            <div class="friend-name">${user.nickname || 'æœªçŸ¥ç”¨æˆ·'}</div>
                            <div class="friend-id">@${user.unique_id}</div>
                        </div>
                        <div class="friend-actions">
                            ${isFriend ? 
                                '<span style="color: #52c41a;">å·²æ˜¯å¥½å‹</span>' : 
                                '<button class="friend-action-btn send" onclick="sendFriendRequest(\'' + user.id + '\')">å‘é€è¯·æ±‚</button>'
                            }
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error('æœç´¢ç”¨æˆ·å¤±è´¥:', error);
                searchResult.innerHTML = '<div class="empty-state">æœç´¢å¤±è´¥ï¼Œè¯·é‡è¯•</div>';
            }
        };
        
        // å‘é€å¥½å‹è¯·æ±‚
        window.sendFriendRequest = async function(userId) {
            try {
                console.log('å‘é€å¥½å‹è¯·æ±‚:', currentUser.id, '->', userId);
                await friendshipAPI.sendFriendRequest(currentUser.id, userId, 'ä½ å¥½ï¼Œæˆ‘æƒ³åŠ ä½ ä¸ºå¥½å‹');
                alert('å¥½å‹è¯·æ±‚å·²å‘é€');
                document.getElementById('search-result').innerHTML = '<div class="empty-state">è¯·æ±‚å·²å‘é€ï¼Œç­‰å¾…å¯¹æ–¹å›å¤</div>';
            } catch (error) {
                console.error('å‘é€å¥½å‹è¯·æ±‚å¤±è´¥:', error);
                alert('å‘é€å¥½å‹è¯·æ±‚å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        };
        
        // ç»‘å®šå¥½å‹ç®¡ç†äº‹ä»¶
        function bindFriendsEvents() {
            // å¥½å‹æ¨¡æ€æ¡†å…³é—­æŒ‰é’®
            document.getElementById('friends-modal-close').addEventListener('click', () => {
                hideModal('friends-modal');
                stopAutoRefresh(); // åœæ­¢è‡ªåŠ¨åˆ·æ–°
            });
            
            // ä¸ªäººä¿¡æ¯æ¨¡æ€æ¡†å…³é—­æŒ‰é’®
            document.getElementById('profile-modal-close').addEventListener('click', () => {
                hideModal('profile-modal');
            });
            
            // æ ‡ç­¾é¡µåˆ‡æ¢
            document.querySelectorAll('.friends-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    // ç§»é™¤æ‰€æœ‰æ´»åŠ¨çŠ¶æ€
                    document.querySelectorAll('.friends-tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.friends-tab-content').forEach(c => c.classList.remove('active'));
                    
                    // æ·»åŠ å½“å‰æ´»åŠ¨çŠ¶æ€
                    tab.classList.add('active');
                    const tabId = tab.getAttribute('data-tab') + '-tab';
                    document.getElementById(tabId).classList.add('active');
                });
            });
            
            // æœç´¢ç”¨æˆ·æŒ‰é’®
            document.getElementById('search-user-btn').addEventListener('click', searchUser);
            
            // æœç´¢æ¡†å›è½¦äº‹ä»¶
            document.getElementById('search-user-id').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    searchUser();
                }
            });
        }
    </script>
</body>
</html> 