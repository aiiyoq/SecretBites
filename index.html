<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>SecretBites</title>
    <style>
        html, body { height: 100%; margin: 0; padding: 0; }
        #map { width: 100vw; height: 100vh; }
        .search-bar {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            background: #fff;
            padding: 10px 20px;
            border-radius: 8px;
            box-shadow: 0 2px 6px 0 rgba(27, 142, 236, 0.2);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .search-bar input {
            font-size: 16px;
            padding: 6px 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            outline: none;
        }
        .search-bar button {
            font-size: 16px;
            padding: 6px 16px;
            background: #1b8eec;
            color: #fff;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .search-bar button:hover {
            background: #156bbd;
        }
        
        .info-panel {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 400px;
            height: 680px;
            min-width: 220px;
            min-height: 48px;
            max-width: 90vw;
            max-height: 90vh;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            margin-top: 60px; /* 为用户状态栏留出空间 */
        }
        
        .info-panel.collapsed {
            width: 48px !important;
            min-width: 48px !important;
            max-width: 48px !important;
            height: 48px !important;
            min-height: 48px !important;
            max-height: 48px !important;
            background: #1b8eec !important;
        }
        .info-panel.collapsed .info-panel-header {
            background: #1b8eec !important;
            padding: 0;
            justify-content: flex-end;
            width: 48px;
        }
        .info-panel.collapsed .info-panel-toggle-btn {
            width: 48px;
            height: 48px;
            justify-content: center;
            z-index: 1001;
        }
        .info-panel.collapsed .info-panel-header span {
            display: none;
        }
        .info-panel.collapsed .info-panel-content {
            display: none !important;
        }
        
        .info-panel-header {
            width: 100%;
            box-sizing: border-box;
            height: 48px;
            line-height: 48px;
            font-size: 16px;
            font-weight: bold;
            border-radius: 8px 8px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            padding: 0 16px;
            background: #1b8eec;
            color: #fff;
            /* transition: opacity 0.2s; */
            position: relative;
        }
        
        .info-panel-header:hover {
            background: #156bbd;
        }
        
        .info-panel-toggle-btn {
            position: absolute;
            top: 0;
            right: 0;
            background: none;
            border: none;
            color: #fff;
            font-size: 22px;
            cursor: pointer;
            padding: 0;
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.3s;
        }
        .info-panel.collapsed .info-panel-toggle-btn {
            transform: rotate(180deg);
        }
        
        .info-panel-handle {
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 40px;
            height: 60px;
            background: #1b8eec;
            border-radius: 8px 0 0 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-size: 16px;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .info-panel.collapsed .info-panel-handle {
            opacity: 1;
        }
        
        .info-panel-handle:hover {
            background: #156bbd;
        }
        
        .info-panel-content {
            padding: 16px;
            overflow-y: auto;
            flex: 1;
            opacity: 1;
            pointer-events: auto;
            display: flex;
            flex-direction: column;
            /* transition: opacity 0.3s; */
        }
        .info-panel.collapsed .info-panel-content {
            opacity: 0;
            pointer-events: none;
        }
        .info-panel-resizer {
            height: 8px;
            cursor: ns-resize;
            background: #f0f0f0;
            width: 100%;
            position: absolute;
            left: 0;
            bottom: 0;
            z-index: 10;
        }
        .info-panel-corner-resizer {
            width: 16px;
            height: 16px;
            position: absolute;
            right: 0;
            bottom: 0;
            cursor: nwse-resize;
            z-index: 11;
            background: transparent;
        }
        .info-panel-corner-resizer:after {
            display: none;
            content: '';
        }
        .info-panel-corner-resizer-left {
            width: 16px;
            height: 16px;
            position: absolute;
            left: 0;
            bottom: 0;
            cursor: nesw-resize;
            z-index: 11;
            background: transparent;
        }
        .info-panel-corner-resizer-left:after {
            display: none;
            content: '';
        }
        
        .info-panel-section {
            margin-bottom: 16px;
        }
        
        .info-panel-section.flex-grow {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .info-panel-section h3 {
            margin: 0 0 8px 0;
            font-size: 14px;
            color: #333;
            font-weight: bold;
        }
        
        .info-panel-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .info-panel-item:last-child {
            border-bottom: none;
        }
        
        .info-panel-label {
            color: #666;
            font-size: 13px;
        }
        
        .info-panel-value {
            color: #333;
            font-size: 13px;
            font-weight: 500;
            text-align: right;
            max-width: 60%;
        }
        
        .info-panel-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            margin-top: 4px;
        }
        
        .info-panel-tag {
            background: #f7c948;
            color: #333;
            border-radius: 12px;
            padding: 2px 8px;
            font-size: 11px;
        }
        
        .info-panel-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }
        
        .info-panel-stat {
            background: #f8f9fa;
            padding: 8px;
            border-radius: 4px;
            text-align: center;
        }
        
        .info-panel-stat-value {
            font-size: 18px;
            font-weight: bold;
            color: #1b8eec;
        }
        
        .info-panel-stat-label {
            font-size: 11px;
            color: #666;
            margin-top: 2px;
        }
        
        .info-panel-btn {
            background: #1b8eec;
            color: #fff;
            border: none;
            border-radius: 4px;
            padding: 6px 12px;
            font-size: 12px;
            cursor: pointer;
            display: inline-block;
            text-align: center;
            min-width: 60px;
            transition: background-color 0.2s ease;
        }
        
        .info-panel-btn:hover {
            background: #156bbd;
        }
        
        .info-panel-btn.rate-btn:hover {
            opacity: 0.8;
        }
        
        .filter-checkbox-container {
            display: inline-block;
            margin-right: 8px;
            margin-bottom: 4px;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            transition: background-color 0.2s ease;
        }
        
        .filter-checkbox-container:hover {
            background: #f0f0f0;
        }
        
        .filter-checkbox-container input[type="checkbox"] {
            margin-right: 4px;
            cursor: pointer;
        }
        
        .filter-checkbox-container span {
            font-size: 12px;
            cursor: pointer;
            user-select: none;
        }
        
        /* 筛选条样式 */
        .filter-bar {
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 16px;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        .filter-bar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: #e9ecef;
            cursor: pointer;
            user-select: none;
            transition: background-color 0.2s ease;
        }
        
        .filter-bar-header:hover {
            background: #dee2e6;
        }
        
        .filter-bar-title {
            font-size: 14px;
            font-weight: 500;
            color: #333;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .filter-bar-toggle {
            font-size: 16px;
            color: #666;
            transition: transform 0.3s ease;
        }
        
        .filter-bar.expanded .filter-bar-toggle {
            transform: rotate(180deg);
        }
        
        .filter-bar-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }
        
        .filter-bar.expanded .filter-bar-content {
            max-height: 500px;
        }
        
        .filter-section {
            padding: 16px;
            border-bottom: 1px solid #e9ecef;
        }
        
        .filter-section:last-child {
            border-bottom: none;
        }
        
        .filter-section-title {
            font-size: 13px;
            font-weight: 500;
            color: #333;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .filter-section-content {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .filter-actions {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }
        
        .filter-summary {
            font-size: 12px;
            color: #666;
            margin-left: auto;
        }
        
        .restaurant-list {
            max-height: none;
            overflow-y: auto;
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }
        
        .restaurant-item {
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            user-select: none;
            flex-shrink: 0;
        }
        
        .restaurant-item:hover {
            border-color: #1b8eec;
            background: #f8f9fa;
        }
        
        .restaurant-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }
        
        .restaurant-name {
            font-weight: bold;
            font-size: 13px;
            color: #333;
        }
        
        .restaurant-rate {
            font-size: 11px;
            font-weight: bold;
        }
        
        .restaurant-rate-container {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .friend-badge {
            font-size: 10px;
            color: #666;
            background: rgba(255,192,203,0.85);
            padding: 1px 4px;
            border-radius: 3px;
            border: none;
        }
        
        .info-panel-value-container {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .restaurant-location {
            font-size: 11px;
            color: #666;
            margin-bottom: 2px;
        }
        
        .restaurant-address {
            font-size: 11px;
            color: #999;
            line-height: 1.3;
        }
        .info-panel.collapsed .info-panel-resizer,
        .info-panel.collapsed .info-panel-corner-resizer,
        .info-panel.collapsed .info-panel-corner-resizer-left {
            display: none !important;
            background: transparent !important;
            height: 0 !important;
            border: none !important;
            box-shadow: none !important;
        }
        
        /* 用户状态栏样式 */
        .user-status-bar {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1001;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 6px 0 rgba(27, 142, 236, 0.2);
            padding: 8px 12px;
            min-width: 120px;
            transition: all 0.3s ease;
        }
        
        .user-status-bar:hover {
            box-shadow: 0 4px 12px 0 rgba(27, 142, 236, 0.3);
            transform: translateY(-1px);
        }
        
        /* 响应式设计 */
        @media (max-width: 768px) {
            .user-status-bar {
                top: 10px;
                right: 10px;
                padding: 6px 8px;
                min-width: 100px;
            }
            
            .info-panel {
                margin-top: 50px;
                right: 10px;
                width: calc(100vw - 20px);
                max-width: 400px;
            }
            
            .user-info {
                gap: 4px;
            }
            
            .login-btn, .register-btn {
                padding: 4px 8px;
                font-size: 12px;
            }
            
            .logout-btn {
                padding: 3px 6px;
                font-size: 11px;
            }
        }
        
        @media (max-width: 480px) {
            .user-status-bar {
                min-width: 80px;
                padding: 4px 6px;
            }
            
            .user-status-logged-out {
                gap: 4px;
            }
            
            .login-btn, .register-btn {
                padding: 3px 6px;
                font-size: 11px;
            }
            
            .user-nickname {
                font-size: 12px;
            }
            
            /* 在超小屏幕上调整字体大小 */
            .login-btn,
            .register-btn,
            .user-nickname,
            .logout-btn {
                font-size: 11px;
            }
        }
        
        .user-status-logged-out {
            display: flex;
            gap: 8px;
        }
        
        .login-btn, .register-btn {
            font-size: 14px;
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s ease;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .login-btn {
            background: #1b8eec;
            color: #fff;
        }
        
        .login-btn:hover {
            background: #156bbd;
        }
        
        .register-btn {
            background: #28a745;
            color: #fff;
        }
        
        .register-btn:hover {
            background: #218838;
        }
        
        .user-status-logged-in {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .user-nickname {
            font-size: 14px;
            color: #333;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .logout-btn {
            font-size: 12px;
            padding: 4px 8px;
            background: #dc3545;
            color: #fff;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 2px;
        }
        
        .logout-btn:hover {
            background: #c82333;
        }
        
        .friends-btn {
            font-size: 12px;
            padding: 4px 8px;
            background: #1b8eec;
            color: #fff;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 2px;
            margin-left: 8px;
        }
        
        .friends-btn:hover {
            background: #40a9ff;
        }
        
        .profile-btn {
            font-size: 12px;
            padding: 4px 8px;
            background: #28a745;
            color: #fff;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 2px;
            margin-left: 8px;
        }
        
        .profile-btn:hover {
            background: #34ce57;
        }
        
        /* 欢迎弹窗样式 */
        .welcome-content {
            text-align: center;
        }
        
        .welcome-intro {
            margin-bottom: 20px;
        }
        
        .welcome-actions {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 20px;
        }
        
        .welcome-btn {
            width: 100%;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .welcome-btn.primary {
            background: #ffc107;
            color: #000;
        }
        
        .welcome-btn.primary:hover {
            background: #e0a800;
        }
        
        .welcome-btn.secondary {
            background: #1b8eec;
            color: #fff;
        }
        
        .welcome-btn.secondary:hover {
            background: #156bbd;
        }
        
        .welcome-btn.tertiary {
            background: #28a745;
            color: #fff;
        }
        
        .welcome-btn.tertiary:hover {
            background: #218838;
        }
        
        .demo-account-info {
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 16px;
            margin: 20px 0;
            text-align: left;
        }
        
        .demo-account-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .demo-account-item:last-child {
            margin-bottom: 0;
        }
        
        .demo-label {
            font-size: 14px;
            color: #666;
            font-weight: 500;
        }
        
        .demo-value {
            font-size: 14px;
            color: #333;
            font-weight: 600;
            font-family: 'Courier New', monospace;
            background: #fff;
            padding: 4px 8px;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
        
        /* 认证模态框样式 */
        .auth-modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(2px);
        }
        
        .auth-modal-content {
            background-color: #fff;
            margin: 5% auto;
            padding: 0;
            border-radius: 12px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s ease-out;
        }
        
        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .auth-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px 16px;
            border-bottom: 1px solid #e9ecef;
        }
        
        .auth-modal-header h2 {
            margin: 0;
            font-size: 20px;
            color: #333;
            font-weight: 600;
        }
        
        .auth-modal-close {
            background: none;
            border: none;
            font-size: 24px;
            color: #999;
            cursor: pointer;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background-color 0.2s ease;
        }
        
        .auth-modal-close:hover {
            background-color: #f8f9fa;
            color: #666;
        }
        
        .auth-modal-body {
            padding: 24px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-size: 14px;
            color: #333;
            font-weight: 500;
        }
        
        .form-group input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.2s ease;
            box-sizing: border-box;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: #1b8eec;
        }
        
        .form-hint {
            display: block;
            margin-top: 4px;
            font-size: 12px;
            color: #666;
        }
        
        .form-actions {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 24px;
        }
        
        .auth-submit-btn {
            width: 100%;
            padding: 12px;
            background: #1b8eec;
            color: #fff;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        
        .auth-submit-btn:hover {
            background: #156bbd;
        }
        
        /* 好友管理样式 */
        .friends-tabs {
            display: flex;
            border-bottom: 1px solid #e9ecef;
            margin-bottom: 20px;
        }
        
        .friends-tab {
            background: none;
            border: none;
            padding: 12px 20px;
            cursor: pointer;
            font-size: 14px;
            color: #666;
            border-bottom: 2px solid transparent;
            transition: all 0.2s ease;
        }
        
        .friends-tab.active {
            color: #1b8eec;
            border-bottom-color: #1b8eec;
        }
        
        .friends-tab:hover {
            color: #1b8eec;
        }
        
        .friends-tab-content {
            display: none;
        }
        
        .friends-tab-content.active {
            display: block;
        }
        
        .friends-list, .friend-requests-list {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .friend-item {
            display: flex;
            align-items: center;
            padding: 12px;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            margin-bottom: 8px;
            background: #f8f9fa;
        }
        
        .friend-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #1b8eec;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 12px;
        }
        
        .friend-info {
            flex: 1;
        }
        
        .friend-name {
            font-weight: 500;
            color: #333;
            margin-bottom: 4px;
        }
        
        .friend-id {
            font-size: 12px;
            color: #666;
        }
        
        .friend-actions {
            display: flex;
            gap: 8px;
        }
        
        .friend-action-btn {
            padding: 4px 8px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .friend-action-btn.remove {
            background: #ff4d4f;
            color: white;
        }
        
        .friend-action-btn.remove:hover {
            background: #ff7875;
        }
        
        .friend-action-btn.accept {
            background: #52c41a;
            color: white;
        }
        
        .friend-action-btn.accept:hover {
            background: #73d13d;
        }
        
        .friend-action-btn.reject {
            background: #ff4d4f;
            color: white;
        }
        
        .friend-action-btn.reject:hover {
            background: #ff7875;
        }
        
        .friend-action-btn.send {
            background: #1b8eec;
            color: white;
        }
        
        .friend-action-btn.send:hover {
            background: #40a9ff;
        }
        
        .loading {
            text-align: center;
            color: #666;
            padding: 20px;
        }
        
        .empty-state {
            text-align: center;
            color: #666;
            padding: 20px;
        }
        
        .friends-header {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 16px;
        }
        
        .refresh-btn {
            background: #1b8eec;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .refresh-btn:hover {
            background: #40a9ff;
        }
        
        .friend-message {
            font-size: 12px;
            color: #999;
            margin-top: 4px;
        }
        
        /* 个人信息样式 */
        .profile-info {
            text-align: center;
        }
        
        .profile-avatar {
            margin-bottom: 24px;
        }
        
        .profile-avatar-circle {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: #1b8eec;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            font-weight: bold;
            margin: 0 auto;
        }
        
        .profile-details {
            text-align: left;
        }
        
        .profile-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .profile-item:last-child {
            border-bottom: none;
        }
        
        .profile-item label {
            font-weight: 500;
            color: #333;
            min-width: 80px;
        }
        
        .profile-item span {
            color: #666;
            flex: 1;
            text-align: right;
            margin-right: 8px;
        }
        
        .profile-id-container {
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 1;
            justify-content: flex-end;
        }
        
        .copy-btn {
            background: #1b8eec;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .copy-btn:hover {
            background: #40a9ff;
        }
        
        .copy-btn.copied {
            background: #52c41a;
        }
        
        .auth-submit-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .auth-switch-btn {
            background: none;
            border: none;
            color: #1b8eec;
            font-size: 14px;
            cursor: pointer;
            text-decoration: underline;
            padding: 8px;
        }
        
        .auth-switch-btn:hover {
            color: #156bbd;
        }
        
        /* 错误消息样式 */
        .error-message {
            color: #dc3545;
            font-size: 12px;
            margin-top: 4px;
            display: none;
        }
        
        .form-group.error input {
            border-color: #dc3545;
        }
        
        .form-group.error .error-message {
            display: block;
        }
        
        /* 成功消息样式 */
        .success-message {
            color: #28a745;
            font-size: 14px;
            text-align: center;
            margin-top: 12px;
            display: none;
        }
        
        /* 品牌名称和slogan样式 */
        .brand-container {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1000;
            text-align: left;
            pointer-events: none;
        }
        
        .brand-name {
            font-size: 32px;
            font-weight: 700;
            color: #1b8eec;
            margin: 0;
            line-height: 1.2;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            letter-spacing: -0.5px;
        }
        
        .brand-slogan {
            font-size: 14px;
            color: #666;
            margin: 4px 0 0 0;
            line-height: 1.4;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.05);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-weight: 400;
        }
    </style>
</head>
<body>
    <!-- 品牌名称和slogan -->
    <div class="brand-container">
        <h1 class="brand-name">SecretBites</h1>
        <p class="brand-slogan">把最爱的餐厅，分享给最亲密的朋友</p>
    </div>
    
    <div class="search-bar">
        <input type="text" id="keyword" placeholder="请输入POI关键字，如餐厅、景点..." />
        <button id="search-btn">搜索</button>
    </div>
    
    <!-- 用户状态区域 -->
    <div class="user-status-bar" id="user-status-bar">
        <div class="user-status-logged-out" id="user-status-logged-out">
            <button class="login-btn" id="login-btn">🔑 登录</button>
            <button class="register-btn" id="register-btn">📝 注册</button>
        </div>
        <div class="user-status-logged-in" id="user-status-logged-in" style="display: none;">
            <div class="user-info">
                <span class="user-nickname" id="user-nickname">👤 用户昵称</span>
                <button class="profile-btn" id="profile-btn" onclick="showProfileModal()">👤 个人信息</button>
                <button class="friends-btn" id="friends-btn" onclick="showFriendsModal()">👥 好友</button>
                <button class="logout-btn" id="logout-btn">🚪 退出</button>
            </div>
        </div>
    </div>
    
    <!-- 登录模态框 -->
    <div class="auth-modal" id="login-modal">
        <div class="auth-modal-content">
            <div class="auth-modal-header">
                <h2>用户登录</h2>
                <button class="auth-modal-close" id="login-modal-close">&times;</button>
            </div>
            <div class="auth-modal-body">
                <form id="login-form">
                    <div class="form-group">
                        <label for="login-unique-id">用户名</label>
                        <input type="text" id="login-unique-id" name="unique_id" placeholder="请输入用户名" required>
                    </div>
                    <div class="form-group">
                        <label for="login-password">密码</label>
                        <input type="password" id="login-password" name="password" placeholder="请输入密码" required>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="auth-submit-btn">登录</button>
                        <button type="button" class="auth-switch-btn" id="switch-to-register">没有账号？去注册</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- 注册模态框 -->
    <div class="auth-modal" id="register-modal">
        <div class="auth-modal-content">
            <div class="auth-modal-header">
                <h2>用户注册</h2>
                <button class="auth-modal-close" id="register-modal-close">&times;</button>
            </div>
            <div class="auth-modal-body">
                <form id="register-form">
                    <div class="form-group">
                        <label for="register-nickname">昵称</label>
                        <input type="text" id="register-nickname" name="nickname" placeholder="请输入昵称" required>
                    </div>
                    <div class="form-group">
                        <label for="register-unique-id">用户名</label>
                        <input type="text" id="register-unique-id" name="unique_id" placeholder="请输入用户名（3-20位字母数字下划线）" required>
                        <small class="form-hint">用户名只能包含字母、数字和下划线，长度3-20位</small>
                    </div>
                    <div class="form-group">
                        <label for="register-password">密码</label>
                        <input type="password" id="register-password" name="password" placeholder="请输入密码" required>
                    </div>
                    <div class="form-group">
                        <label for="register-confirm-password">确认密码</label>
                        <input type="password" id="register-confirm-password" name="confirm_password" placeholder="请再次输入密码" required>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="auth-submit-btn">注册</button>
                        <button type="button" class="auth-switch-btn" id="switch-to-login">已有账号？去登录</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- 欢迎弹窗 -->
    <div class="auth-modal" id="welcome-modal">
        <div class="auth-modal-content" style="max-width: 400px;">
            <div class="auth-modal-header">
                <h2>欢迎使用 SecretBites</h2>
                <button class="auth-modal-close" id="welcome-modal-close">&times;</button>
            </div>
            <div class="auth-modal-body">
                <div class="welcome-content">
                    <div class="welcome-intro">
                        <p style="font-size: 16px; line-height: 1.6; margin: -10px 0 20px; color: #333;">
                            可以使用演示账号，查看我的心选餐厅；<br>
                            也可以查看项目介绍，了解产品诞生的0到1
                        </p>
                    </div>
                    
                    <div class="demo-account-info">
                        <div class="demo-account-item">
                            <span class="demo-label">账号：</span>
                            <span class="demo-value">wangyuqing</span>
                        </div>
                        <div class="demo-account-item">
                            <span class="demo-label">密码：</span>
                            <span class="demo-value">111111</span>
                        </div>
                    </div>
                    
                    <div class="welcome-actions">
                        <button class="welcome-btn" onclick="downloadProjectIntro()">
                            项目介绍（PDF）
                        </button>
                        <button class="welcome-btn primary" onclick="useDemoAccount()">
                            使用演示账号
                        </button>
                        <button class="welcome-btn secondary" onclick="showModal('login-modal'); hideModal('welcome-modal');">
                            登录
                        </button>
                        <button class="welcome-btn tertiary" onclick="showModal('register-modal'); hideModal('welcome-modal');">
                            注册
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 好友管理模态框 -->
    <div class="auth-modal" id="friends-modal">
        <div class="auth-modal-content" style="max-width: 600px;">
            <div class="auth-modal-header">
                <h2>好友管理</h2>
                <button class="auth-modal-close" id="friends-modal-close">&times;</button>
            </div>
            <div class="auth-modal-body">
                <!-- 标签页导航 -->
                <div class="friends-tabs">
                    <button class="friends-tab active" data-tab="friends-list">好友列表</button>
                    <button class="friends-tab" data-tab="add-friend">添加好友</button>
                    <button class="friends-tab" data-tab="friend-requests">好友请求</button>
                </div>
                
                <!-- 好友列表标签页 -->
                <div class="friends-tab-content active" id="friends-list-tab">
                    <div class="friends-header">
                        <button class="refresh-btn" onclick="refreshFriendsList()">🔄 刷新</button>
                    </div>
                    <div class="friends-list" id="friends-list">
                        <div class="loading">加载中...</div>
                    </div>
                </div>
                
                <!-- 添加好友标签页 -->
                <div class="friends-tab-content" id="add-friend-tab">
                    <div class="add-friend-form">
                        <div class="form-group">
                            <label for="search-user-id">搜索用户</label>
                            <input type="text" id="search-user-id" placeholder="请输入用户唯一ID" required>
                        </div>
                        <button type="button" id="search-user-btn" class="auth-submit-btn">搜索用户</button>
                        <div id="search-result" style="margin-top: 16px;"></div>
                    </div>
                </div>
                
                <!-- 好友请求标签页 -->
                <div class="friends-tab-content" id="friend-requests-tab">
                    <div class="friends-header">
                        <button class="refresh-btn" onclick="refreshFriendRequests()">🔄 刷新</button>
                    </div>
                    <div class="friend-requests-list" id="friend-requests-list">
                        <div class="loading">加载中...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 个人信息模态框 -->
    <div class="auth-modal" id="profile-modal">
        <div class="auth-modal-content" style="max-width: 500px;">
            <div class="auth-modal-header">
                <h2>个人信息</h2>
                <button class="auth-modal-close" id="profile-modal-close">&times;</button>
            </div>
            <div class="auth-modal-body">
                <div class="profile-info" id="profile-info">
                    <div class="profile-avatar">
                        <div class="profile-avatar-circle" id="profile-avatar-circle">
                            <!-- 头像将在这里显示 -->
                        </div>
                    </div>
                    <div class="profile-details">
                        <div class="profile-item">
                            <label>昵称</label>
                            <span id="profile-nickname">加载中...</span>
                        </div>
                        <div class="profile-item">
                            <label>唯一ID</label>
                            <div class="profile-id-container">
                                <span id="profile-unique-id">加载中...</span>
                                <button class="copy-btn" onclick="copyUniqueId()">复制</button>
                            </div>
                        </div>
                        <div class="profile-item">
                            <label>注册时间</label>
                            <span id="profile-created-at">加载中...</span>
                        </div>
                        <div class="profile-item">
                            <label>评分统计</label>
                            <span id="profile-rating-count">加载中...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="map"></div>
    
    <!-- 信息面板 -->
    <div class="info-panel" id="info-panel">
        <div class="info-panel-header" id="info-panel-header">
            <span>信息面板</span>
            <button class="info-panel-toggle-btn" id="info-panel-toggle-btn" tabindex="-1">▲</button>
        </div>
        <div class="info-panel-content" id="info-panel-content">
            <!-- 内容将通过JavaScript动态生成 -->
        </div>
        <div class="info-panel-resizer" id="info-panel-resizer"></div>
        <div class="info-panel-corner-resizer" id="info-panel-corner-resizer"></div>
        <div class="info-panel-corner-resizer-left" id="info-panel-corner-resizer-left"></div>
    </div>
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Supabase 配置 -->
    <script src="supabase_config.js"></script>
    <!-- 好友API -->
    <script src="friendship_api.js"></script>
    <!-- 百度地图API -->
    <script src="https://api.map.baidu.com/api?v=1.0&type=webgl&ak=37RkgO1xJD842QrZ0AnUGHpCOYSGg3kh"></script>
    <script>
        // ===================== Supabase 配置 =====================
        // 从配置文件获取 Supabase 配置
        const SUPABASE_URL = window.SUPABASE_CONFIG.URL;
        const SUPABASE_ANON_KEY = window.SUPABASE_CONFIG.ANON_KEY;
        
        // 初始化 Supabase 客户端
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // ===================== 常量配置 =====================
        const RATE_TYPES = [
            { value: "超爱", drop: "#FF4500", star: "white" },
            { value: "喜欢", drop: "#FFA500", star: "white" },
            { value: "一般", drop: "#808080", star: "white" },
            { value: "不会再去了", drop: "#556B2F", star: "black" }
        ];
        const GLOBAL_DEFAULT_ZOOM = 15; // 自动缩放默认级别

        // ===================== 数据管理 =====================
        let map;
        let localSearch;
        window.ratedPois = [];
        window.ratedMarkers = {};
        window._poiMarkers = [];
        
        // ===================== 用户认证管理 =====================
        let currentUser = null;
        let isLoggedIn = false;
        
        // 用户认证相关函数
        function loadUserSession() {
            const userSession = localStorage.getItem('userSession');
            if (userSession) {
                try {
                    const session = JSON.parse(userSession);
                    // 检查会话是否过期（24小时）
                    if (session.timestamp && (Date.now() - session.timestamp) < 24 * 60 * 60 * 1000) {
                        currentUser = session.user;
                        isLoggedIn = true;
                        updateUserStatusUI();
                        return true;
                    } else {
                        // 会话过期，清除
                        localStorage.removeItem('userSession');
                    }
                } catch (e) {
                    localStorage.removeItem('userSession');
                }
            }
            return false;
        }
        
        function saveUserSession(user) {
            const session = {
                user: user,
                timestamp: Date.now()
            };
            localStorage.setItem('userSession', JSON.stringify(session));
        }
        
        function clearUserSession() {
            localStorage.removeItem('userSession');
            currentUser = null;
            isLoggedIn = false;
            updateUserStatusUI();
        }
        
        function updateUserStatusUI() {
            const loggedOutDiv = document.getElementById('user-status-logged-out');
            const loggedInDiv = document.getElementById('user-status-logged-in');
            const nicknameSpan = document.getElementById('user-nickname');
            
            if (isLoggedIn && currentUser) {
                loggedOutDiv.style.display = 'none';
                loggedInDiv.style.display = 'flex';
                nicknameSpan.textContent = currentUser.nickname;
            } else {
                loggedOutDiv.style.display = 'flex';
                loggedInDiv.style.display = 'none';
            }
            
            // 更新信息面板以反映登录状态变化
            if (currentView === 'list') {
                updateInfoPanel(null, 'list');
            } else if (currentView === 'stats') {
                updateInfoPanel(null, 'stats');
            } else if (currentView === 'search' && currentSearchResults.length > 0) {
                updateInfoPanel(null, 'search', currentSearchResults);
            } else if (currentView === 'detail' && currentPoi) {
                updateInfoPanel(currentPoi, 'detail');
            }
        }
        
        // Supabase 用户认证API
        async function loginUser(uniqueId, password) {
            try {
                // 从数据库查询用户
                const { data: user, error } = await supabase
                    .from('users')
                    .select('*')
                    .eq('unique_id', uniqueId)
                    .single();
                
                if (error || !user) {
                    throw new Error('用户名或密码错误');
                }
                
                // 验证密码（这里使用简单的比较，实际应该使用bcrypt）
                if (user.password_hash !== password) {
                    throw new Error('用户名或密码错误');
                }
                
                // 更新最后活跃时间
                await supabase
                    .from('users')
                    .update({ last_active: new Date().toISOString() })
                    .eq('id', user.id);
                
                return {
                    id: user.id,
                    unique_id: user.unique_id,
                    nickname: user.nickname,
                    avatar_url: user.avatar_url
                };
            } catch (error) {
                console.error('登录错误:', error);
                throw new Error('用户名或密码错误');
            }
        }
        
        async function registerUser(nickname, uniqueId, password) {
            try {
                // 检查用户名是否已存在
                const { data: existingUser, error: checkError } = await supabase
                    .from('users')
                    .select('id')
                    .eq('unique_id', uniqueId)
                    .single();
                
                if (existingUser) {
                    throw new Error('用户名已存在');
                }
                
                // 创建新用户（这里使用简单的密码存储，实际应该使用bcrypt哈希）
                const { data: newUser, error } = await supabase
                    .from('users')
                    .insert([
                        {
                            nickname: nickname,
                            unique_id: uniqueId,
                            password_hash: password // 实际应该使用 bcrypt.hash(password, 10)
                        }
                    ])
                    .select()
                    .single();
                
                if (error) {
                    console.error('注册错误:', error);
                    throw new Error('注册失败，请重试');
                }
                
                return {
                    id: newUser.id,
                    unique_id: newUser.unique_id,
                    nickname: newUser.nickname,
                    avatar_url: newUser.avatar_url
                };
            } catch (error) {
                console.error('注册错误:', error);
                throw error;
            }
        }
        
        // 表单验证函数
        function validateUniqueId(uniqueId) {
            const pattern = /^[a-zA-Z0-9_]{3,20}$/;
            return pattern.test(uniqueId);
        }
        
        function validatePassword(password) {
            return password && password.length >= 6;
        }
        
        function validateNickname(nickname) {
            return nickname && nickname.trim().length >= 2;
        }
        
        // 显示错误消息
        function showFormError(formGroup, message) {
            formGroup.classList.add('error');
            let errorDiv = formGroup.querySelector('.error-message');
            if (!errorDiv) {
                errorDiv = document.createElement('div');
                errorDiv.className = 'error-message';
                formGroup.appendChild(errorDiv);
            }
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }
        
        // 清除错误消息
        function clearFormError(formGroup) {
            formGroup.classList.remove('error');
            const errorDiv = formGroup.querySelector('.error-message');
            if (errorDiv) {
                errorDiv.style.display = 'none';
            }
        }
        
        // 显示成功消息
        function showSuccessMessage(modal, message) {
            let successDiv = modal.querySelector('.success-message');
            if (!successDiv) {
                successDiv = document.createElement('div');
                successDiv.className = 'success-message';
                modal.querySelector('.auth-modal-body').appendChild(successDiv);
            }
            successDiv.textContent = message;
            successDiv.style.display = 'block';
        }
        
        // 模态框管理
        function showModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.style.display = 'block';
            // 清除之前的错误和成功消息
            modal.querySelectorAll('.error-message, .success-message').forEach(el => {
                el.style.display = 'none';
            });
            modal.querySelectorAll('.form-group').forEach(el => {
                el.classList.remove('error');
            });
        }
        
        function hideModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.style.display = 'none';
        }
        
        function switchModal(fromModalId, toModalId) {
            hideModal(fromModalId);
            showModal(toModalId);
        }
        
        // 下载项目介绍 PDF（放在项目根目录）
        window.downloadProjectIntro = function() {
            const pdfPath = encodeURI('王雨晴_SecretBites_把最爱的餐厅，分享给最亲密的朋友_产品介绍.pdf');
            try {
                const a = document.createElement('a');
                a.href = pdfPath;
                a.download = 'SecretBites_产品介绍.pdf';
                document.body.appendChild(a);
                a.click();
                a.remove();
            } catch (e) {
                // 回退方案：新开标签页
                window.open(pdfPath, '_blank');
            }
        }

        // 显示欢迎弹窗
        window.showWelcomeModal = function() {
            showModal('welcome-modal');
        }
        
        // 使用演示账号自动登录
        window.useDemoAccount = async function() {
            try {
                // 显示加载状态
                const demoBtn = event.target;
                const originalText = demoBtn.textContent;
                demoBtn.textContent = '登录中...';
                demoBtn.disabled = true;
                
                // 使用演示账号信息
                const demoCredentials = {
                    unique_id: 'wangyuqing',
                    password: '111111'
                };
                
                // 调用现有的登录函数
                const user = await loginUser(demoCredentials.unique_id, demoCredentials.password);
                
                // 设置用户会话
                currentUser = user;
                isLoggedIn = true;
                saveUserSession(user);
                
                // 关闭欢迎弹窗
                hideModal('welcome-modal');
                
                // 更新UI状态
                updateUserStatusUI();
                
                // 更新用户筛选状态
                userFilterState = { self: true };
                userFilterMapping = { self: currentUser.id };
                
                // 初始化好友API
                initFriendshipAPI();
                
                // 加载评分数据
                await loadRatedPois();
                await updateUserFilters(); // 更新用户筛选器
                updateFilterState();
                updateMapMarkers();
                updateMapViewportForRatedPois();
                updateInfoPanel(null, 'list'); // 更新信息面板显示餐厅列表
                
                // 显示成功消息
                setTimeout(() => {
                    alert('演示账号登录成功！欢迎查看我的心选餐厅 🍽️');
                }, 500);
                
            } catch (error) {
                console.error('演示账号登录失败:', error);
                
                // 恢复按钮状态
                demoBtn.textContent = originalText;
                demoBtn.disabled = false;
                
                // 显示错误消息
                alert('演示账号登录失败：' + error.message);
            }
        }

        async function loadRatedPois() {
            if (!isLoggedIn || !currentUser) {
                window.ratedPois = [];
                return;
            }
            
            try {
                // 加载自己的评分
                const { data: reviews, error } = await supabase
                    .from('restaurant_reviews')
                    .select('*')
                    .eq('user_id', currentUser.id);
                
                if (error) {
                    console.error('加载评分数据错误:', error);
                    window.ratedPois = [];
                    return;
                }
                
                // 将数据库格式转换为应用格式
                let myReviews = reviews.map(review => ({
                    uid: review.restaurant_uid,
                    title: review.restaurant_name,
                    shortTitle: getShortTitle(review.restaurant_name),
                    address: review.restaurant_address,
                    point: review.longitude && review.latitude ? {
                        lng: review.longitude,
                        lat: review.latitude
                    } : undefined,
                    city: review.restaurant_city,
                    area: review.restaurant_area,
                    tags: review.tags || [],
                    phoneNumber: null, // 数据库中没有存储
                    rate: review.rating,
                    // 添加数据库字段
                    review_id: review.id,
                    user_id: review.user_id, // 添加用户ID
                    review_text: review.review_text,
                    is_public: review.is_public,
                    created_at: review.created_at,
                    updated_at: review.updated_at
                }));
                
                // 加载好友的评分
                const friendsReviews = await loadFriendsReviews();
                
                // 合并所有评分，确保好友评分有正确的标记
                window.ratedPois = [
                    ...myReviews.map(review => ({...review, is_friend_review: false})),
                    ...friendsReviews.map(review => ({...review, is_friend_review: true}))
                ];
                
                // 更新用户筛选器（但不重置现有的选择状态）
                const currentUserFilters = {...userFilterState};
                await updateUserFilters();
                // 恢复之前的选择状态
                Object.keys(currentUserFilters).forEach(key => {
                    if (userFilterState.hasOwnProperty(key)) {
                        userFilterState[key] = currentUserFilters[key];
                    }
                });
                
                // 更新筛选状态
                updateFilterState();
                
            } catch (error) {
                console.error('加载评分数据错误:', error);
                window.ratedPois = [];
            }
        }
        
        // 加载好友的评分数据
        async function loadFriendsReviews() {
            if (!friendshipAPI) {
                initFriendshipAPI();
            }
            
            try {
                const friendsReviews = await friendshipAPI.getAllFriendsReviews(currentUser.id);
                
                // 获取好友列表以获取昵称
                const friends = await friendshipAPI.getFriendsList(currentUser.id);
                
                // 转换为应用格式
                return friendsReviews.map(review => {
                    // 从好友列表中查找对应的昵称
                    const friend = friends.find(f => {
                        const friendId = f.friend_id === currentUser.id ? f.user_id : f.friend_id;
                        return friendId === review.user_id;
                    });
                    
                    const friendNickname = friend ? 
                        (friend.friend_id === currentUser.id ? friend.user_nickname : friend.friend_nickname) : 
                        `用户${review.user_id.slice(0, 8)}`;
                    
                    return {
                        uid: review.restaurant_uid,
                        title: review.restaurant_name,
                        shortTitle: getShortTitle(review.restaurant_name),
                        address: review.restaurant_address,
                        point: review.longitude && review.latitude ? {
                            lng: review.longitude,
                            lat: review.latitude
                        } : undefined,
                        city: review.restaurant_city,
                        area: review.restaurant_area,
                        tags: review.tags || [],
                        phoneNumber: null,
                        rate: review.rating,
                        // 添加数据库字段
                        review_id: review.id,
                        user_id: review.user_id,
                        review_text: review.review_text,
                        is_public: review.is_public,
                        created_at: review.created_at,
                        updated_at: review.updated_at,
                        // 添加好友信息
                        friend_nickname: friendNickname,
                        is_friend_review: true
                    };
                });
            } catch (error) {
                console.error('加载好友评分失败:', error);
                return [];
            }
        }
        
        // 更新用户筛选器
        async function updateUserFilters() {
            if (!friendshipAPI) {
                initFriendshipAPI();
            }
            
            try {
                // 重置用户筛选状态 - 默认只显示自己的
                userFilterState = { self: true };
                userFilterMapping = { self: currentUser.id };
                
                // 获取好友列表
                const friends = await friendshipAPI.getFriendsList(currentUser.id);
                
                // 保存好友列表到全局变量，供筛选器显示使用
                window.friendsList = friends;
                
                // 为每个好友添加到筛选器
                friends.forEach(friend => {
                    const friendId = friend.friend_id === currentUser.id ? friend.user_id : friend.friend_id;
                    const friendNickname = friend.friend_id === currentUser.id ? friend.user_nickname : friend.friend_nickname;
                    
                    userFilterState[`friend_${friendId}`] = false; // 默认不选中好友
                    userFilterMapping[`friend_${friendId}`] = friendId;
                });
                
                console.log('用户筛选器已更新:', userFilterState);
                console.log('用户筛选器映射已更新:', userFilterMapping);
                console.log('好友列表已保存:', window.friendsList);
                
            } catch (error) {
                console.error('更新用户筛选器失败:', error);
            }
        }
        
        // 刷新用户筛选器
        window.refreshUserFilters = async function() {
            console.log('刷新用户筛选器');
            await updateUserFilters();
            clearFilterCache();
            updateInfoPanel(null, 'list'); // 刷新列表视图
        };
        
        async function saveRatedPoi(poi, rate) {
            if (!isLoggedIn || !currentUser) {
                throw new Error('用户未登录');
            }
            
            try {
                const reviewData = {
                    user_id: currentUser.id,
                    restaurant_uid: poi.uid,
                    restaurant_name: getPoiField(poi, ['title', 'name']),
                    restaurant_address: getPoiField(poi, ['address', 'addr']),
                    restaurant_city: getPoiField(poi, ['city', 'cityname']),
                    restaurant_area: getPoiField(poi, ['area', 'areaname', 'district']),
                    rating: rate,
                    latitude: poi.point ? parseFloat(poi.point.lat) : null,
                    longitude: poi.point ? parseFloat(poi.point.lng) : null,
                    tags: Array.isArray(getPoiField(poi, ['tags', 'std_tag', 'tag'])) 
                        ? getPoiField(poi, ['tags', 'std_tag', 'tag']) 
                        : []
                };
                
                console.log('保存评分数据:', reviewData);
                
                const { data, error } = await supabase
                    .from('restaurant_reviews')
                    .upsert(reviewData, { 
                        onConflict: 'user_id,restaurant_uid'
                    })
                    .select()
                    .single();
                
                if (error) {
                    console.error('保存评分错误:', error);
                    throw new Error(`保存评分失败: ${error.message}`);
                }
                
                return data;
            } catch (error) {
                console.error('保存评分错误:', error);
                throw error;
            }
        }
        async function addOrUpdateRatedPoi(poi, rate) {
            // 检查用户是否已登录
            if (!isLoggedIn) {
                showModal('login-modal');
                return;
            }
            
            // 立即更新本地数据和UI，提供即时反馈
            // 只查找自己的评分，不影响好友的评分
            const idx = window.ratedPois.findIndex(f => f.uid === poi.uid && f.user_id === currentUser.id);
            const title = getPoiField(poi, ['title', 'name']);
            const shortTitle = getShortTitle(title);
            const address = getPoiField(poi, ['address', 'addr']);
            const city = getPoiField(poi, ['city', 'cityname']);
            const area = getPoiField(poi, ['area', 'areaname', 'district']);
            const tags = getPoiField(poi, ['tags', 'std_tag', 'tag']) || [];
            
            if (idx === -1) {
                // 新增评分 - 先添加到本地数据
                const newPoi = {
                    uid: poi.uid,
                    title: title,
                    shortTitle: shortTitle,
                    address: address,
                    point: poi.point ? {lng: poi.point.lng, lat: poi.point.lat} : undefined,
                    city: city,
                    area: area,
                    tags: tags,
                    rate: rate,
                    user_id: currentUser.id,
                    is_friend_review: false,  // 确保这是自己的评分
                    review_id: null, // 临时设为null，保存后更新
                    created_at: new Date().toISOString(),
                    updated_at: new Date().toISOString()
                };
                window.ratedPois.push(newPoi);
                
                // 立即更新UI
                updateFilterState();
                updateMapMarkers();
                if (currentView === 'list') {
                    updateInfoPanel(null, 'list');
                }
                if (currentView === 'detail' && currentPoi && currentPoi.uid === poi.uid) {
                    // 使用更新后的评分数据更新面板
                    const updatedPoi = window.ratedPois.find(p => p.uid === poi.uid && p.user_id === currentUser.id) || poi;
                    updateInfoPanel(updatedPoi, 'detail');
                }
            } else {
                // 更新评分 - 立即更新本地数据
                const oldRate = window.ratedPois[idx].rate;
                window.ratedPois[idx].rate = rate;
                window.ratedPois[idx].shortTitle = shortTitle;
                window.ratedPois[idx].title = title;
                window.ratedPois[idx].address = address;
                window.ratedPois[idx].city = city;
                window.ratedPois[idx].area = area;
                window.ratedPois[idx].tags = tags;
                window.ratedPois[idx].updated_at = new Date().toISOString();
                
                // 立即更新UI
                updateFilterState();
                updateMapMarkers();
                if (currentView === 'list') {
                    updateInfoPanel(null, 'list');
                }
                if (currentView === 'detail' && currentPoi && currentPoi.uid === poi.uid) {
                    // 使用更新后的评分数据更新面板
                    const updatedPoi = window.ratedPois.find(p => p.uid === poi.uid && p.user_id === currentUser.id) || poi;
                    updateInfoPanel(updatedPoi, 'detail');
                }
            }
            
            // 异步保存到数据库
            try {
                const savedReview = await saveRatedPoi(poi, rate);
                
                // 更新数据库返回的字段
                if (idx === -1) {
                    // 找到刚添加的评分
                    const newIdx = window.ratedPois.findIndex(f => f.uid === poi.uid && f.review_id === null);
                    if (newIdx !== -1) {
                        window.ratedPois[newIdx].review_id = savedReview.id;
                        window.ratedPois[newIdx].created_at = savedReview.created_at;
                        window.ratedPois[newIdx].updated_at = savedReview.updated_at;
                    }
                } else {
                    window.ratedPois[idx].updated_at = savedReview.updated_at;
                }
            } catch (error) {
                console.error('保存评分失败:', error);
                // 如果保存失败，回滚本地数据
                if (idx === -1) {
                    window.ratedPois = window.ratedPois.filter(f => f.uid !== poi.uid);
                } else {
                    window.ratedPois[idx].rate = oldRate;
                }
                updateFilterState();
                updateMapMarkers(); // 重新渲染以回滚UI
                alert('保存评分失败，请重试');
            }
        }
        
        async function removeRatedPoi(uid) {
            // 检查用户是否已登录
            if (!isLoggedIn) {
                showModal('login-modal');
                return;
            }
            
            // 立即从本地数据移除并更新UI（只移除自己的评分）
            const removedPoi = window.ratedPois.find(f => f.uid === uid && f.user_id === currentUser.id);
            window.ratedPois = window.ratedPois.filter(f => !(f.uid === uid && f.user_id === currentUser.id));
            
            // 立即更新UI
            updateFilterState();
            updateMapMarkers();
            if (currentView === 'list') {
                updateInfoPanel(null, 'list');
            }
            if (currentView === 'detail' && currentPoi && currentPoi.uid === uid) {
                updateInfoPanel(currentPoi, 'detail');
            }
            
            // 异步从数据库删除
            try {
                const { error } = await supabase
                    .from('restaurant_reviews')
                    .delete()
                    .eq('user_id', currentUser.id)
                    .eq('restaurant_uid', uid);
                
                if (error) {
                    console.error('删除评分错误:', error);
                    throw new Error('删除评分失败');
                }
            } catch (error) {
                console.error('删除评分失败:', error);
                // 如果删除失败，恢复本地数据
                if (removedPoi) {
                    window.ratedPois.push(removedPoi);
                    updateFilterState();
                    updateMapMarkers();
                }
                if (currentView === 'list') {
                    updateInfoPanel(null, 'list');
                }
                if (currentView === 'detail' && currentPoi && currentPoi.uid === uid) {
                    updateInfoPanel(currentPoi, 'detail');
                }
                alert('删除评分失败，请重试');
            }
        }

        // ===================== 地图标记管理 =====================
        
        // 全局标记存储
        window.mapMarkers = {
            rated: {},      // 评分标记
            nicknames: {},  // 昵称标签
            search: []      // 搜索标记
        };
        
        // 筛选状态
        window.filterState = {
            rates: [],    // 选中的评分类型
            users: []     // 选中的用户ID
        };
        
        // 创建评分标记的SVG图标
        function createRatedSvg(rate) {
            const type = RATE_TYPES.find(t => t.value === rate) || RATE_TYPES[1];
            return `<svg width="32" height="40" viewBox="0 0 32 40" xmlns="http://www.w3.org/2000/svg">
                <path d="M16 40C16 40 32 24.5685 32 16C32 7.16344 24.8366 0 16 0C7.16344 0 0 7.16344 0 16C0 24.5685 16 40 16 40Z" fill="${type.drop}"/>
                <path d="M16 8L18.47 13.53L24 14.18L20 18.24L21.24 24L16 21.24L10.76 24L12 18.24L8 14.18L13.53 13.53L16 8Z" fill="${type.star}"/>
            </svg>`;
        }
        
        // 清除所有地图标记
        function clearAllMapMarkers() {
            // 清除评分标记
            Object.values(window.mapMarkers.rated).forEach(marker => {
                map.removeOverlay(marker);
            });
            window.mapMarkers.rated = {};
            
            // 清除昵称标签
            Object.values(window.mapMarkers.nicknames).forEach(label => {
                map.removeOverlay(label);
            });
            window.mapMarkers.nicknames = {};
            
            // 清除搜索标记
            window.mapMarkers.search.forEach(marker => {
                map.removeOverlay(marker);
            });
            window.mapMarkers.search = [];
        }
        
        // 获取应该显示的评分点
        function getVisibleRatedPois() {
            const { rates, users } = window.filterState;
            
            console.log('Filtering POIs with state:', { rates, users, totalPois: window.ratedPois.length });
            
            let filteredPois = window.ratedPois.filter(poi => {
                // 评分类型筛选 - 如果没有选中任何评分类型，则不显示任何数据
                const rateMatch = rates.length > 0 && rates.includes(poi.rate);
                // 用户筛选 - 如果没有选中任何用户，则不显示任何数据
                const userMatch = users.length > 0 && users.includes(poi.user_id);
                
                const shouldShow = rateMatch && userMatch;
                console.log(`POI ${poi.title}: rateMatch=${rateMatch}, userMatch=${userMatch}, shouldShow=${shouldShow}`);
                
                return shouldShow;
            });
            
            console.log('Filtered POIs count:', filteredPois.length);
            
            // 按照RATE_TYPES的顺序进行排序，确保与筛选器顺序一致
            return filteredPois.sort((a, b) => {
                const indexA = RATE_TYPES.findIndex(t => t.value === a.rate);
                const indexB = RATE_TYPES.findIndex(t => t.value === b.rate);
                return indexA - indexB;
            });
        }
        
        // 更新地图标记
        function updateMapMarkers() {
            console.log('Updating map markers with filter state:', window.filterState);
            
            // 彻底清除所有评分相关的标记和标签
            if (window.mapMarkers.rated) {
                console.log('Clearing rated markers:', Object.keys(window.mapMarkers.rated).length, 'keys:', Object.keys(window.mapMarkers.rated));
                Object.values(window.mapMarkers.rated).forEach(marker => {
                    if (marker && map) {
                        map.removeOverlay(marker);
                    }
                });
                window.mapMarkers.rated = {};
            }
            
            if (window.mapMarkers.nicknames) {
                console.log('Clearing nickname labels:', Object.keys(window.mapMarkers.nicknames).length, 'keys:', Object.keys(window.mapMarkers.nicknames));
                Object.values(window.mapMarkers.nicknames).forEach(label => {
                    if (label && map) {
                        map.removeOverlay(label);
                    }
                });
                window.mapMarkers.nicknames = {};
            }
            
            // 获取要显示的数据
            const visiblePois = getVisibleRatedPois();
            console.log('Visible POIs:', visiblePois.length);
            
            // 创建新标记
            visiblePois.forEach(poi => {
                createRatedMarker(poi);
            });
            
            console.log('Final marker counts - rated:', Object.keys(window.mapMarkers.rated).length, 'nicknames:', Object.keys(window.mapMarkers.nicknames).length);
        }
        
        // 创建单个评分标记
        function createRatedMarker(poi) {
            if (!poi.point || typeof poi.point.lng !== 'number' || typeof poi.point.lat !== 'number') {
                return;
            }
            
            const pt = new BMapGL.Point(poi.point.lng, poi.point.lat);
            
            // 创建标记图标
            const svg = createRatedSvg(poi.rate);
            const svgUrl = 'data:image/svg+xml;base64,' + btoa(svg);
            const icon = new BMapGL.Icon(svgUrl, new BMapGL.Size(32, 40), { 
                anchor: new BMapGL.Size(16, 40) 
            });
            
            // 创建标记
            const marker = new BMapGL.Marker(pt, { icon: icon });
            
            // 创建餐厅名称标签
            const label = new BMapGL.Label(poi.shortTitle || poi.title, { 
                offset: new BMapGL.Size(20, -10) 
            });
            label.setStyle({
                color: '#333',
                fontSize: '14px',
                background: 'rgba(255,255,255,0.85)',
                border: 'none',
                padding: '2px 8px',
                borderRadius: '4px',
                fontWeight: 'bold',
                zIndex: 999
            });
            marker.setLabel(label);
            
            // 为好友评分添加昵称标签
            if (poi.is_friend_review && poi.friend_nickname) {
                const nicknameLabel = new BMapGL.Label(`👤 ${poi.friend_nickname}`, {
                    position: pt,
                    offset: new BMapGL.Size(20, -30)
                });
                nicknameLabel.setStyle({
                    color: '#333',
                    fontSize: '10px',
                    background: 'rgba(255,192,203,0.85)',
                    border: 'none',
                    padding: '1px 4px',
                    borderRadius: '4px',
                    fontWeight: 'normal',
                    zIndex: 999,
                    whiteSpace: 'nowrap'
                });
                
                map.addOverlay(nicknameLabel);
                // 使用唯一的key避免覆盖
                const nicknameKey = `${poi.uid}_${poi.user_id}`;
                window.mapMarkers.nicknames[nicknameKey] = nicknameLabel;
            }
            
            // 添加点击事件
            marker.addEventListener('click', function() {
                showPoiInfoWindow(poi, marker);
            });
            
            // 添加到地图
            map.addOverlay(marker);
            // 使用唯一的key避免覆盖
            const markerKey = `${poi.uid}_${poi.user_id}`;
            window.mapMarkers.rated[markerKey] = marker;
        }
        
        // 更新筛选状态
        function updateFilterState() {
            // 获取选中的评分类型
            const checkedRates = Object.keys(listFilterState).filter(key => listFilterState[key]);
            
            // 获取选中的用户ID
            const checkedUserIds = Object.keys(userFilterState)
                .filter(key => userFilterState[key])
                .map(key => userFilterMapping[key]);
            
            window.filterState = {
                rates: checkedRates,
                users: checkedUserIds
            };
            
            console.log('Filter state updated:', window.filterState);
        }
        
        // 更新地图视口以显示评分点
        function updateMapViewportForRatedPois() {
            const visiblePois = getVisibleRatedPois();
            if (visiblePois && visiblePois.length > 0) {
                const points = visiblePois
                    .filter(poi => poi.point && typeof poi.point.lng === 'number' && typeof poi.point.lat === 'number')
                    .map(poi => new BMapGL.Point(poi.point.lng, poi.point.lat));
                if (points.length > 0) {
                    // 手动扩大边界，避免贴边
                    let minLng = Math.min(...points.map(p => p.lng));
                    let maxLng = Math.max(...points.map(p => p.lng));
                    let minLat = Math.min(...points.map(p => p.lat));
                    let maxLat = Math.max(...points.map(p => p.lat));
                    const padding = 0.01;
                    minLng -= padding; maxLng += padding; minLat -= padding; maxLat += padding;
                    
                    // 为右侧信息面板预留空间
                    const mapSize = map.getSize();
                    const panelWidth = 400; // 信息面板宽度
                    const mapWidth = mapSize.width;
                    if (mapWidth > 0) {
                        // 计算信息面板占地图宽度的比例
                        const panelRatio = panelWidth / mapWidth;
                        // 计算需要为信息面板预留的经纬度偏移量
                        const lngRange = maxLng - minLng;
                        const panelOffset = lngRange * panelRatio * 1.8; // 1.2是调整系数，增加左侧空间
                        maxLng += panelOffset;
                    }
                    
                    map.setViewport([
                        new BMapGL.Point(minLng, minLat),
                        new BMapGL.Point(maxLng, maxLat)
                    ]);
                }
            }
        }
        
        // 清除搜索标记
        function clearPoiMarkers() {
            // 清除搜索标记
            window.mapMarkers.search.forEach(marker => {
                map.removeOverlay(marker);
            });
            window.mapMarkers.search = [];
        }

        // ===================== 信息窗口 =====================
        function getPoiField(poi, fieldNames) {
            // 支持多种可能的字段名，按优先级返回第一个存在的值
            for (let fieldName of fieldNames) {
                if (poi[fieldName] !== undefined && poi[fieldName] !== null && poi[fieldName] !== '') {
                    return poi[fieldName];
                }
            }
            return '';
        }

        function getShortTitle(title) {
            if (!title) return '';
            const idx = title.indexOf('(');
            return idx > 0 ? title.slice(0, idx).trim() : title;
        }

        function showPoiInfoWindow(poi, marker) {
            // 跳转到餐厅详情页面
            updateInfoPanel(poi, 'detail');
        }

        // ===================== 地图与搜索 =====================
        function initMap() {
            map = new BMapGL.Map("map", {enableIconClick: true});
            map.centerAndZoom(new BMapGL.Point(116.404, 39.915), GLOBAL_DEFAULT_ZOOM);
            map.enableScrollWheelZoom(true);
            map.setMapStyleV2({ styleId: '75a3e83ace0ff353fbf5a085935333e7' });
            
            // 添加地图控件
            // 添加比例尺控件（左下角）
            var scaleCtrl = new BMapGL.ScaleControl({
                anchor: BMAP_ANCHOR_BOTTOM_LEFT,
                offset: new BMapGL.Size(20, 20)
            });
            map.addControl(scaleCtrl);
            
            // 添加定位控件（左下角，在比例尺上方）
            var locationControl = new BMapGL.LocationControl({
                anchor: BMAP_ANCHOR_BOTTOM_LEFT,
                offset: new BMapGL.Size(20, 80)
            });
            map.addControl(locationControl);
            
            // 添加定位事件监听
            locationControl.addEventListener("locationSuccess", function(e){
                var address = '';
                address += e.addressComponent.province;
                address += e.addressComponent.city;
                address += e.addressComponent.district;
                address += e.addressComponent.street;
                address += e.addressComponent.streetNumber;
                console.log("当前定位地址为：" + address);
            });
            locationControl.addEventListener("locationError", function(e){
                console.log("定位失败：" + e.message);
            });
            
            // 自定义全显示按钮（眼睛图标）
            var fullViewBtn = document.createElement('div');
            fullViewBtn.style.cssText = `
                position: absolute;
                left: 20px;
                bottom: 140px;
                width: 40px;
                height: 40px;
                background: #fff;
                border: 1px solid #ccc;
                border-radius: 4px;
                display: flex;
                align-items: center;
                justify-content: center;
                cursor: pointer;
                font-size: 16px;
                z-index: 1000;
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            `;
            fullViewBtn.innerHTML = '👁️';
            fullViewBtn.title = '显示所有评分点';
            fullViewBtn.onclick = function() {
                updateMapViewportForRatedPois();
            };
            document.body.appendChild(fullViewBtn);
            
            // 不再设置最大缩放，用户可手动放大
            initLocalSearch();
        }
        function initLocalSearch() {
            localSearch = new BMapGL.LocalSearch(map, {
                renderOptions: { map: null, autoViewport: false },
                pageCapacity: 20 // 每页20条
            });
            localSearch.setSearchCompleteCallback(handleSearchResults);
        }
        function handleSearchResults(results) {
            clearPoiMarkers();
            const points = [];
            const searchResults = [];
            for (let i = 0; i < results.getCurrentNumPois(); i++) {
                const poi = results.getPoi(i);
                if (poi && poi.point) {
                    const marker = createPoiMarker(poi);
                    map.addOverlay(marker);
                    window.mapMarkers.search.push(marker);
                    points.push(poi.point);
                    searchResults.push(poi);
                }
            }
            if (points.length > 0) {
                map.setViewport(points);
            }
            // 分页累加
            if (currentSearchPage === 0) {
                currentSearchResults = searchResults;
            } else {
                currentSearchResults = currentSearchResults.concat(searchResults);
            }
            hasMoreSearchResults = searchResults.length === 20;
            updateInfoPanel(null, 'search', currentSearchResults);
        }
        function createPoiMarker(poi) {
            const marker = new BMapGL.Marker(poi.point);
            // 将POI数据存储到marker中，方便后续获取
            marker._poiData = poi;
            marker.addEventListener('click', function() {
                showPoiInfoWindow(poi, marker);
            });
            return marker;
        }

        // ===================== 认证事件绑定 =====================
        function bindAuthEvents() {
            // 登录按钮点击事件
            document.getElementById('login-btn').addEventListener('click', () => {
                showModal('login-modal');
            });
            
            // 注册按钮点击事件
            document.getElementById('register-btn').addEventListener('click', () => {
                showModal('register-modal');
            });
            
            // 退出登录按钮点击事件
            document.getElementById('logout-btn').addEventListener('click', () => {
                if (confirm('确定要退出登录吗？')) {
                    // 在清除会话之前重置所有状态
                    window.ratedPois = [];
                    currentPoi = null;
                    currentView = 'list';
                    currentSearchResults = [];
                    previousView = 'list';
                    currentSearchKeyword = '';
                    currentSearchPage = 0;
                    hasMoreSearchResults = false;
                    
                    // 重置筛选器状态
                    listFilterState = {
                        '超爱': true,
                        '喜欢': true,
                        '一般': true,
                        '不会再去了': true
                    };
                    userFilterState = {};
                    userFilterMapping = {};
                    
                    // 清除地图标记
                    clearAllMapMarkers();
                    
                    // 重置地图视口到默认状态
                    map.centerAndZoom(new BMapGL.Point(116.404, 39.915), 11);
                    
                    // 重置筛选状态
                    window.filterState = {
                        rates: [],
                        users: []
                    };
                    
                    // 清除会话
                    clearUserSession();
                    
                    // 重置信息面板到初始状态
                    const panelContent = document.getElementById('info-panel-content');
                    panelContent.innerHTML = `
                        <div class="info-panel-section">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <h3>🍽️ 餐厅评分</h3>
                                <button class="info-panel-btn" onclick="updateInfoPanel(null, 'stats')">统计</button>
                            </div>
                            
                            <div class="filter-bar" id="filter-bar">
                                <div class="filter-bar-header" onclick="toggleFilterBar()">
                                    <div class="filter-bar-title">
                                        🔍 筛选条件
                                        <span class="filter-summary">4个评分类型, 0个用户</span>
                                    </div>
                                    <div class="filter-bar-toggle">▼</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="info-panel-section">
                            <h4>餐厅列表 (0个)</h4>
                            <div class="restaurant-list">
                                <div style="text-align: center; color: #999; padding: 20px;">暂无评分餐厅</div>
                            </div>
                        </div>
                    `;
                    
                    // 显示退出提示
                    if (currentView === 'list') {
                        const panelContent = document.getElementById('info-panel-content');
                        const logoutDiv = document.createElement('div');
                        logoutDiv.style.cssText = 'background: #f8d7da; color: #721c24; padding: 12px; border-radius: 6px; margin-bottom: 16px; text-align: center;';
                        logoutDiv.textContent = '已退出登录，请重新登录才能进行评分操作。';
                        panelContent.insertBefore(logoutDiv, panelContent.firstChild);
                        setTimeout(() => logoutDiv.remove(), 3000);
                    }
                }
            });
            
            // 模态框关闭按钮事件
            document.getElementById('login-modal-close').addEventListener('click', () => {
                hideModal('login-modal');
            });
            
            document.getElementById('register-modal-close').addEventListener('click', () => {
                hideModal('register-modal');
            });
            
            document.getElementById('welcome-modal-close').addEventListener('click', () => {
                hideModal('welcome-modal');
            });
            
            // 模态框背景点击关闭
            document.getElementById('login-modal').addEventListener('click', (e) => {
                if (e.target.id === 'login-modal') {
                    hideModal('login-modal');
                }
            });
            
            document.getElementById('register-modal').addEventListener('click', (e) => {
                if (e.target.id === 'register-modal') {
                    hideModal('register-modal');
                }
            });
            
            document.getElementById('welcome-modal').addEventListener('click', (e) => {
                if (e.target.id === 'welcome-modal') {
                    hideModal('welcome-modal');
                }
            });
            
            // 切换模态框按钮事件
            document.getElementById('switch-to-register').addEventListener('click', () => {
                switchModal('login-modal', 'register-modal');
            });
            
            document.getElementById('switch-to-login').addEventListener('click', () => {
                switchModal('register-modal', 'login-modal');
            });
            
            // 登录表单提交事件
            document.getElementById('login-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const uniqueId = document.getElementById('login-unique-id').value.trim();
                const password = document.getElementById('login-password').value;
                const submitBtn = e.target.querySelector('.auth-submit-btn');
                
                // 清除之前的错误
                clearFormError(e.target.querySelector('.form-group'));
                
                // 验证输入
                if (!uniqueId) {
                    showFormError(e.target.querySelector('.form-group'), '请输入用户名');
                    return;
                }
                
                if (!password) {
                    showFormError(e.target.querySelector('.form-group:last-child'), '请输入密码');
                    return;
                }
                
                // 禁用提交按钮
                submitBtn.disabled = true;
                submitBtn.textContent = '登录中...';
                
                try {
                    const user = await loginUser(uniqueId, password);
                    currentUser = user;
                    isLoggedIn = true;
                    saveUserSession(user);
                    updateUserStatusUI();
                    
                    showSuccessMessage(document.getElementById('login-modal'), '登录成功！');
                    
                                            // 延迟关闭模态框
                        setTimeout(async () => {
                            hideModal('login-modal');
                            // 清空表单
                            e.target.reset();
                            
                            // 更新用户筛选状态
                            userFilterState = { self: true };
                            userFilterMapping = { self: currentUser.id };
                            
                            // 初始化好友API
                            initFriendshipAPI();
                            
                            // 加载用户评分数据
                            await loadRatedPois();
                            await updateUserFilters(); // 更新用户筛选器
                            updateFilterState();
                            updateMapMarkers();
                            updateMapViewportForRatedPois();
                            updateInfoPanel(null, 'list'); // 新增：登录后立即刷新评分列表
                        
                        // 显示欢迎消息
                        if (currentView === 'list') {
                            const panelContent = document.getElementById('info-panel-content');
                            const welcomeDiv = document.createElement('div');
                            welcomeDiv.style.cssText = 'background: #d4edda; color: #155724; padding: 12px; border-radius: 6px; margin-bottom: 16px; text-align: center;';
                            welcomeDiv.textContent = `欢迎回来，${currentUser.nickname}！现在可以开始评分了。`;
                            panelContent.insertBefore(welcomeDiv, panelContent.firstChild);
                            setTimeout(() => welcomeDiv.remove(), 3000);
                        }
                    }, 1500);
                    
                } catch (error) {
                    showFormError(e.target.querySelector('.form-group'), error.message);
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.textContent = '登录';
                }
            });
            
            // 注册表单提交事件
            document.getElementById('register-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const nickname = document.getElementById('register-nickname').value.trim();
                const uniqueId = document.getElementById('register-unique-id').value.trim();
                const password = document.getElementById('register-password').value;
                const confirmPassword = document.getElementById('register-confirm-password').value;
                const submitBtn = e.target.querySelector('.auth-submit-btn');
                
                // 清除之前的错误
                e.target.querySelectorAll('.form-group').forEach(el => clearFormError(el));
                
                // 验证输入
                if (!validateNickname(nickname)) {
                    showFormError(e.target.querySelector('.form-group'), '昵称至少需要2个字符');
                    return;
                }
                
                if (!validateUniqueId(uniqueId)) {
                    showFormError(e.target.querySelectorAll('.form-group')[1], '用户名格式不正确（3-20位字母数字下划线）');
                    return;
                }
                
                if (!validatePassword(password)) {
                    showFormError(e.target.querySelectorAll('.form-group')[2], '密码至少需要6个字符');
                    return;
                }
                
                if (password !== confirmPassword) {
                    showFormError(e.target.querySelectorAll('.form-group')[3], '两次输入的密码不一致');
                    return;
                }
                
                // 禁用提交按钮
                submitBtn.disabled = true;
                submitBtn.textContent = '注册中...';
                
                try {
                    const user = await registerUser(nickname, uniqueId, password);
                    currentUser = user;
                    isLoggedIn = true;
                    saveUserSession(user);
                    updateUserStatusUI();
                    
                    showSuccessMessage(document.getElementById('register-modal'), '注册成功！');
                    
                                            // 延迟关闭模态框
                        setTimeout(async () => {
                            hideModal('register-modal');
                            // 清空表单
                            e.target.reset();
                            
                            // 更新用户筛选状态
                            userFilterState = { self: true };
                            userFilterMapping = { self: currentUser.id };
                            
                            // 初始化好友API
                            initFriendshipAPI();
                            
                            // 加载用户评分数据
                            await loadRatedPois();
                            await updateUserFilters(); // 更新用户筛选器
                            updateFilterState();
                            updateMapMarkers();
                            updateMapViewportForRatedPois();
                            updateInfoPanel(null, 'list'); // 新增：注册后立即刷新评分列表
                        
                        // 显示欢迎消息
                        if (currentView === 'list') {
                            const panelContent = document.getElementById('info-panel-content');
                            const welcomeDiv = document.createElement('div');
                            welcomeDiv.style.cssText = 'background: #d4edda; color: #155724; padding: 12px; border-radius: 6px; margin-bottom: 16px; text-align: center;';
                            welcomeDiv.textContent = `欢迎加入，${currentUser.nickname}！现在可以开始评分了。`;
                            panelContent.insertBefore(welcomeDiv, panelContent.firstChild);
                            setTimeout(() => welcomeDiv.remove(), 3000);
                        }
                    }, 1500);
                    
                } catch (error) {
                    showFormError(e.target.querySelectorAll('.form-group')[1], error.message);
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.textContent = '注册';
                }
            });
        }
        
        // ===================== 事件绑定 =====================
        function bindUIEvents() {
            document.getElementById('search-btn').onclick = function() {
                const keyword = document.getElementById('keyword').value.trim();
                if (!keyword) {
                    alert('请输入搜索关键字');
                    return;
                }
                currentSearchPage = 0;
                currentSearchKeyword = keyword;
                currentSearchResults = [];
                hasMoreSearchResults = false;
                localSearch.search(keyword);
            };
            document.getElementById('keyword').addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    document.getElementById('search-btn').click();
                }
            });
            
            // 信息面板收缩/展开事件绑定
            function toggleInfoPanel() {
                const panel = document.getElementById('info-panel');
                const btn = document.getElementById('info-panel-toggle-btn');
                const isCollapsed = panel.classList.contains('collapsed');
                if (isCollapsed) {
                    panel.classList.remove('collapsed');
                    // btn.innerText 不再切换
                    panel.style.height = (panel._lastHeight || 600) + 'px';
                    panel.style.width = (panel._lastWidth || 400) + 'px';
                } else {
                    panel._lastHeight = panel.offsetHeight;
                    panel._lastWidth = panel.offsetWidth;
                    panel.classList.add('collapsed');
                    // btn.innerText 不再切换
                    panel.style.height = '48px';
                    panel.style.width = '48px';
                }
            }
            document.getElementById('info-panel-header').onclick = toggleInfoPanel;
            // 下边拉伸
            (function() {
                const panel = document.getElementById('info-panel');
                const resizer = document.getElementById('info-panel-resizer');
                let startY, startHeight, dragging = false;
                resizer.addEventListener('mousedown', function(e) {
                    if (panel.classList.contains('collapsed')) return;
                    dragging = true;
                    startY = e.clientY;
                    startHeight = panel.offsetHeight;
                    document.body.style.userSelect = 'none';
                });
                window.addEventListener('mousemove', function(e) {
                    if (!dragging) return;
                    let newHeight = startHeight + (e.clientY - startY);
                    newHeight = Math.max(120, Math.min(newHeight, window.innerHeight * 0.9));
                    panel.style.height = newHeight + 'px';
                    panel._lastHeight = newHeight;
                });
                window.addEventListener('mouseup', function() {
                    if (dragging) {
                        dragging = false;
                        document.body.style.userSelect = '';
                    }
                });
            })();
            // 右下角拉伸
            (function() {
                const panel = document.getElementById('info-panel');
                const resizer = document.getElementById('info-panel-corner-resizer');
                let startY, startX, startHeight, startWidth, dragging = false;
                resizer.addEventListener('mousedown', function(e) {
                    if (panel.classList.contains('collapsed')) return;
                    dragging = true;
                    startY = e.clientY;
                    startX = e.clientX;
                    startHeight = panel.offsetHeight;
                    startWidth = panel.offsetWidth;
                    document.body.style.userSelect = 'none';
                    e.preventDefault();
                });
                window.addEventListener('mousemove', function(e) {
                    if (!dragging) return;
                    let newHeight = startHeight + (e.clientY - startY);
                    let newWidth = startWidth + (e.clientX - startX);
                    newHeight = Math.max(120, Math.min(newHeight, window.innerHeight * 0.9));
                    newWidth = Math.max(220, Math.min(newWidth, window.innerWidth * 0.9));
                    panel.style.height = newHeight + 'px';
                    panel.style.width = newWidth + 'px';
                    panel._lastHeight = newHeight;
                    panel._lastWidth = newWidth;
                });
                window.addEventListener('mouseup', function() {
                    if (dragging) {
                        dragging = false;
                        document.body.style.userSelect = '';
                    }
                });
            })();
            // 左下角拉伸
            (function() {
                const panel = document.getElementById('info-panel');
                const resizer = document.getElementById('info-panel-corner-resizer-left');
                let startY, startX, startHeight, startWidth, dragging = false;
                resizer.addEventListener('mousedown', function(e) {
                    if (panel.classList.contains('collapsed')) return;
                    dragging = true;
                    startY = e.clientY;
                    startX = e.clientX;
                    startHeight = panel.offsetHeight;
                    startWidth = panel.offsetWidth;
                    document.body.style.userSelect = 'none';
                    e.preventDefault();
                });
                window.addEventListener('mousemove', function(e) {
                    if (!dragging) return;
                    let newHeight = startHeight + (e.clientY - startY);
                    let newWidth = startWidth - (e.clientX - startX);
                    newHeight = Math.max(120, Math.min(newHeight, window.innerHeight * 0.9));
                    newWidth = Math.max(220, Math.min(newWidth, window.innerWidth * 0.9));
                    panel.style.height = newHeight + 'px';
                    panel.style.width = newWidth + 'px';
                    panel._lastHeight = newHeight;
                    panel._lastWidth = newWidth;
                });
                window.addEventListener('mouseup', function() {
                    if (dragging) {
                        dragging = false;
                        document.body.style.userSelect = '';
                    }
                });
            })();
            
            // 点击地图空白处时显示餐厅列表
            map.addEventListener('click', function(e) {
                // 检查是否点击的是地图本身而不是marker
                if (e.target === map || e.target === map.getContainer()) {
                    currentPoi = null;
                    // 如果当前有搜索结果，显示搜索结果；否则显示餐厅列表
                    if (currentView === 'search' && currentSearchResults.length > 0) {
                        updateInfoPanel(null, 'search', currentSearchResults);
                    } else {
                        updateInfoPanel(null, 'list');
                    }
                }
            });
        }
        
        // ===================== 信息面板功能 =====================
        let currentPoi = null;
        let currentView = 'list'; // 'list', 'detail', 'stats', 'search'
        let currentSearchResults = []; // 存储当前搜索结果
        let previousView = 'list'; // 存储之前的视图状态
        let currentSearchKeyword = '';
        let currentSearchPage = 0;
        let hasMoreSearchResults = false;
        
        // ===================== 视图渲染 =====================
        function updateInfoPanel(poi = null, view = 'list', searchResults = []) {
            const panelContent = document.getElementById('info-panel-content');
            
            if (view === 'stats') {
                // 显示统计信息
                currentView = 'stats';
                const stats = getRatedPoisStats();
                panelContent.innerHTML = `
                    <div class="info-panel-section">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <h3>📊 ${isLoggedIn ? '我的评分统计' : '评分统计'}</h3>
                            <button class="info-panel-btn" onclick="updateInfoPanel(null, 'list')">餐厅列表</button>
                        </div>
                        <div class="info-panel-stats">
                            <div class="info-panel-stat">
                                <div class="info-panel-stat-value">${stats.total}</div>
                                <div class="info-panel-stat-label">总评分</div>
                            </div>
                            <div class="info-panel-stat">
                                <div class="info-panel-stat-value">${stats.cities}</div>
                                <div class="info-panel-stat-label">涉及城市</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="info-panel-section">
                        <h3>⭐ 评分分布</h3>
                        ${RATE_TYPES.map(type => {
                            const count = stats.rateCounts[type.value] || 0;
                            return `
                                <div class="info-panel-item">
                                    <span class="info-panel-label">${type.value}</span>
                                    <span class="info-panel-value">${count}个</span>
                                </div>
                            `;
                        }).join('')}
                    </div>
                    
                    <div class="info-panel-section">
                        <h3>🏙️ 城市分布</h3>
                        ${Object.entries(stats.cityCounts).map(([city, count]) => `
                            <div class="info-panel-item">
                                <span class="info-panel-label">${city}</span>
                                <span class="info-panel-value">${count}个</span>
                            </div>
                        `).join('')}
                    </div>
                `;
            } else if (view === 'search') {
                // 显示搜索结果
                currentView = 'search';
                currentSearchResults = searchResults; // 保存当前搜索结果
                const keyword = currentSearchKeyword || document.getElementById('keyword').value.trim();
                panelContent.innerHTML = `
                    <div class="info-panel-section">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <h3>🔍 搜索结果</h3>
                            <div>
                                <button class="info-panel-btn" onclick="goToMyRestaurants()">${isLoggedIn ? '我的餐厅' : '餐厅评分'}</button>
                            </div>
                        </div>
                        <h4>关键词: "${keyword}" (${searchResults.length}个结果)</h4>
                    </div>
                    <div class="info-panel-section flex-grow">
                        <div class="restaurant-list">
                            ${searchResults.length > 0 ? searchResults.map(poi => {
                                const title = getPoiField(poi, ['title', 'name']);
                                const shortTitle = getShortTitle(title);
                                const city = getPoiField(poi, ['city', 'cityname']);
                                const area = getPoiField(poi, ['area', 'areaname', 'district']);
                                const address = getPoiField(poi, ['address', 'addr']);
                                const ratedPoi = window.ratedPois.find(rp => rp.uid === poi.uid);
                                const rateType = ratedPoi ? RATE_TYPES.find(t => t.value === ratedPoi.rate) : null;
                                return `
                                    <div class="restaurant-item" onclick="showSearchResultDetail('${poi.uid}')">
                                        <div class="restaurant-header">
                                            <span class="restaurant-name">${shortTitle || title || ''}</span>
                                            ${ratedPoi ? `<span class="restaurant-rate" style="color: ${rateType?.drop || '#666'}; white-space: nowrap;">${ratedPoi.rate}</span>` : ''}
                                        </div>
                                        <div class="restaurant-location">${city || ''}${area ? ' · ' + area : ''}</div>
                                        <div class="restaurant-address">${address || ''}</div>
                                    </div>
                                `;
                            }).join('') : '<div style="text-align: center; color: #999; padding: 20px;">未找到相关结果</div>'}
                        </div>
                        ${hasMoreSearchResults ? `
                        <div style="margin-top: 12px; text-align: center;">
                            <button class="info-panel-btn" onclick="loadMoreSearchResults()" style="background: #52c41a; color: #fff;">加载更多结果</button>
                        </div>
                        ` : ''}
                    </div>
                `;
            } else if (view === 'list') {
                // 显示餐厅列表
                currentView = 'list';
                const filteredPois = getVisibleRatedPois();
                
                panelContent.innerHTML = `
                    <div class="info-panel-section">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <h3>🍽️ ${isLoggedIn ? '我的餐厅' : '餐厅评分'}</h3>
                            <button class="info-panel-btn" onclick="updateInfoPanel(null, 'stats')">统计</button>
                        </div>
                        
                        <div class="filter-bar ${filterBarExpanded ? 'expanded' : ''}" id="filter-bar">
                            <div class="filter-bar-header" onclick="toggleFilterBar()">
                                <div class="filter-bar-title">
                                    🔍 筛选条件
                                    <span class="filter-summary">${getFilterSummary()}</span>
                                </div>
                                <div class="filter-bar-toggle">▼</div>
                            </div>
                            <div class="filter-bar-content">
                                <div class="filter-section">
                                    <div class="filter-section-title">
                                        ⭐ 评分筛选
                                    </div>
                                    <div class="filter-section-content">
                                        ${RATE_TYPES.map(type => `
                                            <div class="filter-checkbox-container" onclick="toggleRateFilter('${type.value}')">
                                                <input type="checkbox" class="rate-filter" value="${type.value}" ${listFilterState[type.value] ? 'checked' : ''} onclick="event.stopPropagation(); toggleRateFilter('${type.value}');">
                                                <span>${type.value}</span>
                                            </div>
                                        `).join('')}
                                    </div>
                                    <div class="filter-actions">
                                        <button class="info-panel-btn" onclick="selectAllRateFilters()">全选</button>
                                        <button class="info-panel-btn" onclick="clearAllRateFilters()">全不选</button>
                                    </div>
                                </div>
                                
                                <div class="filter-section">
                                    <div class="filter-section-title">
                                        👤 用户筛选
                                    </div>
                                    <div class="filter-section-content" id="user-filter-content">
                                        ${Object.keys(userFilterState).map(user => {
                                            // 获取显示名称
                                            let displayName = user;
                                            if (user === 'self') {
                                                displayName = '自己';
                                            } else if (user.startsWith('friend_')) {
                                                // 从好友列表中获取昵称
                                                const friendId = userFilterMapping[user];
                                                const friend = window.friendsList ? window.friendsList.find(f => 
                                                    (f.friend_id === currentUser.id ? f.user_id : f.friend_id) === friendId
                                                ) : null;
                                                displayName = friend ? (friend.friend_id === currentUser.id ? friend.user_nickname : friend.friend_nickname) : `好友${friendId.slice(0, 8)}`;
                                            }
                                            
                                            return `
                                                <div class="filter-checkbox-container" onclick="toggleUserFilter('${user}')">
                                                    <input type="checkbox" class="user-filter" value="${user}" ${userFilterState[user] ? 'checked' : ''} onclick="event.stopPropagation(); toggleUserFilter('${user}');">
                                                    <span>${displayName}</span>
                                                </div>
                                            `;
                                        }).join('')}
                                    </div>
                                    <div class="filter-actions">
                                        <button class="info-panel-btn" onclick="selectAllUserFilters()">全选</button>
                                        <button class="info-panel-btn" onclick="clearAllUserFilters()">全不选</button>
                                        <button class="info-panel-btn" onclick="refreshUserFilters()">🔄 刷新好友</button>
                                    </div>
                                </div>
                                
                                <!-- 预留距离筛选位置 -->
                                <div class="filter-section" style="display: none;">
                                    <div class="filter-section-title">
                                        📍 距离筛选
                                    </div>
                                    <div class="filter-section-content">
                                        <div style="color: #999; font-size: 12px;">距离筛选功能开发中...</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="info-panel-section">
                            <h4>餐厅列表 (${filteredPois.length}个)</h4>
                            <div class="restaurant-list">
                                ${filteredPois.length > 0 ? filteredPois.map(poi => {
                                    const rateType = RATE_TYPES.find(t => t.value === poi.rate);
                                    const isFriendReview = poi.is_friend_review;
                                    const reviewerName = isFriendReview ? poi.friend_nickname : '我';
                                    return `
                                        <div class="restaurant-item" onclick="showRestaurantDetail('${poi.uid}')">
                                            <div class="restaurant-header">
                                                <span class="restaurant-name">${poi.shortTitle || poi.title}</span>
                                                <div class="restaurant-rate-container">
                                                    ${isFriendReview ? `<span class="friend-badge">👤 ${reviewerName}</span>` : ''}
                                                    <span class="restaurant-rate" style="color: ${rateType?.drop || '#666'}; white-space: nowrap;">${poi.rate}</span>
                                                </div>
                                            </div>
                                            <div class="restaurant-location">${poi.city || ''}${poi.area ? ' · ' + poi.area : ''}</div>
                                            <div class="restaurant-address">${poi.address || ''}</div>
                                        </div>
                                    `;
                                }).join('') : '<div style="text-align: center; color: #999; padding: 20px;">暂无评分餐厅</div>'}
                            </div>
                            ${filteredPois.length > 0 ? `
                            <div style="margin-top: 12px; text-align: center;">
                                ${!isLoggedIn ? `
                                    <button class="info-panel-btn" onclick="showModal('login-modal')" style="background: #1b8eec; color: #fff;">登录后管理评分</button>
                                ` : `
                                    <button class="info-panel-btn" onclick="clearAllRatedPois()" style="background: #ff4d4f; color: #fff;">清除所有评分</button>
                                `}
                            </div>
                            ` : ''}
                        </div>
                    </div>
                `;
                

                
            } else if (poi) {
                // 选定餐厅自动缩放到对应位置
                if (poi.point) {
                    map.centerAndZoom(new BMapGL.Point(poi.point.lng, poi.point.lat), GLOBAL_DEFAULT_ZOOM);
                }
                // 显示POI详细信息
                previousView = currentView; // 保存之前的视图
                currentView = 'detail';
                currentPoi = poi;
                const title = getPoiField(poi, ['title', 'name']);
                const shortTitle = getShortTitle(title);
                const city = getPoiField(poi, ['city', 'cityname']);
                const area = getPoiField(poi, ['area', 'areaname', 'district']);
                const address = getPoiField(poi, ['address', 'addr']);
                const phoneNumber = getPoiField(poi, ['phoneNumber', 'phone', 'tel']);
                const tags = getPoiField(poi, ['tags', 'std_tag', 'tag']) || [];
                const tagArray = Array.isArray(tags) ? tags : (typeof tags === 'string' ? tags.split(',').map(t => t.trim()) : []);
                
                // 检查所有相关评分
                const allReviews = window.ratedPois.filter(rp => rp.uid === poi.uid);
                // 获取我的评分
                const myReview = allReviews.find(rp => rp.user_id === currentUser?.id);
                // 获取所有好友评分
                const friendReviews = allReviews.filter(rp => rp.is_friend_review && rp.user_id !== currentUser?.id);
                
                console.log('Reviews for POI:', {
                    all: allReviews,
                    my: myReview,
                    friends: friendReviews
                });
                
                panelContent.innerHTML = `
                    <!-- 1. 餐厅详情部分 -->
                    <div class="info-panel-section">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <h3>📍 餐厅详情</h3>
                            <button class="info-panel-btn" onclick="goBackFromDetail()">返回</button>
                        </div>
                        
                        <div class="info-panel-item">
                            <span class="info-panel-label">名称</span>
                            <span class="info-panel-value">${shortTitle || title || ''}</span>
                        </div>
                        <div class="info-panel-item">
                            <span class="info-panel-label">位置</span>
                            <span class="info-panel-value">${city || ''}${area ? ' · ' + area : ''}</span>
                        </div>
                        <div class="info-panel-item">
                            <span class="info-panel-label">地址</span>
                            <span class="info-panel-value">${address || ''}</span>
                        </div>
                        ${phoneNumber ? `
                        <div class="info-panel-item">
                            <span class="info-panel-label">电话</span>
                            <span class="info-panel-value">${phoneNumber}</span>
                        </div>
                        ` : ''}
                        ${tagArray.length > 0 ? `
                        <div class="info-panel-item">
                            <span class="info-panel-label">标签</span>
                            <div class="info-panel-tags">
                                ${tagArray.map(tag => `<span class="info-panel-tag">${tag}</span>`).join('')}
                            </div>
                        </div>
                        ` : ''}
                    </div>
                    
                    <!-- 2. 好友评分部分（仅当有好友评分时显示） -->
                    ${friendReviews.length > 0 ? `
                    <div class="info-panel-section">
                        <h3>👥 好友评分</h3>
                        ${friendReviews.map(friendReview => `
                            <div class="info-panel-item">
                                <span class="info-panel-label">${friendReview.friend_nickname}</span>
                                <div class="info-panel-value-container">
                                    <span class="info-panel-value" style="color: ${RATE_TYPES.find(t => t.value === friendReview.rate)?.drop || '#666'}; white-space: nowrap;">${friendReview.rate}</span>
                                </div>
                            </div>
                            ${friendReview.review_text ? `
                            <div class="info-panel-item" style="margin-top: 4px;">
                                <span class="info-panel-label"></span>
                                <div class="info-panel-value-container">
                                    <span class="info-panel-value" style="color: #666; font-size: 12px; font-style: italic;">"${friendReview.review_text}"</span>
                                </div>
                            </div>
                            ` : ''}
                        `).join('')}
                    </div>
                    ` : ''}
                    
                    <!-- 3. 评分操作部分 -->
                    <div class="info-panel-section">
                        <h3>⭐ 评分操作</h3>
                        ${!isLoggedIn ? `
                            <div style="text-align: center; padding: 20px; background: #f8f9fa; border-radius: 8px; margin-bottom: 12px;">
                                <div style="color: #666; margin-bottom: 12px;">请先登录才能进行评分</div>
                                <button class="info-panel-btn" onclick="showModal('login-modal')" style="background: #1b8eec; color: #fff;">立即登录</button>
                            </div>
                        ` : `
                            ${myReview ? `
                                <div class="info-panel-item">
                                    <span class="info-panel-label">我的评分</span>
                                    <div class="info-panel-value-container">
                                        <span class="info-panel-value" style="color: ${RATE_TYPES.find(t => t.value === myReview.rate)?.drop || '#666'}; white-space: nowrap;">${myReview.rate}</span>
                                    </div>
                                </div>
                            ` : `
                                <div class="info-panel-item">
                                    <span class="info-panel-label">我的评分</span>
                                    <span class="info-panel-value" style="color: #999;">未评分</span>
                                </div>
                            `}
                            <div style="margin-top: 12px;">
                                ${RATE_TYPES.map(t => `
                                    <button class="info-panel-btn rate-btn" data-rate="${t.value}" style="background:${t.drop};color:${t.star === 'black' ? '#000' : '#fff'};margin-right:8px;margin-bottom:8px;">${t.value}</button>
                                `).join('')}
                                ${myReview ? `
                                    <button class="info-panel-btn" id="remove-rate-btn" style="background:#bbb;color:#fff;margin-bottom:8px;">取消评价</button>
                                ` : ''}
                            </div>
                        `}
                    </div>
                    
                    <div class="info-panel-section">
                        <h3>📍 坐标信息</h3>
                        <div class="info-panel-item">
                            <span class="info-panel-label">经度</span>
                            <span class="info-panel-value">${poi.point ? poi.point.lng.toFixed(6) : ''}</span>
                        </div>
                        <div class="info-panel-item">
                            <span class="info-panel-label">纬度</span>
                            <span class="info-panel-value">${poi.point ? poi.point.lat.toFixed(6) : ''}</span>
                        </div>
                    </div>
                `;
                
                // 简化：直接绑定评分按钮事件，不使用延迟
                const rateBtns = panelContent.querySelectorAll('.rate-btn');
                const removeBtn = panelContent.querySelector('#remove-rate-btn');
                
                rateBtns.forEach(btn => {
                    btn.onclick = async function() {
                        if (!isLoggedIn) {
                            showModal('login-modal');
                            return;
                        }
                        const rate = btn.getAttribute('data-rate');
                        
                        // 添加加载状态
                        const originalText = btn.textContent;
                        btn.textContent = '保存中...';
                        btn.disabled = true;
                        
                        try {
                            console.log('Adding rating:', { poi, rate });
                            // 创建新的评分数据，确保是自己的评分
                            await addOrUpdateRatedPoi(poi, rate);
                            // 更新筛选状态和地图标记
                            updateFilterState();
                            updateMapMarkers();
                        } finally {
                            // 恢复按钮状态
                            btn.textContent = originalText;
                            btn.disabled = false;
                        }
                    }
                });
                
                if (removeBtn) {
                    removeBtn.onclick = async function() {
                        if (!isLoggedIn) {
                            showModal('login-modal');
                            return;
                        }
                        
                        // 添加加载状态
                        const originalText = removeBtn.textContent;
                        removeBtn.textContent = '删除中...';
                        removeBtn.disabled = true;
                        
                        try {
                            await removeRatedPoi(poi.uid);
                        } finally {
                            // 恢复按钮状态
                            removeBtn.textContent = originalText;
                            removeBtn.disabled = false;
                        }
                    }
                }
            }
        }
        
        function getRatedPoisStats() {
            // 只统计当前用户的评分
            const myRatedPois = window.ratedPois.filter(poi => poi.user_id === currentUser?.id);
            
            const stats = {
                total: myRatedPois.length,
                cities: new Set(myRatedPois.map(p => p.city).filter(c => c)).size,
                rateCounts: {},
                cityCounts: {}
            };
            
            myRatedPois.forEach(poi => {
                // 统计评分分布
                stats.rateCounts[poi.rate] = (stats.rateCounts[poi.rate] || 0) + 1;
                
                // 统计城市分布
                if (poi.city) {
                    stats.cityCounts[poi.city] = (stats.cityCounts[poi.city] || 0) + 1;
                }
            });
            
            return stats;
        }
        
        // 保存筛选器状态
        let listFilterState = {
            '超爱': true,
            '喜欢': true,
            '一般': true,
            '不会再去了': true
        };
        
        // 保存用户筛选器状态 - 映射显示名称到用户ID
        let userFilterState = {
            self: currentUser ? currentUser.id : null
        };
        
        // 用户筛选器显示名称到用户ID的映射
        let userFilterMapping = {
            self: currentUser ? currentUser.id : null
        };
        
        // 保存筛选条展开状态
        let filterBarExpanded = false;
        
        // 初始化筛选状态 - 默认全选
        function initializeFilterState() {
            // 评分筛选状态 - 默认全选
            listFilterState = {
                '超爱': true,
                '喜欢': true,
                '一般': true,
                '不会再去了': true
            };
            
            // 用户筛选状态 - 默认只选自己
            userFilterState = {
                self: true
            };
            
            // 用户映射
            userFilterMapping = {
                self: currentUser ? currentUser.id : null
            };
            
            // 更新筛选状态
            updateFilterState();
        }
        
        // 筛选条相关函数
        window.toggleFilterBar = function() {
            filterBarExpanded = !filterBarExpanded;
            const filterBar = document.getElementById('filter-bar');
            if (filterBar) {
                if (filterBarExpanded) {
                    filterBar.classList.add('expanded');
                } else {
                    filterBar.classList.remove('expanded');
                }
            }
        };
        
        function getFilterSummary() {
            const checkedRates = Object.keys(listFilterState).filter(key => listFilterState[key]);
            const checkedUsers = Object.keys(userFilterState).filter(key => userFilterState[key]);
            return `${checkedRates.length}个评分类型, ${checkedUsers.length}个用户`;
        }
        
        // 评分筛选相关函数
        window.selectAllRateFilters = function() {
            RATE_TYPES.forEach(type => {
                listFilterState[type.value] = true;
            });
            updateFilterState();
            updateInfoPanel(null, 'list');
            updateMapMarkers();
        };
        
        window.clearAllRateFilters = function() {
            RATE_TYPES.forEach(type => {
                listFilterState[type.value] = false;
            });
            updateFilterState();
            updateInfoPanel(null, 'list');
            updateMapMarkers();
        };
        
        window.toggleRateFilter = function(value) {
            listFilterState[value] = !listFilterState[value];
            updateFilterState();
            updateInfoPanel(null, 'list');
            updateMapMarkers();
        };
        
        // 用户筛选相关函数
        window.selectAllUserFilters = function() {
            Object.keys(userFilterState).forEach(user => {
                userFilterState[user] = true;
            });
            updateFilterState();
            updateInfoPanel(null, 'list');
            updateMapMarkers();
        };
        
        window.clearAllUserFilters = function() {
            Object.keys(userFilterState).forEach(user => {
                userFilterState[user] = false;
            });
            updateFilterState();
            console.log('After clearing user filters:', {
                userFilterState,
                userFilterMapping,
                filterState: window.filterState
            });
            updateInfoPanel(null, 'list');
            updateMapMarkers();
        };
        
        window.toggleUserFilter = function(value) {
            // 如果用户未登录，显示登录提示
            if (!isLoggedIn || !currentUser) {
                showModal('login-modal');
                return;
            }
            
            // 确保映射存在
            if (!userFilterMapping[value]) {
                userFilterMapping[value] = currentUser.id;
            }
            
            userFilterState[value] = !userFilterState[value]; // 切换选中状态
            
            updateFilterState();
            updateInfoPanel(null, 'list');
            updateMapMarkers();
        };
        
        // 兼容旧函数名
        window.selectAllFilters = window.selectAllRateFilters;
        window.clearAllFilters = window.clearAllRateFilters;
        window.toggleFilter = window.toggleRateFilter;
        
        window.showRestaurantDetail = function(uid) {
            const poi = window.ratedPois.find(p => p.uid === uid);
            if (poi) {
                updateInfoPanel(poi, 'detail');
            }
        };
        
        window.clearAllRatedPois = async function() {
            // 检查用户是否已登录
            if (!isLoggedIn) {
                showModal('login-modal');
                return;
            }
            
            if (confirm('确定要清除所有评分吗？')) {
                try {
                    // 从Supabase删除所有评分
                    const { error } = await supabase
                        .from('restaurant_reviews')
                        .delete()
                        .eq('user_id', currentUser.id);
                    
                    if (error) {
                        console.error('清除所有评分错误:', error);
                        alert('清除评分失败，请重试');
                        return;
                    }
                    
                    // 更新本地数据
                    window.ratedPois = [];
                    updateFilterState();
                    updateMapMarkers();
                    updateInfoPanel(null, 'list');
                } catch (error) {
                    console.error('清除所有评分失败:', error);
                    alert('清除评分失败，请重试');
                }
            }
        };
        
        window.showSearchResultDetail = function(uid) {
            // 从当前搜索结果中查找对应的POI
            const poi = currentSearchResults.find(p => p.uid === uid);
            if (poi) {
                updateInfoPanel(poi, 'detail');
            }
        };
        
        window.goBackFromDetail = function() {
            // 根据之前的视图决定返回到哪里
            if (previousView === 'search' && currentSearchResults.length > 0) {
                updateInfoPanel(null, 'search', currentSearchResults);
            } else {
                updateInfoPanel(null, 'list');
            }
        };
        
        window.loadMoreSearchResults = function() {
            currentSearchPage++;
            localSearch.gotoPage(currentSearchPage);
        };
        
        window.goToMyRestaurants = function() {
            // 清空搜索相关状态
            currentSearchResults = [];
            currentSearchKeyword = '';
            currentSearchPage = 0;
            hasMoreSearchResults = false;
            // 清除地图上的搜索标记
            clearPoiMarkers();
            // 重置到显示所有评分餐厅的视图范围
            updateMapViewportForRatedPois();
            // 信息面板回到餐厅列表
            updateInfoPanel(null, 'list');
        };
        
        // ===================== 辅助功能 =====================
        // 在控制台查看评分数据
        window.showRatedPois = function() {
            console.log('当前评分POI列表:', window.ratedPois);
            console.log('localStorage中的评分数据:', localStorage.getItem('ratedPois'));
        };
        
        // 在控制台查看筛选器状态
        window.showFilterState = function() {
            console.log('评分筛选器状态:', listFilterState);
            console.log('用户筛选器状态:', userFilterState);
            console.log('用户筛选器映射:', userFilterMapping);
            console.log('当前用户:', currentUser);
            console.log('当前视图:', currentView);
            console.log('筛选后的餐厅数量:', getVisibleRatedPois().length);
            const myRatedPois = window.ratedPois.filter(poi => poi.user_id === currentUser?.id);
            console.log('我的餐厅数量:', myRatedPois.length);
            console.log('评分数据:', window.ratedPois);
        };
        

        
        // 清理localStorage
        window.clearLocalStorage = function() {
            if (confirm('确定要清理localStorage中的所有数据吗？')) {
                localStorage.clear();
                console.log('localStorage已清理');
            }
        };
        
        // ===================== 页面入口 =====================
        window.onload = async function() {
            // 加载用户会话
            loadUserSession();
            
            // 初始化筛选状态
            initializeFilterState();
            
            // 初始化好友API
            if (isLoggedIn && currentUser) {
                initFriendshipAPI();
            }
            
            // 初始化地图
            initMap();
            bindUIEvents();
            bindAuthEvents(); // 绑定认证相关事件
            bindFriendsEvents(); // 绑定好友管理事件
            
            // 如果用户已登录，加载评分数据
            if (isLoggedIn) {
                await loadRatedPois();
                updateFilterState();
                updateMapMarkers();
                updateMapViewportForRatedPois();
            }
            
            // 初始化信息面板，显示餐厅列表
            updateInfoPanel(null, 'list');
            
            // 确保信息面板默认展开显示
            document.getElementById('info-panel').classList.remove('collapsed');
            
            // 如果用户未登录，显示欢迎弹窗
            if (!isLoggedIn) {
                setTimeout(() => {
                    showWelcomeModal();
                }, 500);
            }
            
            // 在控制台显示辅助函数
            console.log('辅助函数已加载:');
            console.log('- showRatedPois(): 查看评分数据');
            console.log('- showFilterState(): 查看筛选器状态');
            console.log('- clearLocalStorage(): 清理localStorage');
            console.log('- 按 I 键或点击标题栏可切换信息面板显示状态');
        }
        
        // ===================== 个人信息管理功能 =====================
        
        // 显示个人信息模态框
        window.showProfileModal = function() {
            if (!isLoggedIn || !currentUser) {
                showModal('login-modal');
                return;
            }
            
            showModal('profile-modal');
            loadProfileInfo();
        };
        
        // 加载个人信息
        async function loadProfileInfo() {
            try {
                // 显示头像（昵称首字母）
                const avatarCircle = document.getElementById('profile-avatar-circle');
                const nickname = currentUser.nickname || '用户';
                avatarCircle.textContent = nickname.charAt(0).toUpperCase();
                
                // 显示基本信息
                document.getElementById('profile-nickname').textContent = currentUser.nickname || '未设置';
                document.getElementById('profile-unique-id').textContent = currentUser.unique_id || '未设置';
                
                // 格式化注册时间
                const createdAt = currentUser.created_at ? new Date(currentUser.created_at) : new Date();
                document.getElementById('profile-created-at').textContent = createdAt.toLocaleDateString('zh-CN');
                
                // 获取评分统计
                const myRatedPois = window.ratedPois.filter(poi => poi.user_id === currentUser?.id);
                const ratingCount = myRatedPois.length;
                document.getElementById('profile-rating-count').textContent = `${ratingCount} 个餐厅评分`;
                
            } catch (error) {
                console.error('加载个人信息失败:', error);
                alert('加载个人信息失败，请重试');
            }
        }
        
        // 复制唯一ID
        window.copyUniqueId = function() {
            const uniqueId = currentUser.unique_id;
            if (!uniqueId) {
                alert('唯一ID未设置');
                return;
            }
            
            // 复制到剪贴板
            navigator.clipboard.writeText(uniqueId).then(() => {
                const copyBtn = document.querySelector('.copy-btn');
                const originalText = copyBtn.textContent;
                copyBtn.textContent = '已复制';
                copyBtn.classList.add('copied');
                
                setTimeout(() => {
                    copyBtn.textContent = originalText;
                    copyBtn.classList.remove('copied');
                }, 2000);
            }).catch(() => {
                // 如果剪贴板API不可用，使用传统方法
                const textArea = document.createElement('textarea');
                textArea.value = uniqueId;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                
                const copyBtn = document.querySelector('.copy-btn');
                const originalText = copyBtn.textContent;
                copyBtn.textContent = '已复制';
                copyBtn.classList.add('copied');
                
                setTimeout(() => {
                    copyBtn.textContent = originalText;
                    copyBtn.classList.remove('copied');
                }, 2000);
            });
        };
        
        // 手动刷新好友列表
        window.refreshFriendsList = function() {
            console.log('手动刷新好友列表');
            loadFriendsList();
        };
        
        // 手动刷新好友请求
        window.refreshFriendRequests = function() {
            console.log('手动刷新好友请求');
            loadFriendRequests();
        };
        
        // ===================== 好友管理功能 =====================
        let friendshipAPI = null;
        
        // 初始化好友API
        function initFriendshipAPI() {
            if (isLoggedIn && currentUser) {
                friendshipAPI = new FriendshipAPI(supabase);
            }
        }
        
        // 显示好友管理模态框
        window.showFriendsModal = function() {
            if (!isLoggedIn || !currentUser) {
                showModal('login-modal');
                return;
            }
            
            if (!friendshipAPI) {
                initFriendshipAPI();
            }
            
            showModal('friends-modal');
            loadFriendsList();
            loadFriendRequests();
            
            // 启动自动刷新
            startAutoRefresh();
        };
        
        // 自动刷新相关变量
        let autoRefreshInterval = null;
        let lastFriendsCount = 0;
        let lastRequestsCount = 0;
        
        // 启动自动刷新
        function startAutoRefresh() {
            // 清除之前的定时器
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
            }
            
            // 每5秒检查一次更新
            autoRefreshInterval = setInterval(async () => {
                try {
                    // 检查好友列表是否有更新
                    const friends = await friendshipAPI.getFriendsList(currentUser.id);
                    const requests = await friendshipAPI.getReceivedRequests(currentUser.id);
                    
                    // 如果数量发生变化，自动刷新
                    if (friends.length !== lastFriendsCount) {
                        console.log('检测到好友列表更新，自动刷新');
                        loadFriendsList();
                        lastFriendsCount = friends.length;
                    }
                    
                    if (requests.length !== lastRequestsCount) {
                        console.log('检测到好友请求更新，自动刷新');
                        loadFriendRequests();
                        lastRequestsCount = requests.length;
                    }
                } catch (error) {
                    console.error('自动刷新检查失败:', error);
                }
            }, 5000); // 5秒检查一次
        }
        
        // 停止自动刷新
        function stopAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
            }
        }
        
        // 加载好友列表
        async function loadFriendsList() {
            const friendsList = document.getElementById('friends-list');
            friendsList.innerHTML = '<div class="loading">加载中...</div>';
            
            try {
                const friends = await friendshipAPI.getFriendsList(currentUser.id);
                lastFriendsCount = friends.length; // 更新计数
                
                if (friends.length === 0) {
                    friendsList.innerHTML = '<div class="empty-state">暂无好友</div>';
                    return;
                }
                
                friendsList.innerHTML = friends.map(friend => `
                    <div class="friend-item">
                        <div class="friend-avatar">${friend.friend_nickname ? friend.friend_nickname.charAt(0) : '?'}</div>
                        <div class="friend-info">
                            <div class="friend-name">${friend.friend_nickname || '未知用户'}</div>
                            <div class="friend-id">@${friend.friend_unique_id}</div>
                        </div>
                        <div class="friend-actions">
                            <button class="friend-action-btn remove" onclick="removeFriend('${friend.friend_id}')">删除</button>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('加载好友列表失败:', error);
                friendsList.innerHTML = '<div class="empty-state">加载失败，请重试</div>';
            }
        }
        
        // 加载好友请求
        async function loadFriendRequests() {
            const requestsList = document.getElementById('friend-requests-list');
            requestsList.innerHTML = '<div class="loading">加载中...</div>';
            
            try {
                const requests = await friendshipAPI.getReceivedRequests(currentUser.id);
                lastRequestsCount = requests.length; // 更新计数
                
                if (requests.length === 0) {
                    requestsList.innerHTML = '<div class="empty-state">暂无好友请求</div>';
                    return;
                }
                
                requestsList.innerHTML = requests.map(request => `
                    <div class="friend-item">
                        <div class="friend-avatar">${request.sender_nickname ? request.sender_nickname.charAt(0) : '?'}</div>
                        <div class="friend-info">
                            <div class="friend-name">${request.sender_nickname || '未知用户'}</div>
                            <div class="friend-id">@${request.sender_unique_id}</div>
                            <div class="friend-message">${request.message || '请求添加您为好友'}</div>
                        </div>
                        <div class="friend-actions">
                            <button class="friend-action-btn accept" onclick="acceptFriendRequest('${request.request_id}')">接受</button>
                            <button class="friend-action-btn reject" onclick="rejectFriendRequest('${request.request_id}')">拒绝</button>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('加载好友请求失败:', error);
                requestsList.innerHTML = '<div class="empty-state">加载失败，请重试</div>';
            }
        }
        
        // 删除好友
        window.removeFriend = async function(friendId) {
            if (!confirm('确定要删除这个好友吗？')) {
                return;
            }
            
            try {
                console.log('删除好友:', currentUser.id, '->', friendId);
                await friendshipAPI.removeFriend(currentUser.id, friendId);
                alert('好友删除成功');
                loadFriendsList();
            } catch (error) {
                console.error('删除好友失败:', error);
                alert('删除好友失败，请重试');
            }
        };
        
        // 接受好友请求
        window.acceptFriendRequest = async function(requestId) {
            try {
                console.log('接受好友请求:', requestId, '接收者:', currentUser.id);
                const result = await friendshipAPI.acceptFriendRequest(requestId, currentUser.id);
                alert('好友请求已接受');
                loadFriendRequests();
                loadFriendsList();
                
                // 显示成功消息，提示用户刷新
                const successDiv = document.createElement('div');
                successDiv.style.cssText = 'background: #d4edda; color: #155724; padding: 12px; border-radius: 6px; margin-bottom: 16px; text-align: center;';
                successDiv.innerHTML = '好友请求已接受！新好友已添加到您的好友列表中。';
                document.getElementById('friends-list-tab').insertBefore(successDiv, document.getElementById('friends-list'));
                setTimeout(() => successDiv.remove(), 3000);
                
            } catch (error) {
                console.error('接受好友请求失败:', error);
                alert('接受好友请求失败，请重试');
            }
        };
        
        // 拒绝好友请求
        window.rejectFriendRequest = async function(requestId) {
            try {
                console.log('拒绝好友请求:', requestId, '接收者:', currentUser.id);
                await friendshipAPI.rejectFriendRequest(requestId, currentUser.id);
                alert('好友请求已拒绝');
                loadFriendRequests();
            } catch (error) {
                console.error('拒绝好友请求失败:', error);
                alert('拒绝好友请求失败，请重试');
            }
        };
        
        // 搜索用户
        window.searchUser = async function() {
            const userId = document.getElementById('search-user-id').value.trim();
            const searchResult = document.getElementById('search-result');
            
            if (!userId) {
                alert('请输入用户唯一ID');
                return;
            }
            
            searchResult.innerHTML = '<div class="loading">搜索中...</div>';
            
            try {
                console.log('搜索用户:', userId, '当前用户ID:', currentUser.id);
                const user = await friendshipAPI.getUserByUniqueId(userId, currentUser.id);
                console.log('搜索结果:', user);
                
                if (!user) {
                    searchResult.innerHTML = '<div class="empty-state">未找到该用户</div>';
                    return;
                }
                
                // 检查是否已经是好友
                console.log('检查好友关系:', currentUser.id, user.id);
                const isFriend = await friendshipAPI.checkFriendship(currentUser.id, user.id);
                console.log('是否已是好友:', isFriend);
                
                searchResult.innerHTML = `
                    <div class="friend-item">
                        <div class="friend-avatar">${user.nickname ? user.nickname.charAt(0) : '?'}</div>
                        <div class="friend-info">
                            <div class="friend-name">${user.nickname || '未知用户'}</div>
                            <div class="friend-id">@${user.unique_id}</div>
                        </div>
                        <div class="friend-actions">
                            ${isFriend ? 
                                '<span style="color: #52c41a;">已是好友</span>' : 
                                '<button class="friend-action-btn send" onclick="sendFriendRequest(\'' + user.id + '\')">发送请求</button>'
                            }
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error('搜索用户失败:', error);
                searchResult.innerHTML = '<div class="empty-state">搜索失败，请重试</div>';
            }
        };
        
        // 发送好友请求
        window.sendFriendRequest = async function(userId) {
            try {
                console.log('发送好友请求:', currentUser.id, '->', userId);
                await friendshipAPI.sendFriendRequest(currentUser.id, userId, '你好，我想加你为好友');
                alert('好友请求已发送');
                document.getElementById('search-result').innerHTML = '<div class="empty-state">请求已发送，等待对方回复</div>';
            } catch (error) {
                console.error('发送好友请求失败:', error);
                alert('发送好友请求失败，请重试');
            }
        };
        
        // 绑定好友管理事件
        function bindFriendsEvents() {
            // 好友模态框关闭按钮
            document.getElementById('friends-modal-close').addEventListener('click', () => {
                hideModal('friends-modal');
                stopAutoRefresh(); // 停止自动刷新
            });
            
            // 个人信息模态框关闭按钮
            document.getElementById('profile-modal-close').addEventListener('click', () => {
                hideModal('profile-modal');
            });
            
            // 标签页切换
            document.querySelectorAll('.friends-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    // 移除所有活动状态
                    document.querySelectorAll('.friends-tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.friends-tab-content').forEach(c => c.classList.remove('active'));
                    
                    // 添加当前活动状态
                    tab.classList.add('active');
                    const tabId = tab.getAttribute('data-tab') + '-tab';
                    document.getElementById(tabId).classList.add('active');
                });
            });
            
            // 搜索用户按钮
            document.getElementById('search-user-btn').addEventListener('click', searchUser);
            
            // 搜索框回车事件
            document.getElementById('search-user-id').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    searchUser();
                }
            });
        }
    </script>
</body>
</html> 