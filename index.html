<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>æˆ‘çš„é¤å…åœ°å›¾</title>
    <style>
        html, body { height: 100%; margin: 0; padding: 0; }
        #map { width: 100vw; height: 100vh; }
        .search-bar {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            background: #fff;
            padding: 10px 20px;
            border-radius: 8px;
            box-shadow: 0 2px 6px 0 rgba(27, 142, 236, 0.2);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .search-bar input {
            font-size: 16px;
            padding: 6px 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            outline: none;
        }
        .search-bar button {
            font-size: 16px;
            padding: 6px 16px;
            background: #1b8eec;
            color: #fff;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .search-bar button:hover {
            background: #156bbd;
        }
        
        .info-panel {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 320px;
            max-height: calc(100vh - 40px);
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
        }
        
        .info-panel.collapsed {
            transform: translateX(calc(100% - 40px));
        }
        
        .info-panel.collapsed .info-panel-content {
            opacity: 0;
            pointer-events: none;
        }
        
        .info-panel.collapsed .info-panel-header {
            border-radius: 8px 0 0 8px;
        }
        
        .info-panel-header {
            background: #1b8eec;
            color: #fff;
            padding: 12px 16px;
            font-size: 16px;
            font-weight: bold;
            border-radius: 8px 8px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }
        
        .info-panel-header:hover {
            background: #156bbd;
        }
        
        .info-panel-toggle-btn {
            background: none;
            border: none;
            color: #fff;
            font-size: 16px;
            cursor: pointer;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.3s ease;
        }
        
        .info-panel.collapsed .info-panel-toggle-btn {
            transform: rotate(180deg);
        }
        
        .info-panel-handle {
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 40px;
            height: 60px;
            background: #1b8eec;
            border-radius: 8px 0 0 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-size: 16px;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .info-panel.collapsed .info-panel-handle {
            opacity: 1;
        }
        
        .info-panel-handle:hover {
            background: #156bbd;
        }
        
        .info-panel-content {
            padding: 16px;
            overflow-y: auto;
            flex: 1;
        }
        
        .info-panel-section {
            margin-bottom: 16px;
        }
        
        .info-panel-section h3 {
            margin: 0 0 8px 0;
            font-size: 14px;
            color: #333;
            font-weight: bold;
        }
        
        .info-panel-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .info-panel-item:last-child {
            border-bottom: none;
        }
        
        .info-panel-label {
            color: #666;
            font-size: 13px;
        }
        
        .info-panel-value {
            color: #333;
            font-size: 13px;
            font-weight: 500;
            text-align: right;
            max-width: 60%;
        }
        
        .info-panel-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            margin-top: 4px;
        }
        
        .info-panel-tag {
            background: #f7c948;
            color: #333;
            border-radius: 12px;
            padding: 2px 8px;
            font-size: 11px;
        }
        
        .info-panel-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }
        
        .info-panel-stat {
            background: #f8f9fa;
            padding: 8px;
            border-radius: 4px;
            text-align: center;
        }
        
        .info-panel-stat-value {
            font-size: 18px;
            font-weight: bold;
            color: #1b8eec;
        }
        
        .info-panel-stat-label {
            font-size: 11px;
            color: #666;
            margin-top: 2px;
        }
        
        .info-panel-btn {
            background: #1b8eec;
            color: #fff;
            border: none;
            border-radius: 4px;
            padding: 6px 12px;
            font-size: 12px;
            cursor: pointer;
            display: inline-block;
            text-align: center;
            min-width: 60px;
            transition: background-color 0.2s ease;
        }
        
        .info-panel-btn:hover {
            background: #156bbd;
        }
        
        .info-panel-btn.rate-btn:hover {
            opacity: 0.8;
        }
        
        .filter-checkbox-container {
            display: inline-block;
            margin-right: 8px;
            margin-bottom: 4px;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            transition: background-color 0.2s ease;
        }
        
        .filter-checkbox-container:hover {
            background: #f0f0f0;
        }
        
        .filter-checkbox-container input[type="checkbox"] {
            margin-right: 4px;
            cursor: pointer;
        }
        
        .filter-checkbox-container span {
            font-size: 12px;
            cursor: pointer;
            user-select: none;
        }
        
        .restaurant-list {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .restaurant-item {
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            user-select: none;
        }
        
        .restaurant-item:hover {
            border-color: #1b8eec;
            background: #f8f9fa;
        }
        
        .restaurant-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }
        
        .restaurant-name {
            font-weight: bold;
            font-size: 13px;
            color: #333;
        }
        
        .restaurant-rate {
            font-size: 11px;
            font-weight: bold;
        }
        
        .restaurant-location {
            font-size: 11px;
            color: #666;
            margin-bottom: 2px;
        }
        
        .restaurant-address {
            font-size: 11px;
            color: #999;
            line-height: 1.3;
        }
    </style>
</head>
<body>
    <div class="search-bar">
        <input type="text" id="keyword" placeholder="è¯·è¾“å…¥POIå…³é”®å­—ï¼Œå¦‚é¤å…ã€æ™¯ç‚¹..." />
        <button id="search-btn">æœç´¢</button>
    </div>
    <div id="map"></div>
    
    <!-- ä¿¡æ¯é¢æ¿ -->
    <div class="info-panel" id="info-panel">
        <div class="info-panel-handle" id="info-panel-handle">â—€</div>
        <div class="info-panel-header" id="info-panel-header">
            <span>ä¿¡æ¯é¢æ¿</span>
            <button class="info-panel-toggle-btn" id="info-panel-toggle-btn">â—€</button>
        </div>
        <div class="info-panel-content" id="info-panel-content">
            <!-- å†…å®¹å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
        </div>
    </div>
    <!-- ç™¾åº¦åœ°å›¾API -->
    <script src="https://api.map.baidu.com/api?v=1.0&type=webgl&ak=37RkgO1xJD842QrZ0AnUGHpCOYSGg3kh"></script>
    <script>
        // ===================== å¸¸é‡é…ç½® =====================
        const RATE_TYPES = [
            { value: "è¶…çˆ±", drop: "#FF4500", star: "white" },
            { value: "å–œæ¬¢", drop: "#FFA500", star: "white" },
            { value: "ä¸€èˆ¬", drop: "#808080", star: "white" },
            { value: "ä¸ä¼šå†å»äº†", drop: "#556B2F", star: "black" }
        ];

        // ===================== æ•°æ®ç®¡ç† =====================
        let map;
        let localSearch;
        window.ratedPois = [];
        window.ratedMarkers = {};
        window._poiMarkers = [];

        function loadRatedPois() {
            const ratedStr = localStorage.getItem('ratedPois');
            if (ratedStr) {
                try {
                    window.ratedPois = JSON.parse(ratedStr);
                } catch(e) {
                    window.ratedPois = [];
                }
            } else {
                window.ratedPois = [];
            }
        }
        function saveRatedPois() {
            localStorage.setItem('ratedPois', JSON.stringify(window.ratedPois));
        }
        function addOrUpdateRatedPoi(poi, rate) {
            const idx = window.ratedPois.findIndex(f => f.uid === poi.uid);
            
            // ä½¿ç”¨å­—æ®µå…¼å®¹æ€§å¤„ç†è·å–POIä¿¡æ¯
            const title = getPoiField(poi, ['title', 'name']);
            const shortTitle = getShortTitle(title);
            const address = getPoiField(poi, ['address', 'addr']);
            const city = getPoiField(poi, ['city', 'cityname']);
            const area = getPoiField(poi, ['area', 'areaname', 'district']);
            const tags = getPoiField(poi, ['tags', 'std_tag', 'tag']) || [];
            const phoneNumber = getPoiField(poi, ['phoneNumber', 'phone', 'tel']);
            
            if (idx === -1) {
                window.ratedPois.push({
                    uid: poi.uid,
                    title: title,
                    shortTitle: shortTitle,
                    address: address,
                    point: poi.point ? {lng: poi.point.lng, lat: poi.point.lat} : undefined,
                    province: getPoiField(poi, ['province', 'provincename']),
                    city: city,
                    area: area,
                    tags: tags,
                    type: getPoiField(poi, ['type', 'poiType']),
                    phoneNumber: phoneNumber,
                    detailUrl: getPoiField(poi, ['detailUrl', 'url']),
                    business: getPoiField(poi, ['business', 'businessArea']),
                    provinceCode: getPoiField(poi, ['provinceCode', 'province_code']),
                    cityCode: getPoiField(poi, ['cityCode', 'city_code']),
                    adCode: getPoiField(poi, ['adCode', 'ad_code']),
                    parentPoi: getPoiField(poi, ['parentPoi', 'parent_poi']),
                    rate: rate
                });
            } else {
                window.ratedPois[idx].rate = rate;
                window.ratedPois[idx].shortTitle = shortTitle;
                // æ›´æ–°å…¶ä»–å¯èƒ½å˜åŒ–çš„å­—æ®µ
                window.ratedPois[idx].title = title;
                window.ratedPois[idx].address = address;
                window.ratedPois[idx].city = city;
                window.ratedPois[idx].area = area;
                window.ratedPois[idx].tags = tags;
                window.ratedPois[idx].phoneNumber = phoneNumber;
            }
            saveRatedPois();
            renderRatedMarkers();
            // å¦‚æœå½“å‰åœ¨åˆ—è¡¨è§†å›¾ï¼Œæ›´æ–°é¢æ¿
            if (currentView === 'list') {
                updateInfoPanel(null, 'list');
            }
        }
        function removeRatedPoi(uid) {
            window.ratedPois = window.ratedPois.filter(f => f.uid !== uid);
            saveRatedPois();
            renderRatedMarkers();
            // å¦‚æœå½“å‰åœ¨åˆ—è¡¨è§†å›¾ï¼Œæ›´æ–°é¢æ¿
            if (currentView === 'list') {
                updateInfoPanel(null, 'list');
            }
        }

        // ===================== è§†å›¾æ¸²æŸ“ =====================
        function getRatedSvg(rate) {
            const type = RATE_TYPES.find(t => t.value === rate) || RATE_TYPES[1];
            return `<svg width="32" height="40" viewBox="0 0 32 40" xmlns="http://www.w3.org/2000/svg">
                <path d="M16 40C16 40 32 24.5685 32 16C32 7.16344 24.8366 0 16 0C7.16344 0 0 7.16344 0 16C0 24.5685 16 40 16 40Z" fill="${type.drop}"/>
                <path d="M16 8L18.47 13.53L24 14.18L20 18.24L21.24 24L16 21.24L10.76 24L12 18.24L8 14.18L13.53 13.53L16 8Z" fill="${type.star}"/>
            </svg>`;
        }
        function renderRatedMarkers() {
            if(window.ratedMarkers) Object.values(window.ratedMarkers).forEach(marker => map.removeOverlay(marker));
            window.ratedMarkers = {};
            const checkedRates = getCheckedRates();
            window.ratedPois.forEach(poi => {
                if (!poi.point || typeof poi.point.lng !== 'number' || typeof poi.point.lat !== 'number') return;
                if (!checkedRates.includes(poi.rate)) return;
                const pt = new BMapGL.Point(poi.point.lng, poi.point.lat);
                const svg = getRatedSvg(poi.rate);
                const svgUrl = 'data:image/svg+xml;base64,' + btoa(svg);
                const icon = new BMapGL.Icon(svgUrl, new BMapGL.Size(32, 40), { anchor: new BMapGL.Size(16, 40) });
                const marker = new BMapGL.Marker(pt, {icon: icon});
                const label = new BMapGL.Label(poi.shortTitle || poi.title, { offset: new BMapGL.Size(20, -10) });
                label.setStyle({
                    color: '#333', fontSize: '14px', background: 'rgba(255,255,255,0.85)',
                    border: 'none', padding: '2px 8px', borderRadius: '4px', fontWeight: 'bold', zIndex: 999
                });
                marker.setLabel(label);
                map.addOverlay(marker);
                window.ratedMarkers[poi.uid] = marker;
                marker.addEventListener('click', function() {
                    showPoiInfoWindow(poi, marker);
                });
            });
        }
        function clearPoiMarkers() {
            if (window._poiMarkers) {
                window._poiMarkers.forEach(m => map.removeOverlay(m));
            }
            window._poiMarkers = [];
        }
        function getCheckedRates() {
            // ä½¿ç”¨ä¿¡æ¯é¢æ¿çš„ç­›é€‰çŠ¶æ€ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨ä¿å­˜çš„çŠ¶æ€
            const infoPanelFilters = document.querySelectorAll('.list-filter:checked');
            if (infoPanelFilters.length > 0) {
                return Array.from(infoPanelFilters).map(cb => cb.value);
            }
            // å¦‚æœæ²¡æœ‰æ‰¾åˆ°ä¿¡æ¯é¢æ¿çš„ç­›é€‰å™¨ï¼Œä½¿ç”¨ä¿å­˜çš„çŠ¶æ€
            return Object.keys(listFilterState).filter(key => listFilterState[key]);
        }
        function updateMapViewportForRatedPois() {
            if (window.ratedPois && window.ratedPois.length > 0) {
                const points = window.ratedPois
                    .filter(poi => poi.point && typeof poi.point.lng === 'number' && typeof poi.point.lat === 'number')
                    .map(poi => new BMapGL.Point(poi.point.lng, poi.point.lat));
                if (points.length > 0) {
                    // æ‰‹åŠ¨æ‰©å¤§è¾¹ç•Œï¼Œé¿å…è´´è¾¹
                    let minLng = Math.min(...points.map(p => p.lng));
                    let maxLng = Math.max(...points.map(p => p.lng));
                    let minLat = Math.min(...points.map(p => p.lat));
                    let maxLat = Math.max(...points.map(p => p.lat));
                    const padding = 0.01;
                    minLng -= padding; maxLng += padding; minLat -= padding; maxLat += padding;
                    map.setViewport([
                        new BMapGL.Point(minLng, minLat),
                        new BMapGL.Point(maxLng, maxLat)
                    ]);
                }
            }
        }

        // ===================== ä¿¡æ¯çª—å£ =====================
        function getPoiField(poi, fieldNames) {
            // æ”¯æŒå¤šç§å¯èƒ½çš„å­—æ®µåï¼ŒæŒ‰ä¼˜å…ˆçº§è¿”å›ç¬¬ä¸€ä¸ªå­˜åœ¨çš„å€¼
            for (let fieldName of fieldNames) {
                if (poi[fieldName] !== undefined && poi[fieldName] !== null && poi[fieldName] !== '') {
                    return poi[fieldName];
                }
            }
            return '';
        }

        function getShortTitle(title) {
            if (!title) return '';
            const idx = title.indexOf('(');
            return idx > 0 ? title.slice(0, idx).trim() : title;
        }

        function showPoiInfoWindow(poi, marker) {
            // è·³è½¬åˆ°é¤å…è¯¦æƒ…é¡µé¢
            updateInfoPanel(poi, 'detail');
        }

        // ===================== åœ°å›¾ä¸æœç´¢ =====================
        function initMap() {
            map = new BMapGL.Map("map", {enableIconClick: true});
            map.centerAndZoom(new BMapGL.Point(116.404, 39.915), 12);
            map.enableScrollWheelZoom(true);
            map.setMapStyleV2({ styleId: '75a3e83ace0ff353fbf5a085935333e7' });
            initLocalSearch();
        }
        function initLocalSearch() {
            localSearch = new BMapGL.LocalSearch(map, {
                renderOptions: { map: null, autoViewport: false }
            });
            localSearch.setSearchCompleteCallback(handleSearchResults);
        }
        function handleSearchResults(results) {
            clearPoiMarkers();
            const points = [];
            for (let i = 0; i < results.getCurrentNumPois(); i++) {
                const poi = results.getPoi(i);
                if (poi && poi.point) {
                    const marker = createPoiMarker(poi);
                    map.addOverlay(marker);
                    window._poiMarkers.push(marker);
                    points.push(poi.point);
                }
            }
            if (points.length > 0) {
                map.setViewport(points);
            }
            renderRatedMarkers();
        }
        function createPoiMarker(poi) {
            const marker = new BMapGL.Marker(poi.point);
            marker.addEventListener('click', function() {
                showPoiInfoWindow(poi, marker);
            });
            return marker;
        }

        // ===================== äº‹ä»¶ç»‘å®š =====================
        function bindUIEvents() {
            document.getElementById('search-btn').onclick = function() {
                const keyword = document.getElementById('keyword').value.trim();
                if (!keyword) {
                    alert('è¯·è¾“å…¥æœç´¢å…³é”®å­—');
                    return;
                }
                localSearch.search(keyword);
            };
            document.getElementById('keyword').addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    document.getElementById('search-btn').click();
                }
            });

            
            // ä¿¡æ¯é¢æ¿æ”¶ç¼©/å±•å¼€äº‹ä»¶ç»‘å®š
            function toggleInfoPanel() {
                const panel = document.getElementById('info-panel');
                const isCollapsed = panel.classList.contains('collapsed');
                
                if (isCollapsed) {
                    panel.classList.remove('collapsed');
                } else {
                    panel.classList.add('collapsed');
                }
            }
            
            // ç‚¹å‡»æ ‡é¢˜æ æˆ–åˆ‡æ¢æŒ‰é’®æ”¶ç¼©/å±•å¼€é¢æ¿
            document.getElementById('info-panel-header').onclick = toggleInfoPanel;
            document.getElementById('info-panel-toggle-btn').onclick = function(e) {
                e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡
                toggleInfoPanel();
            };
            
            // ç‚¹å‡»ä¾§è¾¹æŠŠæ‰‹å±•å¼€é¢æ¿
            document.getElementById('info-panel-handle').onclick = function() {
                document.getElementById('info-panel').classList.remove('collapsed');
            };
            
            // é”®ç›˜å¿«æ·é”®ï¼šæŒ‰ 'I' é”®åˆ‡æ¢ä¿¡æ¯é¢æ¿
            document.addEventListener('keydown', function(e) {
                if (e.key.toLowerCase() === 'i' && !e.ctrlKey && !e.altKey && !e.metaKey) {
                    e.preventDefault();
                    toggleInfoPanel();
                }
            });
            
            // ç‚¹å‡»åœ°å›¾ç©ºç™½å¤„æ—¶æ˜¾ç¤ºé¤å…åˆ—è¡¨
            map.addEventListener('click', function(e) {
                // æ£€æŸ¥æ˜¯å¦ç‚¹å‡»çš„æ˜¯åœ°å›¾æœ¬èº«è€Œä¸æ˜¯marker
                if (e.target === map || e.target === map.getContainer()) {
                    currentPoi = null;
                    updateInfoPanel(null, 'list');
                }
            });
        }

        // ===================== ä¿¡æ¯é¢æ¿åŠŸèƒ½ =====================
        let currentPoi = null;
        let currentView = 'list'; // 'list', 'detail', 'stats'
        
        function updateInfoPanel(poi = null, view = 'list') {
            const panelContent = document.getElementById('info-panel-content');
            
            if (view === 'stats') {
                // æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯
                currentView = 'stats';
                const stats = getRatedPoisStats();
                panelContent.innerHTML = `
                    <div class="info-panel-section">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <h3>ğŸ“Š è¯„åˆ†ç»Ÿè®¡</h3>
                            <button class="info-panel-btn" onclick="updateInfoPanel(null, 'list')">é¤å…åˆ—è¡¨</button>
                        </div>
                        <div class="info-panel-stats">
                            <div class="info-panel-stat">
                                <div class="info-panel-stat-value">${stats.total}</div>
                                <div class="info-panel-stat-label">æ€»è¯„åˆ†</div>
                            </div>
                            <div class="info-panel-stat">
                                <div class="info-panel-stat-value">${stats.cities}</div>
                                <div class="info-panel-stat-label">æ¶‰åŠåŸå¸‚</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="info-panel-section">
                        <h3>â­ è¯„åˆ†åˆ†å¸ƒ</h3>
                        ${RATE_TYPES.map(type => {
                            const count = stats.rateCounts[type.value] || 0;
                            return `
                                <div class="info-panel-item">
                                    <span class="info-panel-label">${type.value}</span>
                                    <span class="info-panel-value">${count}ä¸ª</span>
                                </div>
                            `;
                        }).join('')}
                    </div>
                    
                    <div class="info-panel-section">
                        <h3>ğŸ™ï¸ åŸå¸‚åˆ†å¸ƒ</h3>
                        ${Object.entries(stats.cityCounts).map(([city, count]) => `
                            <div class="info-panel-item">
                                <span class="info-panel-label">${city}</span>
                                <span class="info-panel-value">${count}ä¸ª</span>
                            </div>
                        `).join('')}
                    </div>
                `;
            } else if (view === 'list') {
                // æ˜¾ç¤ºé¤å…åˆ—è¡¨
                currentView = 'list';
                const filteredPois = getFilteredRatedPois();
                
                panelContent.innerHTML = `
                    <div class="info-panel-section">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <h3>ğŸ½ï¸ æˆ‘çš„é¤å…</h3>
                            <button class="info-panel-btn" onclick="updateInfoPanel(null, 'stats')">ç»Ÿè®¡</button>
                        </div>
                        
                        <div class="info-panel-section">
                            <h4>ç­›é€‰æ¡ä»¶</h4>
                            <div style="margin-bottom: 12px;">
                                ${RATE_TYPES.map(type => `
                                    <div class="filter-checkbox-container" onclick="toggleFilter('${type.value}')">
                                        <input type="checkbox" class="list-filter" value="${type.value}" ${listFilterState[type.value] ? 'checked' : ''} onclick="event.stopPropagation(); toggleFilter('${type.value}');">
                                        <span>${type.value}</span>
                                    </div>
                                `).join('')}
                            </div>
                            <div style="margin-bottom: 12px;">
                                <button class="info-panel-btn" onclick="selectAllFilters()">å…¨é€‰</button>
                                <button class="info-panel-btn" onclick="clearAllFilters()" style="margin-left: 8px;">å…¨ä¸é€‰</button>
                            </div>
                        </div>
                        
                        <div class="info-panel-section">
                            <h4>é¤å…åˆ—è¡¨ (${filteredPois.length}ä¸ª)</h4>
                            <div class="restaurant-list">
                                ${filteredPois.length > 0 ? filteredPois.map(poi => {
                                    const rateType = RATE_TYPES.find(t => t.value === poi.rate);
                                    return `
                                        <div class="restaurant-item" onclick="showRestaurantDetail('${poi.uid}')">
                                            <div class="restaurant-header">
                                                <span class="restaurant-name">${poi.shortTitle || poi.title}</span>
                                                <span class="restaurant-rate" style="color: ${rateType?.drop || '#666'}">${poi.rate}</span>
                                            </div>
                                            <div class="restaurant-location">${poi.city || ''}${poi.area ? ' Â· ' + poi.area : ''}</div>
                                            <div class="restaurant-address">${poi.address || ''}</div>
                                        </div>
                                    `;
                                }).join('') : '<div style="text-align: center; color: #999; padding: 20px;">æš‚æ— è¯„åˆ†é¤å…</div>'}
                            </div>
                            ${filteredPois.length > 0 ? `
                            <div style="margin-top: 12px; text-align: center;">
                                <button class="info-panel-btn" onclick="clearAllRatedPois()" style="background: #ff4d4f; color: #fff;">æ¸…é™¤æ‰€æœ‰è¯„åˆ†</button>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                `;
                

                
            } else if (poi) {
                // æ˜¾ç¤ºPOIè¯¦ç»†ä¿¡æ¯
                currentView = 'detail';
                currentPoi = poi;
                const title = getPoiField(poi, ['title', 'name']);
                const shortTitle = getShortTitle(title);
                const city = getPoiField(poi, ['city', 'cityname']);
                const area = getPoiField(poi, ['area', 'areaname', 'district']);
                const address = getPoiField(poi, ['address', 'addr']);
                const phoneNumber = getPoiField(poi, ['phoneNumber', 'phone', 'tel']);
                const tags = getPoiField(poi, ['tags', 'std_tag', 'tag']) || [];
                const tagArray = Array.isArray(tags) ? tags : (typeof tags === 'string' ? tags.split(',').map(t => t.trim()) : []);
                
                // æ£€æŸ¥æ˜¯å¦å·²è¯„åˆ†
                const ratedPoi = window.ratedPois.find(rp => rp.uid === poi.uid);
                
                panelContent.innerHTML = `
                    <div class="info-panel-section">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <h3>ğŸ“ é¤å…è¯¦æƒ…</h3>
                            <button class="info-panel-btn" onclick="updateInfoPanel(null, 'list')">è¿”å›åˆ—è¡¨</button>
                        </div>
                        
                        <div class="info-panel-item">
                            <span class="info-panel-label">åç§°</span>
                            <span class="info-panel-value">${shortTitle || title || ''}</span>
                        </div>
                        <div class="info-panel-item">
                            <span class="info-panel-label">ä½ç½®</span>
                            <span class="info-panel-value">${city || ''}${area ? ' Â· ' + area : ''}</span>
                        </div>
                        <div class="info-panel-item">
                            <span class="info-panel-label">åœ°å€</span>
                            <span class="info-panel-value">${address || ''}</span>
                        </div>
                        ${phoneNumber ? `
                        <div class="info-panel-item">
                            <span class="info-panel-label">ç”µè¯</span>
                            <span class="info-panel-value">${phoneNumber}</span>
                        </div>
                        ` : ''}
                        ${tagArray.length > 0 ? `
                        <div class="info-panel-item">
                            <span class="info-panel-label">æ ‡ç­¾</span>
                            <div class="info-panel-tags">
                                ${tagArray.map(tag => `<span class="info-panel-tag">${tag}</span>`).join('')}
                            </div>
                        </div>
                        ` : ''}
                    </div>
                    
                    <div class="info-panel-section">
                        <h3>â­ è¯„åˆ†æ“ä½œ</h3>
                        ${ratedPoi ? `
                            <div class="info-panel-item">
                                <span class="info-panel-label">å½“å‰è¯„åˆ†</span>
                                <span class="info-panel-value" style="color: ${RATE_TYPES.find(t => t.value === ratedPoi.rate)?.drop || '#666'}">${ratedPoi.rate}</span>
                            </div>
                        ` : `
                            <div class="info-panel-item">
                                <span class="info-panel-label">å½“å‰è¯„åˆ†</span>
                                <span class="info-panel-value" style="color: #999;">æœªè¯„åˆ†</span>
                            </div>
                        `}
                        <div style="margin-top: 12px;">
                            ${RATE_TYPES.map(t => `
                                <button class="info-panel-btn rate-btn" data-rate="${t.value}" style="background:${t.drop};color:${t.star === 'black' ? '#000' : '#fff'};margin-right:8px;margin-bottom:8px;">${t.value}</button>
                            `).join('')}
                            ${ratedPoi ? `
                                <button class="info-panel-btn" id="remove-rate-btn" style="background:#bbb;color:#fff;margin-bottom:8px;">å–æ¶ˆè¯„ä»·</button>
                            ` : ''}
                        </div>
                    </div>
                    
                    <div class="info-panel-section">
                        <h3>ğŸ“ åæ ‡ä¿¡æ¯</h3>
                        <div class="info-panel-item">
                            <span class="info-panel-label">ç»åº¦</span>
                            <span class="info-panel-value">${poi.point ? poi.point.lng.toFixed(6) : ''}</span>
                        </div>
                        <div class="info-panel-item">
                            <span class="info-panel-label">çº¬åº¦</span>
                            <span class="info-panel-value">${poi.point ? poi.point.lat.toFixed(6) : ''}</span>
                        </div>
                    </div>
                `;
                
                // ç®€åŒ–ï¼šç›´æ¥ç»‘å®šè¯„åˆ†æŒ‰é’®äº‹ä»¶ï¼Œä¸ä½¿ç”¨å»¶è¿Ÿ
                const rateBtns = panelContent.querySelectorAll('.rate-btn');
                const removeBtn = panelContent.querySelector('#remove-rate-btn');
                
                rateBtns.forEach(btn => {
                    btn.onclick = function() {
                        const rate = btn.getAttribute('data-rate');
                        addOrUpdateRatedPoi(poi, rate);
                        updateInfoPanel(poi, 'detail'); // åˆ·æ–°é¢æ¿
                    }
                });
                
                if (removeBtn) {
                    removeBtn.onclick = function() {
                        removeRatedPoi(poi.uid);
                        updateInfoPanel(poi, 'detail'); // åˆ·æ–°é¢æ¿
                    }
                }
            }
        }
        
        function getRatedPoisStats() {
            const stats = {
                total: window.ratedPois.length,
                cities: new Set(window.ratedPois.map(p => p.city).filter(c => c)).size,
                rateCounts: {},
                cityCounts: {}
            };
            
            window.ratedPois.forEach(poi => {
                // ç»Ÿè®¡è¯„åˆ†åˆ†å¸ƒ
                stats.rateCounts[poi.rate] = (stats.rateCounts[poi.rate] || 0) + 1;
                
                // ç»Ÿè®¡åŸå¸‚åˆ†å¸ƒ
                if (poi.city) {
                    stats.cityCounts[poi.city] = (stats.cityCounts[poi.city] || 0) + 1;
                }
            });
            
            return stats;
        }
        
        // ä¿å­˜ç­›é€‰å™¨çŠ¶æ€
        let listFilterState = {
            'è¶…çˆ±': true,
            'å–œæ¬¢': true,
            'ä¸€èˆ¬': true,
            'ä¸ä¼šå†å»äº†': true
        };
        
        function getFilteredRatedPois() {
            // ä½¿ç”¨ä¿å­˜çš„çŠ¶æ€è¿›è¡Œç­›é€‰ï¼Œä¸å†ä»DOMè¯»å–
            const checkedRates = Object.keys(listFilterState).filter(key => listFilterState[key]);
            const filteredPois = window.ratedPois.filter(poi => checkedRates.includes(poi.rate));
            
            // æŒ‰ç…§RATE_TYPESçš„é¡ºåºè¿›è¡Œæ’åºï¼Œç¡®ä¿ä¸ç­›é€‰å™¨é¡ºåºä¸€è‡´
            const sortedPois = filteredPois.sort((a, b) => {
                const indexA = RATE_TYPES.findIndex(t => t.value === a.rate);
                const indexB = RATE_TYPES.findIndex(t => t.value === b.rate);
                return indexA - indexB;
            });
            

            
            return sortedPois;
        }
        
        // å°†å‡½æ•°æ·»åŠ åˆ°å…¨å±€ä½œç”¨åŸŸï¼Œä»¥ä¾¿HTMLä¸­çš„onclickå¯ä»¥è°ƒç”¨
        window.selectAllFilters = function() {
            // æ›´æ–°ä¿å­˜çš„çŠ¶æ€
            RATE_TYPES.forEach(type => {
                listFilterState[type.value] = true;
            });
            updateInfoPanel(null, 'list');
            renderRatedMarkers(); // æ›´æ–°åœ°å›¾æ ‡è®°
        };
        
        window.clearAllFilters = function() {
            // æ›´æ–°ä¿å­˜çš„çŠ¶æ€
            RATE_TYPES.forEach(type => {
                listFilterState[type.value] = false;
            });
            updateInfoPanel(null, 'list');
            renderRatedMarkers(); // æ›´æ–°åœ°å›¾æ ‡è®°
        };
        
        window.toggleFilter = function(value) {
            // åˆ‡æ¢ç­›é€‰å™¨çŠ¶æ€
            listFilterState[value] = !listFilterState[value];
            updateInfoPanel(null, 'list');
            renderRatedMarkers(); // æ›´æ–°åœ°å›¾æ ‡è®°
        };
        
        window.showRestaurantDetail = function(uid) {
            const poi = window.ratedPois.find(p => p.uid === uid);
            if (poi) {
                updateInfoPanel(poi, 'detail');
            }
        };
        
        window.clearAllRatedPois = function() {
            if (confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰è¯„åˆ†å—ï¼Ÿ')) {
                window.ratedPois = [];
                saveRatedPois();
                renderRatedMarkers();
                updateInfoPanel(null, 'list');
            }
        };
        
        // ===================== è¾…åŠ©åŠŸèƒ½ =====================
        // åœ¨æ§åˆ¶å°æŸ¥çœ‹è¯„åˆ†æ•°æ®
        window.showRatedPois = function() {
            console.log('å½“å‰è¯„åˆ†POIåˆ—è¡¨:', window.ratedPois);
            console.log('localStorageä¸­çš„è¯„åˆ†æ•°æ®:', localStorage.getItem('ratedPois'));
        };
        
        // åœ¨æ§åˆ¶å°æŸ¥çœ‹ç­›é€‰å™¨çŠ¶æ€
        window.showFilterState = function() {
            console.log('ç­›é€‰å™¨çŠ¶æ€:', listFilterState);
            console.log('å½“å‰è§†å›¾:', currentView);
            console.log('ç­›é€‰åçš„é¤å…æ•°é‡:', getFilteredRatedPois().length);
            console.log('æ€»é¤å…æ•°é‡:', window.ratedPois.length);
        };
        

        
        // æ¸…ç†localStorage
        window.clearLocalStorage = function() {
            if (confirm('ç¡®å®šè¦æ¸…ç†localStorageä¸­çš„æ‰€æœ‰æ•°æ®å—ï¼Ÿ')) {
                localStorage.clear();
                console.log('localStorageå·²æ¸…ç†');
            }
        };
        
        // ===================== é¡µé¢å…¥å£ =====================
        window.onload = function() {
            loadRatedPois();
            initMap();
            renderRatedMarkers();
            bindUIEvents();
            updateMapViewportForRatedPois();
            
            // åˆå§‹åŒ–ä¿¡æ¯é¢æ¿ï¼Œæ˜¾ç¤ºé¤å…åˆ—è¡¨
            updateInfoPanel(null, 'list');
            
            // ç¡®ä¿ä¿¡æ¯é¢æ¿é»˜è®¤å±•å¼€æ˜¾ç¤º
            document.getElementById('info-panel').classList.remove('collapsed');
            
            // åœ¨æ§åˆ¶å°æ˜¾ç¤ºè¾…åŠ©å‡½æ•°
            console.log('è¾…åŠ©å‡½æ•°å·²åŠ è½½:');
            console.log('- showRatedPois(): æŸ¥çœ‹è¯„åˆ†æ•°æ®');
            console.log('- showFilterState(): æŸ¥çœ‹ç­›é€‰å™¨çŠ¶æ€');
            console.log('- clearLocalStorage(): æ¸…ç†localStorage');
            console.log('- æŒ‰ I é”®æˆ–ç‚¹å‡»æ ‡é¢˜æ å¯åˆ‡æ¢ä¿¡æ¯é¢æ¿æ˜¾ç¤ºçŠ¶æ€');
        }
    </script>
</body>
</html> 